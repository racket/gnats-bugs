From bugs+caf_=bugs=bugs.plt-scheme.org@plt-scheme.org Wed Feb  6 10:25:34 2013
Received: from mail-oa0-f46.google.com (mail-oa0-f46.google.com [209.85.219.46])
	by champlain.ccs.neu.edu (8.14.4/8.14.4) with ESMTP id r16FPAxZ004149
	for <bugs@bugs.plt-scheme.org>; Wed, 6 Feb 2013 10:25:10 -0500
Message-Id: <201302061525.r16FP8bT004143@champlain.ccs.neu.edu>
Date: Wed, 6 Feb 2013 10:25:08 -0500
From: tobias.hammer@dlr.de
To: bugs@racket-lang.org
Subject: FFI broken for functions that return _racket from scheme_values

>Number:         13496
>Category:       all
>Synopsis:       FFI broken for functions that return _racket from scheme_values
>Class:          sw-bug
>Responsible:    mflatt
>Severity:       serious
>Priority:       medium
>State:          closed
>Confidential:   no
>Arrival-Date:   Wed Feb 06 10:28:01 -0500 2013
>Closed-Date:    Thu Feb 14 18:22:24 -0500 2013
>Last-Modified:  Thu Feb 14 18:22:24 -0500 2013
>Originator:     Tobias Hammer
>Organization:
plt
>Submitter-Id:   unknown
>Release:        5.3.2
>Environment:
unix "Linux thoosa 2.6.32.59-0.7-pae #1 SMP 2012-07-13 15:50:56 +0200 i686 i686 i386 GNU/Linux" (i386-linux/3m) (get-display-depth) = 32
Human Language: english
(current-memory-use) 303863680
Links: (links) = (); (links #:user? #f) = (); (links #:root? #t) = (); (links #:user? #f #:root? #t) = ()
Planet2 (show):
Installation-wide:
 [none]
User-specific, all-version:
 [none]
User-specific, version-specific:
 [none]



Collections:

Computer Language: (("Determine language from source") (#(#t print mixed-fraction-e #f #t debug/profile) (default) #() "#lang racket\n" #f #t ((main) (test))))
>Description:
An ffi function that returns a _racket value that is in fact multiple values raises an error (case 1.).
The error is in the wrapper function generated by the _fun constructor. Pure _cprocedure's work.

A workaround is to prevent the expansion to multiple values inside the wrapper (case 2.) and cast it afterwards. But thats rather unintuitive and tookt a while to figure it out. 

I hope this can be fixed or at least be mentioned somewhere in the docs. Thanks!
>How-To-Repeat:
;; -- 1. Error case --
(define scheme-make-fd-in+output-port
  (get-ffi-obj "scheme_make_fd_output_port" #f
               (_fun _int _string (_int = 0) (_int = 0) (_int = 1)
                     -> _racket)))

(scheme-make-fd-in+output-port 1 "name")

result arity mismatch;
 expected number of values not received
  expected: 1
  received: 2
  values...:
   #<input-port>
   #<output-port>
  context...:


;; -- 2. Workaround --
(define scheme-make-fd-in+output-port-XXX
  (get-ffi-obj "scheme_make_fd_output_port" #f
               (_fun _int _string (_int = 0) (_int = 0) (_int = 1)
                     -> _gcpointer)))

(cast (scheme-make-fd-in+output-port 1 "name") _gcpointer _racket)
>Fix:
>Audit-Trail:
From: Tobias Hammer <tobias.hammer@dlr.de>
To: <bugs@racket-lang.org>, <bug-notification@racket-lang.org>
Cc: 
Subject: Re: [racket-bug] all/13496: FFI broken for functions that return
 _racket from scheme_values
Date: Fri, 8 Feb 2013 12:09:30 +0100

 This could be a possible patch. It does not change the behavior of  
 existing code but for the case of multiple return values it returns them  
 as a list. Properly documented it should be clearly understandable.
 Is that an acceptable solution? If not i could create a new patch with the  
 desired behavior.
 
 Tobias
 
 
 ;; ---------------------
 
 diff --git a/collects/ffi/unsafe.rkt b/collects/ffi/unsafe.rkt
 index 22ada83..c81f5e0 100644
 --- a/collects/ffi/unsafe.rkt
 +++ b/collects/ffi/unsafe.rkt
 @@ -662,7 +662,12 @@
                            (let* (#,@args
                                   #,@bind
                                   #,@pre
 -                                [#,(cadr output) (ffi #,@ffi-args)]
 +                                [#,(cadr output)
 +                                 (call-with-values
 +                                   (lambda () (ffi #,@ffi-args))
 +                                   (case-lambda
 +                                     [(single) single]
 +                                     [more     more]))]
                                   #,@post)
                              #,output-expr)))]
                  ;; if there is a string 'ffi-name property, use it as a  
 name
Responsible changed from "nobody" to "mflatt" by mflatt@racket-lang.org at Thu, 14 Feb 2013 18:22:24 -0500
Reason>>> A commit by mflatt@racket-lang.org has resolved this report
  http://git.racket-lang.org/plt/commit/3cd4ee1c0d
State changed from "open" to "closed" by mflatt@racket-lang.org at Thu, 14 Feb 2013 18:22:24 -0500
Reason>>> A commit by mflatt@racket-lang.org has resolved this report
  http://git.racket-lang.org/plt/commit/3cd4ee1c0d
  | ffi/unsafe: allow multiple values for a `(_fun ... -> _racket)' result
  | 
  | Closes PR 13496

