From bugs+caf_=bugs=bugs.plt-scheme.org@plt-scheme.org Thu Sep  8 11:28:36 2016
Received: from mail-it0-f50.google.com (mail-it0-f50.google.com [209.85.214.50])
	by winooski.ccs.neu.edu (8.14.7/8.14.7) with ESMTP id u88FSWDA025660
	for <bugs@bugs.plt-scheme.org>; Thu, 8 Sep 2016 11:28:33 -0400
Message-Id: <201609081528.u88FSU4G025651@winooski.ccs.neu.edu>
Date: Thu, 8 Sep 2016 11:28:30 -0400
From: radon.neon@gmail.com
To: bugs@racket-lang.org
Subject: Racket crashes on launch with some OSX keyboard layouts

>Number:         15347
>Category:       all
>Synopsis:       Racket crashes on launch with some OSX keyboard layouts
>Class:          sw-bug
>Responsible:    nobody
>Severity:       serious
>Priority:       medium
>State:          open
>Confidential:   no
>Arrival-Date:   Thu Sep 08 11:32:01 -0400 2016
>Last-Modified:  Fri Sep 09 11:08:01 -0400 2016
>Originator:     Radon Rosborough
>Organization:
plt
>Submitter-Id:   unknown
>Release:        6.6
>Environment:
macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/RELEASE_X86_64 x86_64" (x86_64-macosx/3m) (get-display-depth) = 32
Human Language: english
(current-memory-use) 252260656
raco pkg (show):
Installation-wide:
 Package            Checksum             Source
 main-distribution  e24e5af07557ac0f...  catalog...tribution
 racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 [189 auto-installed packages not shown]
User-specific for installation "6.6":
 [none]



Collections:
("/Users/raxod502/Library/Racket/6.6/collects"
 (non-existent-path))
("/Applications/Racket v6.6/collects"
 ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info" "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "racket" "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"))

Recent Internal Errors: 
Computer Language: (("Initial language" "No language chosen") #(#t print mixed-fraction-e #f #t debug))
>Description:
I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX keyboard layout. If I am using my custom keyboard layout (but not when using the default keyboard layout), then when:

- launching the 'drracket' executable,
- opening the DrRacket application, or
- using geiser in Emacs, compiling a file with '#lang slideshow' in it,

Racket crashes immediately with the following error:

integer->char: contract violation
  expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #xDFFF)))
  given: 55357
  context...:
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:495:16: for-loop
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:552:0: for-loop
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:552:0: for-loop
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt: [running body]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/window.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/item.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/button.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/platform.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform.rkt: [running body]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [traversing imports]
   /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt: [traversing imports]
>How-To-Repeat:
I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce the problem on a virtual machine with a fresh install of El Capitan 10.11.

- Download my custom keyboard layout: https://drive.google.com/open?id=0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
- Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts".
- In System Preferences > Keyboard > Input Sources, add "My Keyboard Layout" as an input source.
- Make sure the "Show Input menu in menu bar" checkbox is checked.
- In the Input menu in the menu bar, select "My Keyboard Layout".
- Launch DrRacket. It should crash (and provide the above error message if it was launched from the command line).
>Fix:
>Audit-Trail:
From: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
To: radon.neon@gmail.com, bugs <bugs@racket-lang.org>
Cc: nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 17:43:24 +0200

 --001a11441afee41c77053c00e375
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 Did you switch to your keyboard layout before or after starting DrRacket?
 
 /Jens Axel
 
 
 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 
 > A new problem report is waiting at
 >   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >
 > Reported by Radon Rosborough for release: 6.6
 >
 > *** Description:
 > I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX keyboard
 > layout. If I am using my custom keyboard layout (but not when using the
 > default keyboard layout), then when:
 >
 > - launching the 'drracket' executable,
 > - opening the DrRacket application, or
 > - using geiser in Emacs, compiling a file with '#lang slideshow' in it,
 >
 > Racket crashes immediately with the following error:
 >
 > integer->char: contract violation
 >   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800
 > #xDFFF)))
 >   given: 55357
 >   context...:
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt:495:16:
 > for-loop
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt:552:0:
 > for-loop
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt:552:0:
 > for-loop
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt:
 > [running body]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/win=
 dow.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ite=
 m.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/but=
 ton.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/pla=
 tform.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform.=
 rkt:
 > [running body]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt:
 > [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt:
 > [traversing imports]
 >
 > *** How to repeat:
 > I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 > reproduce the problem on a virtual machine with a fresh install of El
 > Capitan 10.11.
 >
 > - Download my custom keyboard layout: https://drive.google.com/open?id=3D
 > 0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 > - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts".
 > - In System Preferences > Keyboard > Input Sources, add "My Keyboard
 > Layout" as an input source.
 > - Make sure the "Show Input menu in menu bar" checkbox is checked.
 > - In the Input menu in the menu bar, select "My Keyboard Layout".
 > - Launch DrRacket. It should crash (and provide the above error message i=
 f
 > it was launched from the command line).
 >
 > *** Environment:
 > macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel Version
 > 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/RELEASE_X86_6=
 4
 > x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 > Human Language: english
 > (current-memory-use) 252260656
 > raco pkg (show):
 > Installation-wide:
 >  Package            Checksum             Source
 >  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >  [189 auto-installed packages not shown]
 > User-specific for installation "6.6":
 >  [none]
 >
 >
 >
 > Collections:
 > ("/Users/raxod502/Library/Racket/6.6/collects"
 >  (non-existent-path))
 > ("/Applications/Racket v6.6/collects"
 >  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info" "info-domain=
 "
 > "json" "launcher" "net" "openssl" "pkg" "planet" "racket" "raco" "reader"
 > "realm" "s-exp" "setup" "syntax" "version" "xml"))
 >
 > Recent Internal Errors:
 > Computer Language: (("Initial language" "No language chosen") #(#t print
 > mixed-fraction-e #f #t debug))
 >
 >
 
 
 --=20
 --=20
 Jens Axel S=C3=B8gaard
 
 --001a11441afee41c77053c00e375
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr">Did you switch to your keyboard layout before or after sta=
 rting DrRacket?<div><br></div><div>/Jens Axel</div><div><br></div></div><di=
 v class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:32 GMT=
 +02:00  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" targe=
 t=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"g=
 mail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-l=
 eft:1ex">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/<wbr>=
 query/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/cocoa/key-<wbr>translate.rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/cocoa/key-<wbr>translate.rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/cocoa/key-<wbr>translate.rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/cocoa/key-<wbr>translate.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>mred.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>main.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/<wbr>racket/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/<wbr>drracket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D<wbr>0B4SqHuaCqyQmVGdNWVk5Q1FvV0U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/<wbr>Racket/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br>
 </blockquote></div><br><br clear=3D"all"><div><br></div>-- <br><div class=
 =3D"gmail_signature" data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=
 =C3=B8gaard<br><br></div>
 </div>
 
 --001a11441afee41c77053c00e375--
From: Radon Rosborough <radon.neon@gmail.com>
To: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 08:50:13 -0700

 --001a11418d74b02e44053c00fe33
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 Before. If I switch after I launch DrRacket, it appears to work OK,
 although I haven't tried anything substantial to make sure everything works=
 .
 
 On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard.n=
 et>
 wrote:
 
 > Did you switch to your keyboard layout before or after starting DrRacket?
 >
 > /Jens Axel
 >
 >
 > 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >
 >> A new problem report is waiting at
 >>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>
 >> Reported by Radon Rosborough for release: 6.6
 >>
 >> *** Description:
 >> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX keyboard
 >> layout. If I am using my custom keyboard layout (but not when using the
 >> default keyboard layout), then when:
 >>
 >> - launching the 'drracket' executable,
 >> - opening the DrRacket application, or
 >> - using geiser in Emacs, compiling a file with '#lang slideshow' in it,
 >>
 >> Racket crashes immediately with the following error:
 >>
 >> integer->char: contract violation
 >>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800
 >> #xDFFF)))
 >>   given: 55357
 >>   context...:
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/wi=
 ndow.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/it=
 em.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/bu=
 tton.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/pl=
 atform.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform=
 .rkt:
 >> [running body]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt:
 >> [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt:
 >> [traversing imports]
 >>
 >> *** How to repeat:
 >> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 >> reproduce the problem on a virtual machine with a fresh install of El
 >> Capitan 10.11.
 >>
 >> - Download my custom keyboard layout: https://drive.google.com/open?
 >> id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts".
 >> - In System Preferences > Keyboard > Input Sources, add "My Keyboard
 >> Layout" as an input source.
 >> - Make sure the "Show Input menu in menu bar" checkbox is checked.
 >> - In the Input menu in the menu bar, select "My Keyboard Layout".
 >> - Launch DrRacket. It should crash (and provide the above error message
 >> if it was launched from the command line).
 >>
 >> *** Environment:
 >> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel Version
 >> 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/RELEASE_X86_=
 64
 >> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >> Human Language: english
 >> (current-memory-use) 252260656
 >> raco pkg (show):
 >> Installation-wide:
 >>  Package            Checksum             Source
 >>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>  [189 auto-installed packages not shown]
 >> User-specific for installation "6.6":
 >>  [none]
 >>
 >>
 >>
 >> Collections:
 >> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>  (non-existent-path))
 >> ("/Applications/Racket v6.6/collects"
 >>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "racket"
 >> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"))
 >>
 >> Recent Internal Errors:
 >> Computer Language: (("Initial language" "No language chosen") #(#t print
 >> mixed-fraction-e #f #t debug))
 >>
 >>
 >
 >
 > --
 > --
 > Jens Axel S=C3=B8gaard
 >
 >
 
 --001a11418d74b02e44053c00fe33
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr">Before. If I switch after I launch DrRacket, it appears to=
  work OK, although I haven&#39;t tried anything substantial to make sure ev=
 erything works.</div><div class=3D"gmail_extra"><br><div class=3D"gmail_quo=
 te">On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr=
 ">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@s=
 oegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" styl=
 e=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div di=
 r=3D"ltr">Did you switch to your keyboard layout before or after starting D=
 rRacket?<div><br></div><div>/Jens Axel</div><div><br></div></div><div class=
 =3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:32 GMT+02:00 =
  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_b=
 lank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_qu=
 ote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex=
 ">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span class=3D"HOEnZb"><font color=3D"#888888">
 </font></span></blockquote></div><span class=3D"HOEnZb"><font color=3D"#888=
 888"><br><br clear=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gma=
 il_signature">-- <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 
 --001a11418d74b02e44053c00fe33--
From: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
To: Radon Rosborough <radon.neon@gmail.com>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 18:03:39 +0200

 --94eb2c05c364594a00053c012c5f
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 Here is what I have so far:
 
 1) integer->char is being called with an input that aren't accepted
 2) the caller is key-translate a low level function whose job
     is to translate (physical) keycodes into characters using
     a keyboard layout.
 3) it is a bug in key-translate that integer->char is called with
     an integer that doesn't correspond to a character
 
 4) From
           integer->char: contract violation
           expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 #xD800 #xDFFF)))
           given: 55357
     we learn that the operating system translated a keycode to the
 codepoint 55357.
     That code point lies in the range D800 to DFFF which are not accepted b=
 y
     integer->char
 5) That range is called "High Surrogates"
     From http://www.alanwood.net/unicode/high_surrogates.html
 
 Surrogate code points are intended to allow mapping of additional character
 planes into the 16-bit Unicode system, thus allowing more than 65,536
 characters to be represented. The individual surrogate code points do not
 represent characters; they are intended to be used in pairs, a high code
 point followed by a low code point, to stand in for a character in one of
 the supplementary planes. Their use is restricted to UTF-16. They can be
 used for characters in Linear B Syllabary
 <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 higher-numbered ranges.
 
 
 Is it intentionally that your layout produces such code points?
 
 /Jens Axel
 
 
 
 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 
 > Before. If I switch after I launch DrRacket, it appears to work OK,
 > although I haven't tried anything substantial to make sure everything wor=
 ks.
 >
 > On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard=
 .net>
 > wrote:
 >
 >> Did you switch to your keyboard layout before or after starting DrRacket=
 ?
 >>
 >> /Jens Axel
 >>
 >>
 >> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>
 >>> A new problem report is waiting at
 >>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>
 >>> Reported by Radon Rosborough for release: 6.6
 >>>
 >>> *** Description:
 >>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX keyboard
 >>> layout. If I am using my custom keyboard layout (but not when using the
 >>> default keyboard layout), then when:
 >>>
 >>> - launching the 'drracket' executable,
 >>> - opening the DrRacket application, or
 >>> - using geiser in Emacs, compiling a file with '#lang slideshow' in it,
 >>>
 >>> Racket crashes immediately with the following error:
 >>>
 >>> integer->char: contract violation
 >>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800
 >>> #xDFFF)))
 >>>   given: 55357
 >>>   context...:
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/w=
 indow.rkt:
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/i=
 tem.rkt:
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/b=
 utton.rkt:
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/p=
 latform.rkt:
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platfor=
 m.rkt:
 >>> [running body]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt=
 :
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt:
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt:
 >>> [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt:
 >>> [traversing imports]
 >>>
 >>> *** How to repeat:
 >>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 >>> reproduce the problem on a virtual machine with a fresh install of El
 >>> Capitan 10.11.
 >>>
 >>> - Download my custom keyboard layout: https://drive.google.com/open?
 >>> id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts".
 >>> - In System Preferences > Keyboard > Input Sources, add "My Keyboard
 >>> Layout" as an input source.
 >>> - Make sure the "Show Input menu in menu bar" checkbox is checked.
 >>> - In the Input menu in the menu bar, select "My Keyboard Layout".
 >>> - Launch DrRacket. It should crash (and provide the above error message
 >>> if it was launched from the command line).
 >>>
 >>> *** Environment:
 >>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel Version
 >>> 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/RELEASE_X86=
 _64
 >>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>> Human Language: english
 >>> (current-memory-use) 252260656
 >>> raco pkg (show):
 >>> Installation-wide:
 >>>  Package            Checksum             Source
 >>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>  [189 auto-installed packages not shown]
 >>> User-specific for installation "6.6":
 >>>  [none]
 >>>
 >>>
 >>>
 >>> Collections:
 >>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>  (non-existent-path))
 >>> ("/Applications/Racket v6.6/collects"
 >>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "racket"
 >>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"))
 >>>
 >>> Recent Internal Errors:
 >>> Computer Language: (("Initial language" "No language chosen") #(#t prin=
 t
 >>> mixed-fraction-e #f #t debug))
 >>>
 >>>
 >>
 >>
 >> --
 >> --
 >> Jens Axel S=C3=B8gaard
 >>
 >>
 >
 
 
 --=20
 --=20
 Jens Axel S=C3=B8gaard
 
 --94eb2c05c364594a00053c012c5f
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr"><span style=3D"font-size:12.8px">Here is what I have so fa=
 r:</span><div><span style=3D"font-size:12.8px"><br></span></div><div>1) int=
 eger-&gt;char is being called with an input that aren&#39;t accepted</div><=
 div>2) the caller is=C2=A0<span style=3D"color:rgb(51,51,51);font-family:co=
 nsolas,&quot;liberation mono&quot;,menlo,courier,monospace;font-size:12px;l=
 ine-height:20px;white-space:pre">key-translate </span>a low level function =
 whose job</div><div>=C2=A0 =C2=A0 is to translate (physical) keycodes into =
 characters using=C2=A0</div><div>=C2=A0 =C2=A0 a keyboard layout.=C2=A0</di=
 v><div>3) it is a bug in key-translate that integer-&gt;char is called with=
 </div><div>=C2=A0 =C2=A0 an integer that doesn&#39;t correspond to a charac=
 ter</div><div><br></div><div>4) From=C2=A0</div><div><span style=3D"font-si=
 ze:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 integer-&gt;char: contract vi=
 olation</span><br style=3D"font-size:12.8px"><span style=3D"font-size:12.8p=
 x">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 expected: (and/c (integer-in 0 #x10FF=
 FF) (not/c (integer-in #xD800 #xDFFF)))</span><br style=3D"font-size:12.8px=
 "><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 given=
 : 55357<br></span>=C2=A0 =C2=A0 we learn that the operating system translat=
 ed a keycode to the codepoint=C2=A0<span style=3D"font-size:12.8px">55357.<=
 /span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 That code p=
 oint lies in the range D800 to DFFF which are not accepted by</span></div><=
 div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 integer-&gt;char</span><=
 /div><div><span style=3D"font-size:12.8px">5) That range is called &quot;Hi=
 gh Surrogates&quot;=C2=A0</span></div><div><span style=3D"font-size:12.8px"=
 >=C2=A0 =C2=A0 From=C2=A0</span><span style=3D"font-size:12.8px"><a href=3D=
 "http://www.alanwood.net/unicode/high_surrogates.html">http://www.alanwood.=
 net/unicode/high_surrogates.html</a><br></span><span style=3D"font-size:12.=
 8px"><br></span><span style=3D"color:rgb(0,0,0);font-family:times;font-size=
 :16px;line-height:19.2px;background-color:rgb(255,255,242)">Surrogate code =
 points are intended to allow mapping of additional character planes into th=
 e 16-bit Unicode system, thus allowing more than 65,536 characters to be re=
 presented. The individual surrogate code points do not represent characters=
 ; they are intended to be used in pairs, a high code point followed by a lo=
 w code point, to stand in for a character in one of the supplementary plane=
 s. Their use is restricted to UTF-16. They can be used for characters in=C2=
 =A0</span><a href=3D"http://www.alanwood.net/unicode/linear_b_syllabary.htm=
 l" style=3D"color:rgb(128,0,128);font-family:times;font-size:16px;line-heig=
 ht:19.2px;background-color:rgb(255,255,242)">Linear B Syllabary</a><span st=
 yle=3D"color:rgb(0,0,0);font-family:times;font-size:16px;line-height:19.2px=
 ;background-color:rgb(255,255,242)">=C2=A0and higher-numbered ranges.<br></=
 span></div><div><span style=3D"font-size:12.8px"><br></span></div><div><br>=
 </div><div>Is it intentionally that your layout produces such code points?<=
 /div><div><br></div><div>/Jens Axel</div><div><br></div><div><br></div></di=
 v><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:5=
 0 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.=
 neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><=
 blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px=
  #ccc solid;padding-left:1ex"><div dir=3D"ltr">Before. If I switch after I =
 launch DrRacket, it appears to work OK, although I haven&#39;t tried anythi=
 ng substantial to make sure everything works.</div><div class=3D"HOEnZb"><d=
 iv class=3D"h5"><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">O=
 n Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt=
 ;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@soegaa=
 rd.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"=
 margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"=
 ltr">Did you switch to your keyboard layout before or after starting DrRack=
 et?<div><br></div><div>/Jens Axel</div><div><br></div></div><div class=3D"g=
 mail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:32 GMT+02:00  <spa=
 n dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank"=
 >radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" =
 style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">A n=
 ew problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div class=3D"gmail_signature" data-smartmail=3D"gmail_signature">-- <br>Je=
 ns Axel S=C3=B8gaard<br><br></div>
 </div>
 
 --94eb2c05c364594a00053c012c5f--
From: Radon Rosborough <radon.neon@gmail.com>
To: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 09:11:37 -0700

 --001a1140754c32d68d053c014ba1
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 It's not intentionally. Perhaps they are an artifact created by Ukelele. Is
 there an easy way to determine which key is producing the surrogate code
 point(s)?
 
 The first thing I think of is the dead keys used for creating accents in OS
 X, but these are also present in the default keyboard layout. The only
 thing I have done with them is move the Alt+E dead key to Alt+Shift+`.
 
 On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard.n=
 et>
 wrote:
 
 > Here is what I have so far:
 >
 > 1) integer->char is being called with an input that aren't accepted
 > 2) the caller is key-translate a low level function whose job
 >     is to translate (physical) keycodes into characters using
 >     a keyboard layout.
 > 3) it is a bug in key-translate that integer->char is called with
 >     an integer that doesn't correspond to a character
 >
 > 4) From
 >           integer->char: contract violation
 >           expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 > #xD800 #xDFFF)))
 >           given: 55357
 >     we learn that the operating system translated a keycode to the
 > codepoint 55357.
 >     That code point lies in the range D800 to DFFF which are not accepted
 > by
 >     integer->char
 > 5) That range is called "High Surrogates"
 >     From http://www.alanwood.net/unicode/high_surrogates.html
 >
 > Surrogate code points are intended to allow mapping of additional
 > character planes into the 16-bit Unicode system, thus allowing more than
 > 65,536 characters to be represented. The individual surrogate code points
 > do not represent characters; they are intended to be used in pairs, a hig=
 h
 > code point followed by a low code point, to stand in for a character in o=
 ne
 > of the supplementary planes. Their use is restricted to UTF-16. They can =
 be
 > used for characters in Linear B Syllabary
 > <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 > higher-numbered ranges.
 >
 >
 > Is it intentionally that your layout produces such code points?
 >
 > /Jens Axel
 >
 >
 >
 > 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >
 >> Before. If I switch after I launch DrRacket, it appears to work OK,
 >> although I haven't tried anything substantial to make sure everything wo=
 rks.
 >>
 >> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaar=
 d.net>
 >> wrote:
 >>
 >>> Did you switch to your keyboard layout before or after starting DrRacke=
 t?
 >>>
 >>> /Jens Axel
 >>>
 >>>
 >>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>
 >>>> A new problem report is waiting at
 >>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>
 >>>> Reported by Radon Rosborough for release: 6.6
 >>>>
 >>>> *** Description:
 >>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>> keyboard layout. If I am using my custom keyboard layout (but not when
 >>>> using the default keyboard layout), then when:
 >>>>
 >>>> - launching the 'drracket' executable,
 >>>> - opening the DrRacket application, or
 >>>> - using geiser in Emacs, compiling a file with '#lang slideshow' in it=
 ,
 >>>>
 >>>> Racket crashes immediately with the following error:
 >>>>
 >>>> integer->char: contract violation
 >>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800
 >>>> #xDFFF)))
 >>>>   given: 55357
 >>>>   context...:
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 window.rkt:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 item.rkt:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 button.rkt:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 platform.rkt:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platfo=
 rm.rkt:
 >>>> [running body]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rk=
 t:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt:
 >>>> [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt=
 :
 >>>> [traversing imports]
 >>>>
 >>>> *** How to repeat:
 >>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 >>>> reproduce the problem on a virtual machine with a fresh install of El
 >>>> Capitan 10.11.
 >>>>
 >>>> - Download my custom keyboard layout: https://drive.google.com/open?
 >>>> id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts".
 >>>> - In System Preferences > Keyboard > Input Sources, add "My Keyboard
 >>>> Layout" as an input source.
 >>>> - Make sure the "Show Input menu in menu bar" checkbox is checked.
 >>>> - In the Input menu in the menu bar, select "My Keyboard Layout".
 >>>> - Launch DrRacket. It should crash (and provide the above error messag=
 e
 >>>> if it was launched from the command line).
 >>>>
 >>>> *** Environment:
 >>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel
 >>>> Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/RE=
 LEASE_X86_64
 >>>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>> Human Language: english
 >>>> (current-memory-use) 252260656
 >>>> raco pkg (show):
 >>>> Installation-wide:
 >>>>  Package            Checksum             Source
 >>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>  [189 auto-installed packages not shown]
 >>>> User-specific for installation "6.6":
 >>>>  [none]
 >>>>
 >>>>
 >>>>
 >>>> Collections:
 >>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>  (non-existent-path))
 >>>> ("/Applications/Racket v6.6/collects"
 >>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "racket=
 "
 >>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"))
 >>>>
 >>>> Recent Internal Errors:
 >>>> Computer Language: (("Initial language" "No language chosen") #(#t
 >>>> print mixed-fraction-e #f #t debug))
 >>>>
 >>>>
 >>>
 >>>
 >>> --
 >>> --
 >>> Jens Axel S=C3=B8gaard
 >>>
 >>>
 >>
 >
 >
 > --
 > --
 > Jens Axel S=C3=B8gaard
 >
 >
 
 --001a1140754c32d68d053c014ba1
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr">It&#39;s not intentionally. Perhaps they are an artifact c=
 reated by Ukelele. Is there an easy way to determine which key is producing=
  the surrogate code point(s)?<div><br></div><div>The first thing I think of=
  is the dead keys used for creating accents in OS X, but these are also pre=
 sent in the default keyboard layout. The only thing I have done with them i=
 s move the Alt+E dead key to Alt+Shift+`.</div></div><div class=3D"gmail_ex=
 tra"><br><div class=3D"gmail_quote">On Thu, Sep 8, 2016 at 9:03 AM, Jens Ax=
 el S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.n=
 et" target=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><block=
 quote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc=
  solid;padding-left:1ex"><div dir=3D"ltr"><span style=3D"font-size:12.8px">=
 Here is what I have so far:</span><div><span style=3D"font-size:12.8px"><br=
 ></span></div><div>1) integer-&gt;char is being called with an input that a=
 ren&#39;t accepted</div><div>2) the caller is=C2=A0<span style=3D"color:rgb=
 (51,51,51);font-family:consolas,&quot;liberation mono&quot;,menlo,courier,m=
 onospace;font-size:12px;line-height:20px;white-space:pre-wrap">key-translat=
 e </span>a low level function whose job</div><div>=C2=A0 =C2=A0 is to trans=
 late (physical) keycodes into characters using=C2=A0</div><div>=C2=A0 =C2=
 =A0 a keyboard layout.=C2=A0</div><div>3) it is a bug in key-translate that=
  integer-&gt;char is called with</div><div>=C2=A0 =C2=A0 an integer that do=
 esn&#39;t correspond to a character</div><div><br></div><div>4) From=C2=A0<=
 /div><div><span class=3D""><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 integer-&gt;char: contract violation</span><br style=
 =3D"font-size:12.8px"><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0=
  =C2=A0 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in =
 #xD800 #xDFFF)))</span><br style=3D"font-size:12.8px"><span style=3D"font-s=
 ize:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 given: 55357<br></span></spa=
 n>=C2=A0 =C2=A0 we learn that the operating system translated a keycode to =
 the codepoint=C2=A0<span style=3D"font-size:12.8px">55357.</span></div><div=
 ><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 That code point lies in the=
  range D800 to DFFF which are not accepted by</span></div><div><span style=
 =3D"font-size:12.8px">=C2=A0 =C2=A0 integer-&gt;char</span></div><div><span=
  style=3D"font-size:12.8px">5) That range is called &quot;High Surrogates&q=
 uot;=C2=A0</span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =
 From=C2=A0</span><span style=3D"font-size:12.8px"><a href=3D"http://www.ala=
 nwood.net/unicode/high_surrogates.html" target=3D"_blank">http://www.alanwo=
 od.net/<wbr>unicode/high_surrogates.html</a><br></span><span style=3D"font-=
 size:12.8px"><br></span><span style=3D"color:rgb(0,0,0);font-family:times;f=
 ont-size:16px;line-height:19.2px;background-color:rgb(255,255,242)">Surroga=
 te code points are intended to allow mapping of additional character planes=
  into the 16-bit Unicode system, thus allowing more than 65,536 characters =
 to be represented. The individual surrogate code points do not represent ch=
 aracters; they are intended to be used in pairs, a high code point followed=
  by a low code point, to stand in for a character in one of the supplementa=
 ry planes. Their use is restricted to UTF-16. They can be used for characte=
 rs in=C2=A0</span><a href=3D"http://www.alanwood.net/unicode/linear_b_sylla=
 bary.html" style=3D"color:rgb(128,0,128);font-family:times;font-size:16px;l=
 ine-height:19.2px;background-color:rgb(255,255,242)" target=3D"_blank">Line=
 ar B Syllabary</a><span style=3D"color:rgb(0,0,0);font-family:times;font-si=
 ze:16px;line-height:19.2px;background-color:rgb(255,255,242)">=C2=A0and hig=
 her-numbered ranges.<br></span></div><div><span style=3D"font-size:12.8px">=
 <br></span></div><div><br></div><div>Is it intentionally that your layout p=
 roduces such code points?</div><span class=3D"HOEnZb"><font color=3D"#88888=
 8"><div><br></div><div>/Jens Axel</div><div><br></div><div><br></div></font=
 ></span></div><div class=3D"HOEnZb"><div class=3D"h5"><div class=3D"gmail_e=
 xtra"><br><div class=3D"gmail_quote">2016-09-08 17:50 GMT+02:00 Radon Rosbo=
 rough <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=
 =3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gm=
 ail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-le=
 ft:1ex"><div dir=3D"ltr">Before. If I switch after I launch DrRacket, it ap=
 pears to work OK, although I haven&#39;t tried anything substantial to make=
  sure everything works.</div><div><div><div class=3D"gmail_extra"><br><div =
 class=3D"gmail_quote">On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaar=
 d <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"=
 _blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D=
 "gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding=
 -left:1ex"><div dir=3D"ltr">Did you switch to your keyboard layout before o=
 r after starting DrRacket?<div><br></div><div>/Jens Axel</div><div><br></di=
 v></div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-0=
 8 17:32 GMT+02:00  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail=
 .com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote=
  class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc soli=
 d;padding-left:1ex">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 
 --001a1140754c32d68d053c014ba1--
From: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
To: Radon Rosborough <radon.neon@gmail.com>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 18:17:58 +0200

 --001a11441afe8ac8f1053c015f07
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 That sounds as something that should work.
 As far as I know key-translate is only called when you actually press a key=
 .
 So I am surprised that you see the error when DrRacket starts.
 
 I'll need to look up Ukelele.
 
 /Jens Axel
 
 
 
 2016-09-08 18:11 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 
 > It's not intentionally. Perhaps they are an artifact created by Ukelele.
 > Is there an easy way to determine which key is producing the surrogate co=
 de
 > point(s)?
 >
 > The first thing I think of is the dead keys used for creating accents in
 > OS X, but these are also present in the default keyboard layout. The only
 > thing I have done with them is move the Alt+E dead key to Alt+Shift+`.
 >
 > On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard=
 .net>
 > wrote:
 >
 >> Here is what I have so far:
 >>
 >> 1) integer->char is being called with an input that aren't accepted
 >> 2) the caller is key-translate a low level function whose job
 >>     is to translate (physical) keycodes into characters using
 >>     a keyboard layout.
 >> 3) it is a bug in key-translate that integer->char is called with
 >>     an integer that doesn't correspond to a character
 >>
 >> 4) From
 >>           integer->char: contract violation
 >>           expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >> #xD800 #xDFFF)))
 >>           given: 55357
 >>     we learn that the operating system translated a keycode to the
 >> codepoint 55357.
 >>     That code point lies in the range D800 to DFFF which are not accepte=
 d
 >> by
 >>     integer->char
 >> 5) That range is called "High Surrogates"
 >>     From http://www.alanwood.net/unicode/high_surrogates.html
 >>
 >> Surrogate code points are intended to allow mapping of additional
 >> character planes into the 16-bit Unicode system, thus allowing more than
 >> 65,536 characters to be represented. The individual surrogate code point=
 s
 >> do not represent characters; they are intended to be used in pairs, a hi=
 gh
 >> code point followed by a low code point, to stand in for a character in =
 one
 >> of the supplementary planes. Their use is restricted to UTF-16. They can=
  be
 >> used for characters in Linear B Syllabary
 >> <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 >> higher-numbered ranges.
 >>
 >>
 >> Is it intentionally that your layout produces such code points?
 >>
 >> /Jens Axel
 >>
 >>
 >>
 >> 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>
 >>> Before. If I switch after I launch DrRacket, it appears to work OK,
 >>> although I haven't tried anything substantial to make sure everything w=
 orks.
 >>>
 >>> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaa=
 rd.net
 >>> > wrote:
 >>>
 >>>> Did you switch to your keyboard layout before or after starting
 >>>> DrRacket?
 >>>>
 >>>> /Jens Axel
 >>>>
 >>>>
 >>>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>>
 >>>>> A new problem report is waiting at
 >>>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>>
 >>>>> Reported by Radon Rosborough for release: 6.6
 >>>>>
 >>>>> *** Description:
 >>>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>>> keyboard layout. If I am using my custom keyboard layout (but not whe=
 n
 >>>>> using the default keyboard layout), then when:
 >>>>>
 >>>>> - launching the 'drracket' executable,
 >>>>> - opening the DrRacket application, or
 >>>>> - using geiser in Emacs, compiling a file with '#lang slideshow' in i=
 t,
 >>>>>
 >>>>> Racket crashes immediately with the following error:
 >>>>>
 >>>>> integer->char: contract violation
 >>>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800
 >>>>> #xDFFF)))
 >>>>>   given: 55357
 >>>>>   context...:
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa=
 /window.rkt:
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa=
 /item.rkt:
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa=
 /button.rkt:
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa=
 /platform.rkt:
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platf=
 orm.rkt:
 >>>>> [running body]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.r=
 kt:
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt=
 :
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt:
 >>>>> [traversing imports]
 >>>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rk=
 t:
 >>>>> [traversing imports]
 >>>>>
 >>>>> *** How to repeat:
 >>>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 >>>>> reproduce the problem on a virtual machine with a fresh install of El
 >>>>> Capitan 10.11.
 >>>>>
 >>>>> - Download my custom keyboard layout: https://drive.google.com/open?
 >>>>> id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts".
 >>>>> - In System Preferences > Keyboard > Input Sources, add "My Keyboard
 >>>>> Layout" as an input source.
 >>>>> - Make sure the "Show Input menu in menu bar" checkbox is checked.
 >>>>> - In the Input menu in the menu bar, select "My Keyboard Layout".
 >>>>> - Launch DrRacket. It should crash (and provide the above error
 >>>>> message if it was launched from the command line).
 >>>>>
 >>>>> *** Environment:
 >>>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel
 >>>>> Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/R=
 ELEASE_X86_64
 >>>>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>>> Human Language: english
 >>>>> (current-memory-use) 252260656
 >>>>> raco pkg (show):
 >>>>> Installation-wide:
 >>>>>  Package            Checksum             Source
 >>>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>>  [189 auto-installed packages not shown]
 >>>>> User-specific for installation "6.6":
 >>>>>  [none]
 >>>>>
 >>>>>
 >>>>>
 >>>>> Collections:
 >>>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>>  (non-existent-path))
 >>>>> ("/Applications/Racket v6.6/collects"
 >>>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "racke=
 t"
 >>>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"))
 >>>>>
 >>>>> Recent Internal Errors:
 >>>>> Computer Language: (("Initial language" "No language chosen") #(#t
 >>>>> print mixed-fraction-e #f #t debug))
 >>>>>
 >>>>>
 >>>>
 >>>>
 >>>> --
 >>>> --
 >>>> Jens Axel S=C3=B8gaard
 >>>>
 >>>>
 >>>
 >>
 >>
 >> --
 >> --
 >> Jens Axel S=C3=B8gaard
 >>
 >>
 >
 
 
 --=20
 --=20
 Jens Axel S=C3=B8gaard
 
 --001a11441afe8ac8f1053c015f07
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr"><div>That sounds as something that should work.</div>As fa=
 r as I know=C2=A0key-translate is only called when you actually press a key=
 .<br>So I am surprised that you see the error when DrRacket starts.<br><br>=
 I&#39;ll need to look up Ukelele.<br><br>/Jens Axel<br><div><div><br></div>=
 <div><br></div></div></div><div class=3D"gmail_extra"><br><div class=3D"gma=
 il_quote">2016-09-08 18:11 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt=
 ;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.neon@gmail=
 .com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D"margin:0=
  0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">It&=
 #39;s not intentionally. Perhaps they are an artifact created by Ukelele. I=
 s there an easy way to determine which key is producing the surrogate code =
 point(s)?<div><br></div><div>The first thing I think of is the dead keys us=
 ed for creating accents in OS X, but these are also present in the default =
 keyboard layout. The only thing I have done with them is move the Alt+E dea=
 d key to Alt+Shift+`.</div></div><div class=3D"HOEnZb"><div class=3D"h5"><d=
 iv class=3D"gmail_extra"><br><div class=3D"gmail_quote">On Thu, Sep 8, 2016=
  at 9:03 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto=
 :jensaxel@soegaard.net" target=3D"_blank">jensaxel@soegaard.net</a>&gt;</sp=
 an> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;=
 border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr"><span style=
 =3D"font-size:12.8px">Here is what I have so far:</span><div><span style=3D=
 "font-size:12.8px"><br></span></div><div>1) integer-&gt;char is being calle=
 d with an input that aren&#39;t accepted</div><div>2) the caller is=C2=A0<s=
 pan style=3D"color:rgb(51,51,51);font-family:consolas,&quot;liberation mono=
 &quot;,menlo,courier,monospace;font-size:12px;line-height:20px;white-space:=
 pre-wrap">key-translate </span>a low level function whose job</div><div>=C2=
 =A0 =C2=A0 is to translate (physical) keycodes into characters using=C2=A0<=
 /div><div>=C2=A0 =C2=A0 a keyboard layout.=C2=A0</div><div>3) it is a bug i=
 n key-translate that integer-&gt;char is called with</div><div>=C2=A0 =C2=
 =A0 an integer that doesn&#39;t correspond to a character</div><div><br></d=
 iv><div>4) From=C2=A0</div><div><span><span style=3D"font-size:12.8px">=C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 integer-&gt;char: contract violation</span>=
 <br style=3D"font-size:12.8px"><span style=3D"font-size:12.8px">=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (i=
 nteger-in #xD800 #xDFFF)))</span><br style=3D"font-size:12.8px"><span style=
 =3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 given: 55357<br></=
 span></span>=C2=A0 =C2=A0 we learn that the operating system translated a k=
 eycode to the codepoint=C2=A0<span style=3D"font-size:12.8px">55357.</span>=
 </div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 That code point l=
 ies in the range D800 to DFFF which are not accepted by</span></div><div><s=
 pan style=3D"font-size:12.8px">=C2=A0 =C2=A0 integer-&gt;char</span></div><=
 div><span style=3D"font-size:12.8px">5) That range is called &quot;High Sur=
 rogates&quot;=C2=A0</span></div><div><span style=3D"font-size:12.8px">=C2=
 =A0 =C2=A0 From=C2=A0</span><span style=3D"font-size:12.8px"><a href=3D"htt=
 p://www.alanwood.net/unicode/high_surrogates.html" target=3D"_blank">http:/=
 /www.alanwood.net/u<wbr>nicode/high_surrogates.html</a><br></span><span sty=
 le=3D"font-size:12.8px"><br></span><span style=3D"color:rgb(0,0,0);font-fam=
 ily:times;font-size:16px;line-height:19.2px;background-color:rgb(255,255,24=
 2)">Surrogate code points are intended to allow mapping of additional chara=
 cter planes into the 16-bit Unicode system, thus allowing more than 65,536 =
 characters to be represented. The individual surrogate code points do not r=
 epresent characters; they are intended to be used in pairs, a high code poi=
 nt followed by a low code point, to stand in for a character in one of the =
 supplementary planes. Their use is restricted to UTF-16. They can be used f=
 or characters in=C2=A0</span><a href=3D"http://www.alanwood.net/unicode/lin=
 ear_b_syllabary.html" style=3D"color:rgb(128,0,128);font-family:times;font-=
 size:16px;line-height:19.2px;background-color:rgb(255,255,242)" target=3D"_=
 blank">Linear B Syllabary</a><span style=3D"color:rgb(0,0,0);font-family:ti=
 mes;font-size:16px;line-height:19.2px;background-color:rgb(255,255,242)">=
 =C2=A0and higher-numbered ranges.<br></span></div><div><span style=3D"font-=
 size:12.8px"><br></span></div><div><br></div><div>Is it intentionally that =
 your layout produces such code points?</div><span><font color=3D"#888888"><=
 div><br></div><div>/Jens Axel</div><div><br></div><div><br></div></font></s=
 pan></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quot=
 e">2016-09-08 17:50 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a hre=
 f=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a=
 >&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8=
 ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">Before. If=
  I switch after I launch DrRacket, it appears to work OK, although I haven&=
 #39;t tried anything substantial to make sure everything works.</div><div><=
 div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">On Thu, Sep 8=
 , 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"=
 mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@soegaard.net</a>&g=
 t;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0=
  .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">Did you=
  switch to your keyboard layout before or after starting DrRacket?<div><br>=
 </div><div>/Jens Axel</div><div><br></div></div><div class=3D"gmail_extra">=
 <br><div class=3D"gmail_quote">2016-09-08 17:32 GMT+02:00  <span dir=3D"ltr=
 ">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.neon@=
 gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D"mar=
 gin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">A new problem r=
 eport is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div class=3D"gmail_signature" data-smartmail=3D"gmail_signature">-- <br>Je=
 ns Axel S=C3=B8gaard<br><br></div>
 </div>
 
 --001a11441afe8ac8f1053c015f07--
From: Radon Rosborough <radon.neon@gmail.com>
To: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 09:23:40 -0700

 --001a11418d74557f92053c017645
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 It looks to me like the reason for this is that the gui-lib package (loaded
 for anything graphical, I presume, including launching DrRacket) fills out
 a hash table for keyboard mappings eagerly (on package load). The following
 is from line 551 of /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 
 ;; fill in hash tables
 (for* ([modsyms all-modifier-combinations]
 ; go through all physical key
        [(kvc n) virtual-key-code-name-to-value-ht])
 ; and modifier combinations
   (define modks (modifier-symbol-list->integer modsyms))
   (define s (key-translate n #:modifier-key-state modks))
 ; translate to a char
   (unless (string=3D? s "")
 ; unless key is dead
     (define c (string-ref s 0))
     (hash-set-new! char-to-osx-keycode+modifiers-ht c
 ; store where char is from
                    (list kvc n modsyms modks))
 ; (simplest is kept)
     (cond
       [(null? modsyms)                                               ;
 also, if it is a main char
        (hash-set! char-to-main-char-key-ht c c)
 ;   store it as such
        (hash-set! osx-keycode-to-main-char-key-ht n c)]               ;
       [else
        (define mck (hash-ref osx-keycode-to-main-char-key-ht n #f))
 ; otherwise find
        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))
 ;   and store main char key
 
 =E2=80=8B
 
 On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard.n=
 et>
 wrote:
 
 > That sounds as something that should work.
 > As far as I know key-translate is only called when you actually press a
 > key.
 > So I am surprised that you see the error when DrRacket starts.
 >
 > I'll need to look up Ukelele.
 >
 > /Jens Axel
 >
 >
 >
 > 2016-09-08 18:11 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >
 >> It's not intentionally. Perhaps they are an artifact created by Ukelele.
 >> Is there an easy way to determine which key is producing the surrogate c=
 ode
 >> point(s)?
 >>
 >> The first thing I think of is the dead keys used for creating accents in
 >> OS X, but these are also present in the default keyboard layout. The onl=
 y
 >> thing I have done with them is move the Alt+E dead key to Alt+Shift+`.
 >>
 >> On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaar=
 d.net>
 >> wrote:
 >>
 >>> Here is what I have so far:
 >>>
 >>> 1) integer->char is being called with an input that aren't accepted
 >>> 2) the caller is key-translate a low level function whose job
 >>>     is to translate (physical) keycodes into characters using
 >>>     a keyboard layout.
 >>> 3) it is a bug in key-translate that integer->char is called with
 >>>     an integer that doesn't correspond to a character
 >>>
 >>> 4) From
 >>>           integer->char: contract violation
 >>>           expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >>> #xD800 #xDFFF)))
 >>>           given: 55357
 >>>     we learn that the operating system translated a keycode to the
 >>> codepoint 55357.
 >>>     That code point lies in the range D800 to DFFF which are not
 >>> accepted by
 >>>     integer->char
 >>> 5) That range is called "High Surrogates"
 >>>     From http://www.alanwood.net/unicode/high_surrogates.html
 >>>
 >>> Surrogate code points are intended to allow mapping of additional
 >>> character planes into the 16-bit Unicode system, thus allowing more tha=
 n
 >>> 65,536 characters to be represented. The individual surrogate code poin=
 ts
 >>> do not represent characters; they are intended to be used in pairs, a h=
 igh
 >>> code point followed by a low code point, to stand in for a character in=
  one
 >>> of the supplementary planes. Their use is restricted to UTF-16. They ca=
 n be
 >>> used for characters in Linear B Syllabary
 >>> <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 >>> higher-numbered ranges.
 >>>
 >>>
 >>> Is it intentionally that your layout produces such code points?
 >>>
 >>> /Jens Axel
 >>>
 >>>
 >>>
 >>> 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>
 >>>> Before. If I switch after I launch DrRacket, it appears to work OK,
 >>>> although I haven't tried anything substantial to make sure everything =
 works.
 >>>>
 >>>> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <
 >>>> jensaxel@soegaard.net> wrote:
 >>>>
 >>>>> Did you switch to your keyboard layout before or after starting
 >>>>> DrRacket?
 >>>>>
 >>>>> /Jens Axel
 >>>>>
 >>>>>
 >>>>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>>>
 >>>>>> A new problem report is waiting at
 >>>>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>>>
 >>>>>> Reported by Radon Rosborough for release: 6.6
 >>>>>>
 >>>>>> *** Description:
 >>>>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>>>> keyboard layout. If I am using my custom keyboard layout (but not wh=
 en
 >>>>>> using the default keyboard layout), then when:
 >>>>>>
 >>>>>> - launching the 'drracket' executable,
 >>>>>> - opening the DrRacket application, or
 >>>>>> - using geiser in Emacs, compiling a file with '#lang slideshow' in
 >>>>>> it,
 >>>>>>
 >>>>>> Racket crashes immediately with the following error:
 >>>>>>
 >>>>>> integer->char: contract violation
 >>>>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800
 >>>>>> #xDFFF)))
 >>>>>>   given: 55357
 >>>>>>   context...:
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/coco=
 a/window.rkt:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/coco=
 a/item.rkt:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/coco=
 a/button.rkt:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/coco=
 a/platform.rkt:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/plat=
 form.rkt:
 >>>>>> [running body]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.=
 rkt:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rk=
 t:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt:
 >>>>>> [traversing imports]
 >>>>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.r=
 kt:
 >>>>>> [traversing imports]
 >>>>>>
 >>>>>> *** How to repeat:
 >>>>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 >>>>>> reproduce the problem on a virtual machine with a fresh install of E=
 l
 >>>>>> Capitan 10.11.
 >>>>>>
 >>>>>> - Download my custom keyboard layout: https://drive.google.com/open?
 >>>>>> id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>>>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts".
 >>>>>> - In System Preferences > Keyboard > Input Sources, add "My Keyboard
 >>>>>> Layout" as an input source.
 >>>>>> - Make sure the "Show Input menu in menu bar" checkbox is checked.
 >>>>>> - In the Input menu in the menu bar, select "My Keyboard Layout".
 >>>>>> - Launch DrRacket. It should crash (and provide the above error
 >>>>>> message if it was launched from the command line).
 >>>>>>
 >>>>>> *** Environment:
 >>>>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel
 >>>>>> Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_X86_64
 >>>>>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>>>> Human Language: english
 >>>>>> (current-memory-use) 252260656
 >>>>>> raco pkg (show):
 >>>>>> Installation-wide:
 >>>>>>  Package            Checksum             Source
 >>>>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>>>  [189 auto-installed packages not shown]
 >>>>>> User-specific for installation "6.6":
 >>>>>>  [none]
 >>>>>>
 >>>>>>
 >>>>>>
 >>>>>> Collections:
 >>>>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>>>  (non-existent-path))
 >>>>>> ("/Applications/Racket v6.6/collects"
 >>>>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "rack=
 et"
 >>>>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"))
 >>>>>>
 >>>>>> Recent Internal Errors:
 >>>>>> Computer Language: (("Initial language" "No language chosen") #(#t
 >>>>>> print mixed-fraction-e #f #t debug))
 >>>>>>
 >>>>>>
 >>>>>
 >>>>>
 >>>>> --
 >>>>> --
 >>>>> Jens Axel S=C3=B8gaard
 >>>>>
 >>>>>
 >>>>
 >>>
 >>>
 >>> --
 >>> --
 >>> Jens Axel S=C3=B8gaard
 >>>
 >>>
 >>
 >
 >
 > --
 > --
 > Jens Axel S=C3=B8gaard
 >
 >
 
 --001a11418d74557f92053c017645
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr"><div class=3D"markdown-here-wrapper" style=3D""><p style=
 =3D"margin:0px 0px 1.2em!important">It looks to me like the reason for this=
  is that the <code style=3D"font-size:0.85em;font-family:Consolas,Inconsola=
 ta,Courier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wr=
 ap;border:1px solid rgb(234,234,234);border-radius:3px;display:inline;backg=
 round-color:rgb(248,248,248)">gui-lib</code> package (loaded for anything g=
 raphical, I presume, including launching DrRacket) fills out a hash table f=
 or keyboard mappings eagerly (on package load). The following is from line =
 551 of <code style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Cou=
 rier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;bor=
 der:1px solid rgb(234,234,234);border-radius:3px;display:inline;background-=
 color:rgb(248,248,248)">/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p=
 rivate/wx/cocoa/key-translate.rkt</code>:</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre;overflow:auto;border-radius:3px;border:1px solid rgb(204,204,=
 204);padding:0.5em 0.7em;display:block!important">;; fill in hash tables
 (for* ([modsyms all-modifier-combinations]                            ; go =
 through all physical key
        [(kvc n) virtual-key-code-name-to-value-ht])                   ; and=
  modifier combinations
   (define modks (modifier-symbol-list-&gt;integer modsyms))
   (define s (key-translate n #:modifier-key-state modks))             ; tra=
 nslate to a char
   (unless (string=3D? s &quot;&quot;)                                      =
        ; unless key is dead
     (define c (string-ref s 0))
     (hash-set-new! char-to-osx-keycode+modifiers-ht c                 ; sto=
 re where char is from
                    (list kvc n modsyms modks))                        ; (si=
 mplest is kept)
     (cond=20
       [(null? modsyms)                                               ; also=
 , if it is a main char
        (hash-set! char-to-main-char-key-ht c c)                       ;   s=
 tore it as such
        (hash-set! osx-keycode-to-main-char-key-ht n c)]               ;  =
 =20
       [else
        (define mck (hash-ref osx-keycode-to-main-char-key-ht n #f))   ; oth=
 erwise find=20
        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;   a=
 nd store main char key
 </code></pre><div title=3D"MDH:SXQgbG9va3MgdG8gbWUgbGlrZSB0aGUgcmVhc29uIGZv=
 ciB0aGlzIGlzIHRoYXQgdGhlIGBndWkt
 bGliYCBwYWNrYWdlIChsb2FkZWQgZm9yIGFueXRoaW5nIGdyYXBoaWNhbCwgSSBwcmVzdW1lLCB=
 p
 bmNsdWRpbmcgbGF1bmNoaW5nIERyUmFja2V0KSBmaWxscyBvdXQgYSBoYXNoIHRhYmxlIGZvciB=
 r
 ZXlib2FyZCBtYXBwaW5ncyBlYWdlcmx5IChvbiBwYWNrYWdlIGxvYWQpLiBUaGUgZm9sbG93aW5=
 n
 IGlzIGZyb20gbGluZSA1NTEgb2YgYC9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJhbnNsYXRlLnJrdGA6PGRpdj4=
 8
 YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2PjxkaXY+OzsgZmlsbCBpbiBoYXNoIHRhYmxlczw=
 v
 ZGl2PjxkaXY+KGZvciogKFttb2RzeW1zIGFsbC1tb2RpZmllci1jb21iaW5hdGlvbnNdICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs7IGdvIHRocm91Z2ggYWxsIHBoeXN=
 p
 Y2FsIGtleTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7WyhrdmMgbikgdml=
 y
 dHVhbC1rZXktY29kZS1uYW1lLXRvLXZhbHVlLWh0XSkgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyBhbmQgbW9kaWZpZXIgY29=
 t
 YmluYXRpb25zPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBtb2RrcyAobW9kaWZpZXItc3ltYm9=
 s
 LWxpc3QtJmd0O2ludGVnZXIgbW9kc3ltcykpPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBzICh=
 r
 ZXktdHJhbnNsYXRlIG4gIzptb2RpZmllci1rZXktc3RhdGUgbW9ka3MpKSAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHRyYW5zbGF0ZSB0byBhIGNoYXI8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAodW5sZXNzIChzdHJpbmc9PyBzICIiKSAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgOyB1bmxlc3Mga2V5IGlzIGRlYWQ8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgKGRlZmluZSBjIChzdHJpbmctcmVmIHMgMCkpPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 IChoYXNoLXNldC1uZXchIGNoYXItdG8tb3N4LWtleWNvZGUrbW9kaWZpZXJzLWh0IGMgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHN0b3J=
 l
 IHdoZXJlIGNoYXIgaXMgZnJvbTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGxpc3Qga3ZjIG4gbW9=
 k
 c3ltcyBtb2RrcykpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyAoc2ltcGxlc3QgaXMga2V=
 w
 dCk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgKGNvbmQmbmJzcDs8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7IFsobnVsbD8gbW9kc3ltcykgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyA7IGFsc28sIGlmIGl0IGlzIGEgbWFpbiBjaGFyPC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsoaGFzaC1zZXQhIGNoYXItdG8tbWFpbi1jaGF=
 y
 LWtleS1odCBjIGMpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyAmbmJzcDsgc3RvcmUgaXQgYXMgc3V=
 j
 aDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGhhc2gtc2V0ISBvc3gta2V=
 5
 Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gYyldICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7ICZuYnNwOyZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgW2Vsc2U8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyh=
 k
 ZWZpbmUgbWNrIChoYXNoLXJlZiBvc3gta2V5Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gI2Y=
 p
 KSAmbmJzcDsgOyBvdGhlcndpc2UgZmluZCZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7KHdoZW4gbWNrIChoYXNoLXNldC1uZXchIGNoYXItdG8tbWFpbi1jaGFyLWt=
 l
 eS1odCBjIG1jaykpXSkpKSAmbmJzcDs7ICZuYnNwOyBhbmQgc3RvcmUgbWFpbiBjaGFyIGtleTw=
 v
 ZGl2PjwvZGl2PjxkaXY+YGBgPC9kaXY+" style=3D"height:0;width:0;max-height:0;ma=
 x-width:0;overflow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</div>=
 </div></div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">On Th=
 u, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a =
 href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@soegaard.n=
 et</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"marg=
 in:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr"=
 ><div>That sounds as something that should work.</div>As far as I know=C2=
 =A0key-translate is only called when you actually press a key.<br>So I am s=
 urprised that you see the error when DrRacket starts.<br><br>I&#39;ll need =
 to look up Ukelele.<span class=3D"HOEnZb"><font color=3D"#888888"><br><br>/=
 Jens Axel<br><div><div><br></div><div><br></div></div></font></span></div><=
 div class=3D"HOEnZb"><div class=3D"h5"><div class=3D"gmail_extra"><br><div =
 class=3D"gmail_quote">2016-09-08 18:11 GMT+02:00 Radon Rosborough <span dir=
 =3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">rado=
 n.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=
 =3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=
 =3D"ltr">It&#39;s not intentionally. Perhaps they are an artifact created b=
 y Ukelele. Is there an easy way to determine which key is producing the sur=
 rogate code point(s)?<div><br></div><div>The first thing I think of is the =
 dead keys used for creating accents in OS X, but these are also present in =
 the default keyboard layout. The only thing I have done with them is move t=
 he Alt+E dead key to Alt+Shift+`.</div></div><div><div><div class=3D"gmail_=
 extra"><br><div class=3D"gmail_quote">On Thu, Sep 8, 2016 at 9:03 AM, Jens =
 Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard=
 .net" target=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><blo=
 ckquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #c=
 cc solid;padding-left:1ex"><div dir=3D"ltr"><span style=3D"font-size:12.8px=
 ">Here is what I have so far:</span><div><span style=3D"font-size:12.8px"><=
 br></span></div><div>1) integer-&gt;char is being called with an input that=
  aren&#39;t accepted</div><div>2) the caller is=C2=A0<span style=3D"color:r=
 gb(51,51,51);font-family:consolas,&quot;liberation mono&quot;,menlo,courier=
 ,monospace;font-size:12px;line-height:20px;white-space:pre-wrap">key-transl=
 ate </span>a low level function whose job</div><div>=C2=A0 =C2=A0 is to tra=
 nslate (physical) keycodes into characters using=C2=A0</div><div>=C2=A0 =C2=
 =A0 a keyboard layout.=C2=A0</div><div>3) it is a bug in key-translate that=
  integer-&gt;char is called with</div><div>=C2=A0 =C2=A0 an integer that do=
 esn&#39;t correspond to a character</div><div><br></div><div>4) From=C2=A0<=
 /div><div><span><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 integer-&gt;char: contract violation</span><br style=3D"font-siz=
 e:12.8px"><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #xDF=
 FF)))</span><br style=3D"font-size:12.8px"><span style=3D"font-size:12.8px"=
 >=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 given: 55357<br></span></span>=C2=A0 =
 =C2=A0 we learn that the operating system translated a keycode to the codep=
 oint=C2=A0<span style=3D"font-size:12.8px">55357.</span></div><div><span st=
 yle=3D"font-size:12.8px">=C2=A0 =C2=A0 That code point lies in the range D8=
 00 to DFFF which are not accepted by</span></div><div><span style=3D"font-s=
 ize:12.8px">=C2=A0 =C2=A0 integer-&gt;char</span></div><div><span style=3D"=
 font-size:12.8px">5) That range is called &quot;High Surrogates&quot;=C2=A0=
 </span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 From=C2=A0=
 </span><span style=3D"font-size:12.8px"><a href=3D"http://www.alanwood.net/=
 unicode/high_surrogates.html" target=3D"_blank">http://www.alanwood.net/u<w=
 br>nicode/high_surrogates.html</a><br></span><span style=3D"font-size:12.8p=
 x"><br></span><span style=3D"color:rgb(0,0,0);font-family:times;font-size:1=
 6px;line-height:19.2px;background-color:rgb(255,255,242)">Surrogate code po=
 ints are intended to allow mapping of additional character planes into the =
 16-bit Unicode system, thus allowing more than 65,536 characters to be repr=
 esented. The individual surrogate code points do not represent characters; =
 they are intended to be used in pairs, a high code point followed by a low =
 code point, to stand in for a character in one of the supplementary planes.=
  Their use is restricted to UTF-16. They can be used for characters in=C2=
 =A0</span><a href=3D"http://www.alanwood.net/unicode/linear_b_syllabary.htm=
 l" style=3D"color:rgb(128,0,128);font-family:times;font-size:16px;line-heig=
 ht:19.2px;background-color:rgb(255,255,242)" target=3D"_blank">Linear B Syl=
 labary</a><span style=3D"color:rgb(0,0,0);font-family:times;font-size:16px;=
 line-height:19.2px;background-color:rgb(255,255,242)">=C2=A0and higher-numb=
 ered ranges.<br></span></div><div><span style=3D"font-size:12.8px"><br></sp=
 an></div><div><br></div><div>Is it intentionally that your layout produces =
 such code points?</div><span><font color=3D"#888888"><div><br></div><div>/J=
 ens Axel</div><div><br></div><div><br></div></font></span></div><div><div><=
 div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:50 G=
 MT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neo=
 n@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blo=
 ckquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #c=
 cc solid;padding-left:1ex"><div dir=3D"ltr">Before. If I switch after I lau=
 nch DrRacket, it appears to work OK, although I haven&#39;t tried anything =
 substantial to make sure everything works.</div><div><div><div class=3D"gma=
 il_extra"><br><div class=3D"gmail_quote">On Thu, Sep 8, 2016 at 8:43 AM, Je=
 ns Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soega=
 ard.net" target=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><=
 blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px=
  #ccc solid;padding-left:1ex"><div dir=3D"ltr">Did you switch to your keybo=
 ard layout before or after starting DrRacket?<div><br></div><div>/Jens Axel=
 </div><div><br></div></div><div class=3D"gmail_extra"><br><div class=3D"gma=
 il_quote">2016-09-08 17:32 GMT+02:00  <span dir=3D"ltr">&lt;<a href=3D"mail=
 to:radon.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</sp=
 an>:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border=
 -left:1px #ccc solid;padding-left:1ex">A new problem report is waiting at<b=
 r>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 
 --001a11418d74557f92053c017645--
From: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
To: Radon Rosborough <radon.neon@gmail.com>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 18:35:08 +0200

 --001a1149a95aefa8b3053c019c0b
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 Progress - so key-translate does get called.
 
 The two last lines of key-translate are:
 
     (list->string (for/list ([i (in-range n)])
                        (integer->char (ptr-ref output-chars _UniChar i)))))
 
 Can you test what happens if you change it to:
 
     (list->string (for/list ([i (in-range n)])
                            (define i (ptr-ref output-chars _UniChar i))
                            (if (<=3D  #xD800 i #xDFFF)
                                 ""
                                (integer->char i)))))
 
 ?
 
 
 2016-09-08 18:23 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 
 > It looks to me like the reason for this is that the gui-lib package
 > (loaded for anything graphical, I presume, including launching DrRacket)
 > fills out a hash table for keyboard mappings eagerly (on package load). T=
 he
 > following is from line 551 of /Applications/Racket
 > v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 >
 > ;; fill in hash tables
 > (for* ([modsyms all-modifier-combinations]                            ; g=
 o through all physical key
 >        [(kvc n) virtual-key-code-name-to-value-ht])                   ; a=
 nd modifier combinations
 >   (define modks (modifier-symbol-list->integer modsyms))
 >   (define s (key-translate n #:modifier-key-state modks))             ; t=
 ranslate to a char
 >   (unless (string=3D? s "")                                             ;=
  unless key is dead
 >     (define c (string-ref s 0))
 >     (hash-set-new! char-to-osx-keycode+modifiers-ht c                 ; s=
 tore where char is from
 >                    (list kvc n modsyms modks))                        ; (=
 simplest is kept)
 >     (cond
 >       [(null? modsyms)                                               ; al=
 so, if it is a main char
 >        (hash-set! char-to-main-char-key-ht c c)                       ;  =
  store it as such
 >        (hash-set! osx-keycode-to-main-char-key-ht n c)]               ;
 >       [else
 >        (define mck (hash-ref osx-keycode-to-main-char-key-ht n #f))   ; o=
 therwise find
 >        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;  =
  and store main char key
 >
 > =E2=80=8B
 >
 > On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard=
 .net>
 > wrote:
 >
 >> That sounds as something that should work.
 >> As far as I know key-translate is only called when you actually press a
 >> key.
 >> So I am surprised that you see the error when DrRacket starts.
 >>
 >> I'll need to look up Ukelele.
 >>
 >> /Jens Axel
 >>
 >>
 >>
 >> 2016-09-08 18:11 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>
 >>> It's not intentionally. Perhaps they are an artifact created by Ukelele=
 .
 >>> Is there an easy way to determine which key is producing the surrogate =
 code
 >>> point(s)?
 >>>
 >>> The first thing I think of is the dead keys used for creating accents i=
 n
 >>> OS X, but these are also present in the default keyboard layout. The on=
 ly
 >>> thing I have done with them is move the Alt+E dead key to Alt+Shift+`.
 >>>
 >>> On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaa=
 rd.net
 >>> > wrote:
 >>>
 >>>> Here is what I have so far:
 >>>>
 >>>> 1) integer->char is being called with an input that aren't accepted
 >>>> 2) the caller is key-translate a low level function whose job
 >>>>     is to translate (physical) keycodes into characters using
 >>>>     a keyboard layout.
 >>>> 3) it is a bug in key-translate that integer->char is called with
 >>>>     an integer that doesn't correspond to a character
 >>>>
 >>>> 4) From
 >>>>           integer->char: contract violation
 >>>>           expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >>>> #xD800 #xDFFF)))
 >>>>           given: 55357
 >>>>     we learn that the operating system translated a keycode to the
 >>>> codepoint 55357.
 >>>>     That code point lies in the range D800 to DFFF which are not
 >>>> accepted by
 >>>>     integer->char
 >>>> 5) That range is called "High Surrogates"
 >>>>     From http://www.alanwood.net/unicode/high_surrogates.html
 >>>>
 >>>> Surrogate code points are intended to allow mapping of additional
 >>>> character planes into the 16-bit Unicode system, thus allowing more th=
 an
 >>>> 65,536 characters to be represented. The individual surrogate code poi=
 nts
 >>>> do not represent characters; they are intended to be used in pairs, a =
 high
 >>>> code point followed by a low code point, to stand in for a character i=
 n one
 >>>> of the supplementary planes. Their use is restricted to UTF-16. They c=
 an be
 >>>> used for characters in Linear B Syllabary
 >>>> <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 >>>> higher-numbered ranges.
 >>>>
 >>>>
 >>>> Is it intentionally that your layout produces such code points?
 >>>>
 >>>> /Jens Axel
 >>>>
 >>>>
 >>>>
 >>>> 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>
 >>>>> Before. If I switch after I launch DrRacket, it appears to work OK,
 >>>>> although I haven't tried anything substantial to make sure everything=
  works.
 >>>>>
 >>>>> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <
 >>>>> jensaxel@soegaard.net> wrote:
 >>>>>
 >>>>>> Did you switch to your keyboard layout before or after starting
 >>>>>> DrRacket?
 >>>>>>
 >>>>>> /Jens Axel
 >>>>>>
 >>>>>>
 >>>>>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>>>>
 >>>>>>> A new problem report is waiting at
 >>>>>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>>>>
 >>>>>>> Reported by Radon Rosborough for release: 6.6
 >>>>>>>
 >>>>>>> *** Description:
 >>>>>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>>>>> keyboard layout. If I am using my custom keyboard layout (but not w=
 hen
 >>>>>>> using the default keyboard layout), then when:
 >>>>>>>
 >>>>>>> - launching the 'drracket' executable,
 >>>>>>> - opening the DrRacket application, or
 >>>>>>> - using geiser in Emacs, compiling a file with '#lang slideshow' in
 >>>>>>> it,
 >>>>>>>
 >>>>>>> Racket crashes immediately with the following error:
 >>>>>>>
 >>>>>>> integer->char: contract violation
 >>>>>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD80=
 0
 >>>>>>> #xDFFF)))
 >>>>>>>   given: 55357
 >>>>>>>   context...:
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/coc=
 oa/window.rkt:
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/coc=
 oa/item.rkt:
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/coc=
 oa/button.rkt:
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/coc=
 oa/platform.rkt:
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/pla=
 tform.rkt:
 >>>>>>> [running body]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel=
 .rkt:
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.r=
 kt:
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt=
 :
 >>>>>>> [traversing imports]
 >>>>>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.=
 rkt:
 >>>>>>> [traversing imports]
 >>>>>>>
 >>>>>>> *** How to repeat:
 >>>>>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 >>>>>>> reproduce the problem on a virtual machine with a fresh install of =
 El
 >>>>>>> Capitan 10.11.
 >>>>>>>
 >>>>>>> - Download my custom keyboard layout: https://drive.google.com/open=
 ?
 >>>>>>> id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>>>>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts"=
 .
 >>>>>>> - In System Preferences > Keyboard > Input Sources, add "My Keyboar=
 d
 >>>>>>> Layout" as an input source.
 >>>>>>> - Make sure the "Show Input menu in menu bar" checkbox is checked.
 >>>>>>> - In the Input menu in the menu bar, select "My Keyboard Layout".
 >>>>>>> - Launch DrRacket. It should crash (and provide the above error
 >>>>>>> message if it was launched from the command line).
 >>>>>>>
 >>>>>>> *** Environment:
 >>>>>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel
 >>>>>>> Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1=
 /RELEASE_X86_64
 >>>>>>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>>>>> Human Language: english
 >>>>>>> (current-memory-use) 252260656
 >>>>>>> raco pkg (show):
 >>>>>>> Installation-wide:
 >>>>>>>  Package            Checksum             Source
 >>>>>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>>>>  [189 auto-installed packages not shown]
 >>>>>>> User-specific for installation "6.6":
 >>>>>>>  [none]
 >>>>>>>
 >>>>>>>
 >>>>>>>
 >>>>>>> Collections:
 >>>>>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>>>>  (non-existent-path))
 >>>>>>> ("/Applications/Racket v6.6/collects"
 >>>>>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>>>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "rac=
 ket"
 >>>>>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"))
 >>>>>>>
 >>>>>>> Recent Internal Errors:
 >>>>>>> Computer Language: (("Initial language" "No language chosen") #(#t
 >>>>>>> print mixed-fraction-e #f #t debug))
 >>>>>>>
 >>>>>>>
 >>>>>>
 >>>>>>
 >>>>>> --
 >>>>>> --
 >>>>>> Jens Axel S=C3=B8gaard
 >>>>>>
 >>>>>>
 >>>>>
 >>>>
 >>>>
 >>>> --
 >>>> --
 >>>> Jens Axel S=C3=B8gaard
 >>>>
 >>>>
 >>>
 >>
 >>
 >> --
 >> --
 >> Jens Axel S=C3=B8gaard
 >>
 >>
 >
 
 
 --=20
 --=20
 Jens Axel S=C3=B8gaard
 
 --001a1149a95aefa8b3053c019c0b
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr">Progress - so key-translate does get called.<br><br>The tw=
 o last lines of key-translate are:<br><br><div>=C2=A0 =C2=A0 (list-&gt;stri=
 ng (for/list ([i (in-range n)])=C2=A0</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0=
  =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;char (=
 ptr-ref output-chars _UniChar i)))))<br><br>Can you test what happens if yo=
 u change it to:<br><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/list ([i (i=
 n-range n)])=C2=A0</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(define i (ptr-ref outp=
 ut-chars _UniChar i))</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(if (&lt;=3D=C2=A0<s=
 pan style=3D"color:rgb(80,0,80);font-size:12.8px">=C2=A0</span><span style=
 =3D"color:rgb(80,0,80);font-size:12.8px">#xD800 i #xDFFF)</span></div><div>=
 <span style=3D"color:rgb(80,0,80);font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 &quot;&quot;</span></div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0=
  =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0(integer-&gt;char i)))))<br><br>?</div><br></div></div><div class=
 =3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 18:23 GMT+02:00 =
 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.c=
 om" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote c=
 lass=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;=
 padding-left:1ex"><div dir=3D"ltr"><div><p style=3D"margin:0px 0px 1.2em!im=
 portant">It looks to me like the reason for this is that the <code style=3D=
 "font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin=
 :0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234=
 ,234,234);border-radius:3px;display:inline;background-color:rgb(248,248,248=
 )">gui-lib</code> package (loaded for anything graphical, I presume, includ=
 ing launching DrRacket) fills out a hash table for keyboard mappings eagerl=
 y (on package load). The following is from line 551 of <code style=3D"font-=
 size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px 0=
 .15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234,2=
 34);border-radius:3px;display:inline;background-color:rgb(248,248,248)">/Ap=
 plications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/key-<w=
 br>translate.rkt</code>:</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">;; fill in hash tabl=
 es
 (for* ([modsyms all-modifier-combinations]                            ; go =
 through all physical key
        [(kvc n) virtual-key-code-name-to-<wbr>value-ht])                   =
 ; and modifier combinations
   (define modks (modifier-symbol-list-&gt;integer modsyms))
   (define s (key-translate n #:modifier-key-state modks))             ; tra=
 nslate to a char
   (unless (string=3D? s &quot;&quot;)                                      =
        ; unless key is dead
     (define c (string-ref s 0))
     (hash-set-new! char-to-osx-keycode+modifiers-<wbr>ht c                 =
 ; store where char is from
                    (list kvc n modsyms modks))                        ; (si=
 mplest is kept)
     (cond=20
       [(null? modsyms)                                               ; also=
 , if it is a main char
        (hash-set! char-to-main-char-key-ht c c)                       ;   s=
 tore it as such
        (hash-set! osx-keycode-to-main-char-key-<wbr>ht n c)]               =
 ;  =20
       [else
        (define mck (hash-ref osx-keycode-to-main-char-key-<wbr>ht n #f))   =
 ; otherwise find=20
        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;   a=
 nd store main char key
 </code></pre><div title=3D"MDH:SXQgbG9va3MgdG8gbWUgbGlrZSB0aGUgcmVhc29uIGZv=
 ciB0aGlzIGlzIHRoYXQgdGhlIGBndWkt
 bGliYCBwYWNrYWdlIChsb2FkZWQgZm9yIGFueXRoaW5nIGdyYXBoaWNhbCwgSSBwcmVzdW1lLCB=
 p
 bmNsdWRpbmcgbGF1bmNoaW5nIERyUmFja2V0KSBmaWxscyBvdXQgYSBoYXNoIHRhYmxlIGZvciB=
 r
 ZXlib2FyZCBtYXBwaW5ncyBlYWdlcmx5IChvbiBwYWNrYWdlIGxvYWQpLiBUaGUgZm9sbG93aW5=
 n
 IGlzIGZyb20gbGluZSA1NTEgb2YgYC9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJhbnNsYXRlLnJrdGA6PGRpdj4=
 8
 YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2PjxkaXY+OzsgZmlsbCBpbiBoYXNoIHRhYmxlczw=
 v
 ZGl2PjxkaXY+KGZvciogKFttb2RzeW1zIGFsbC1tb2RpZmllci1jb21iaW5hdGlvbnNdICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs7IGdvIHRocm91Z2ggYWxsIHBoeXN=
 p
 Y2FsIGtleTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7WyhrdmMgbikgdml=
 y
 dHVhbC1rZXktY29kZS1uYW1lLXRvLXZhbHVlLWh0XSkgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyBhbmQgbW9kaWZpZXIgY29=
 t
 YmluYXRpb25zPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBtb2RrcyAobW9kaWZpZXItc3ltYm9=
 s
 LWxpc3QtJmd0O2ludGVnZXIgbW9kc3ltcykpPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBzICh=
 r
 ZXktdHJhbnNsYXRlIG4gIzptb2RpZmllci1rZXktc3RhdGUgbW9ka3MpKSAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHRyYW5zbGF0ZSB0byBhIGNoYXI8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAodW5sZXNzIChzdHJpbmc9PyBzICIiKSAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgOyB1bmxlc3Mga2V5IGlzIGRlYWQ8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgKGRlZmluZSBjIChzdHJpbmctcmVmIHMgMCkpPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 IChoYXNoLXNldC1uZXchIGNoYXItdG8tb3N4LWtleWNvZGUrbW9kaWZpZXJzLWh0IGMgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHN0b3J=
 l
 IHdoZXJlIGNoYXIgaXMgZnJvbTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGxpc3Qga3ZjIG4gbW9=
 k
 c3ltcyBtb2RrcykpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyAoc2ltcGxlc3QgaXMga2V=
 w
 dCk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgKGNvbmQmbmJzcDs8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7IFsobnVsbD8gbW9kc3ltcykgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyA7IGFsc28sIGlmIGl0IGlzIGEgbWFpbiBjaGFyPC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsoaGFzaC1zZXQhIGNoYXItdG8tbWFpbi1jaGF=
 y
 LWtleS1odCBjIGMpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyAmbmJzcDsgc3RvcmUgaXQgYXMgc3V=
 j
 aDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGhhc2gtc2V0ISBvc3gta2V=
 5
 Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gYyldICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7ICZuYnNwOyZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgW2Vsc2U8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyh=
 k
 ZWZpbmUgbWNrIChoYXNoLXJlZiBvc3gta2V5Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gI2Y=
 p
 KSAmbmJzcDsgOyBvdGhlcndpc2UgZmluZCZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7KHdoZW4gbWNrIChoYXNoLXNldC1uZXchIGNoYXItdG8tbWFpbi1jaGFyLWt=
 l
 eS1odCBjIG1jaykpXSkpKSAmbmJzcDs7ICZuYnNwOyBhbmQgc3RvcmUgbWFpbiBjaGFyIGtleTw=
 v
 ZGl2PjwvZGl2PjxkaXY+YGBgPC9kaXY+" style=3D"min-height:0;width:0;max-height:=
 0;max-width:0;overflow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</=
 div></div></div><div class=3D"HOEnZb"><div class=3D"h5"><div class=3D"gmail=
 _extra"><br><div class=3D"gmail_quote">On Thu, Sep 8, 2016 at 9:17 AM, Jens=
  Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaar=
 d.net" target=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><bl=
 ockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #=
 ccc solid;padding-left:1ex"><div dir=3D"ltr"><div>That sounds as something =
 that should work.</div>As far as I know=C2=A0key-translate is only called w=
 hen you actually press a key.<br>So I am surprised that you see the error w=
 hen DrRacket starts.<br><br>I&#39;ll need to look up Ukelele.<span><font co=
 lor=3D"#888888"><br><br>/Jens Axel<br><div><div><br></div><div><br></div></=
 div></font></span></div><div><div><div class=3D"gmail_extra"><br><div class=
 =3D"gmail_quote">2016-09-08 18:11 GMT+02:00 Radon Rosborough <span dir=3D"l=
 tr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.neo=
 n@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D"m=
 argin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"l=
 tr">It&#39;s not intentionally. Perhaps they are an artifact created by Uke=
 lele. Is there an easy way to determine which key is producing the surrogat=
 e code point(s)?<div><br></div><div>The first thing I think of is the dead =
 keys used for creating accents in OS X, but these are also present in the d=
 efault keyboard layout. The only thing I have done with them is move the Al=
 t+E dead key to Alt+Shift+`.</div></div><div><div><div class=3D"gmail_extra=
 "><br><div class=3D"gmail_quote">On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel =
 S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net"=
  target=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><blockquo=
 te class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc so=
 lid;padding-left:1ex"><div dir=3D"ltr"><span style=3D"font-size:12.8px">Her=
 e is what I have so far:</span><div><span style=3D"font-size:12.8px"><br></=
 span></div><div>1) integer-&gt;char is being called with an input that aren=
 &#39;t accepted</div><div>2) the caller is=C2=A0<span style=3D"color:rgb(51=
 ,51,51);font-family:consolas,&quot;liberation mono&quot;,menlo,courier,mono=
 space;font-size:12px;line-height:20px;white-space:pre-wrap">key-translate <=
 /span>a low level function whose job</div><div>=C2=A0 =C2=A0 is to translat=
 e (physical) keycodes into characters using=C2=A0</div><div>=C2=A0 =C2=A0 a=
  keyboard layout.=C2=A0</div><div>3) it is a bug in key-translate that inte=
 ger-&gt;char is called with</div><div>=C2=A0 =C2=A0 an integer that doesn&#=
 39;t correspond to a character</div><div><br></div><div>4) From=C2=A0</div>=
 <div><span><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 integer-&gt;char: contract violation</span><br style=3D"font-size:12.8p=
 x"><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 expe=
 cted: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #xDFFF)))</s=
 pan><br style=3D"font-size:12.8px"><span style=3D"font-size:12.8px">=C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 given: 55357<br></span></span>=C2=A0 =C2=A0 we =
 learn that the operating system translated a keycode to the codepoint=C2=A0=
 <span style=3D"font-size:12.8px">55357.</span></div><div><span style=3D"fon=
 t-size:12.8px">=C2=A0 =C2=A0 That code point lies in the range D800 to DFFF=
  which are not accepted by</span></div><div><span style=3D"font-size:12.8px=
 ">=C2=A0 =C2=A0 integer-&gt;char</span></div><div><span style=3D"font-size:=
 12.8px">5) That range is called &quot;High Surrogates&quot;=C2=A0</span></d=
 iv><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 From=C2=A0</span><sp=
 an style=3D"font-size:12.8px"><a href=3D"http://www.alanwood.net/unicode/hi=
 gh_surrogates.html" target=3D"_blank">http://www.alanwood.net/u<wbr>nicode/=
 high_surrogates.html</a><br></span><span style=3D"font-size:12.8px"><br></s=
 pan><span style=3D"color:rgb(0,0,0);font-family:times;font-size:16px;line-h=
 eight:19.2px;background-color:rgb(255,255,242)">Surrogate code points are i=
 ntended to allow mapping of additional character planes into the 16-bit Uni=
 code system, thus allowing more than 65,536 characters to be represented. T=
 he individual surrogate code points do not represent characters; they are i=
 ntended to be used in pairs, a high code point followed by a low code point=
 , to stand in for a character in one of the supplementary planes. Their use=
  is restricted to UTF-16. They can be used for characters in=C2=A0</span><a=
  href=3D"http://www.alanwood.net/unicode/linear_b_syllabary.html" style=3D"=
 color:rgb(128,0,128);font-family:times;font-size:16px;line-height:19.2px;ba=
 ckground-color:rgb(255,255,242)" target=3D"_blank">Linear B Syllabary</a><s=
 pan style=3D"color:rgb(0,0,0);font-family:times;font-size:16px;line-height:=
 19.2px;background-color:rgb(255,255,242)">=C2=A0and higher-numbered ranges.=
 <br></span></div><div><span style=3D"font-size:12.8px"><br></span></div><di=
 v><br></div><div>Is it intentionally that your layout produces such code po=
 ints?</div><span><font color=3D"#888888"><div><br></div><div>/Jens Axel</di=
 v><div><br></div><div><br></div></font></span></div><div><div><div class=3D=
 "gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:50 GMT+02:00 Rad=
 on Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com"=
  target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote clas=
 s=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;pad=
 ding-left:1ex"><div dir=3D"ltr">Before. If I switch after I launch DrRacket=
 , it appears to work OK, although I haven&#39;t tried anything substantial =
 to make sure everything works.</div><div><div><div class=3D"gmail_extra"><b=
 r><div class=3D"gmail_quote">On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=
 =B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" tar=
 get=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote c=
 lass=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;=
 padding-left:1ex"><div dir=3D"ltr">Did you switch to your keyboard layout b=
 efore or after starting DrRacket?<div><br></div><div>/Jens Axel</div><div><=
 br></div></div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">20=
 16-09-08 17:32 GMT+02:00  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neo=
 n@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blo=
 ckquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #c=
 cc solid;padding-left:1ex">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div class=3D"gmail_signature" data-smartmail=3D"gmail_signature">-- <br>Je=
 ns Axel S=C3=B8gaard<br><br></div>
 </div>
 
 --001a1149a95aefa8b3053c019c0b--
From: Radon Rosborough <radon.neon@gmail.com>
To: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 11:24:14 -0700

 --001a114124a88358ed053c032535
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 Strangely, I get the following error (with both my keyboard layout and the
 standard one):
 
 i: undefined;
  cannot use before initialization
   context...:
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:495:16:
 for-loop
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:555:0:
 for-loop
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 [running body]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/window.rkt: [traversing
 imports]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/item.rkt: [traversing
 imports]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/button.rkt: [traversing
 imports]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/platform.rkt:
 [traversing imports]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/platform.rkt: [running body]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt:
 [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt:
 [traversing imports]
    /Applications/Racket
 v6.6/share/pkgs/drracket/drracket/drracket.rkt: [traversing imports]
 
 I am just getting started with Racket so I don=E2=80=99t know why this woul=
 d be=E2=80=94it
 looks like i is introduced as a local binding to me. Here is what my
 modified key-translate looks like:
 
 (define (key-translate virtual-key-code
                        #:key-action            [key-action
 kUCKeyActionDown]
                        #:modifier-key-state    [modifier-key-state
            0]  ; no modifier
                        #:keyboard-type         [keyboard-type
 (LMGetKbdType)]
                        #:key-translate-options [key-translate-options
           #f]
                        #:dead-key-state        [dead-key-state
           #f]  ; no prev state
                        #:keyboard-layout       [layout-in
      'cached]) ; use cached
   (define actual-string-length (box 0))
   (set! key-translate-options
         (or key-translate-options                ; use user settings if pro=
 vided
             (if dead-key-state                   ; otherwise if user
 has set dead-key-state,
                 0                                ; then take dead-keys
 into account
                 kUCKeyTranslateNoDeadKeysFlag))) ; else ignore dead keys
 
   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state)))
 
   (define layout
     (case layout-in
       ; use cached
       [(cached)    (cond
                     [cached-keyboard-layout =3D> values]
                     [else   (set! cached-keyboard-layout
 (get-current-keyboard-layout))
                             cached-keyboard-layout])]
       ; refresh cache
       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-layo=
 ut))
                     cached-keyboard-layout]
       ; use provided
       [else          layout-in]))
 
   (UCKeyTranslate layout
                   virtual-key-code
                   key-action
                   (bitwise-and (>> modifier-key-state 8) #xFF)
                   keyboard-type
                   key-translate-options
                   dead-key-state
                   max-string-length
                   actual-string-length
                   output-chars)
   ; get the number of characters returned, and convert to string
   (define n (max 0 (min max-string-length (unbox actual-string-length))))
   (list->string (for/list ([i (in-range n)])
                   (define i (ptr-ref output-chars _UniChar i))
                   (if (<=3D  #xD800 i #xDFFF)
                       ""
                       (integer->char i)))))
 
 =E2=80=8B
 
 On Thu, Sep 8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard.n=
 et>
 wrote:
 
 > Progress - so key-translate does get called.
 >
 > The two last lines of key-translate are:
 >
 >     (list->string (for/list ([i (in-range n)])
 >                        (integer->char (ptr-ref output-chars _UniChar i)))=
 ))
 >
 > Can you test what happens if you change it to:
 >
 >     (list->string (for/list ([i (in-range n)])
 >                            (define i (ptr-ref output-chars _UniChar i))
 >                            (if (<=3D  #xD800 i #xDFFF)
 >                                 ""
 >                                (integer->char i)))))
 >
 > ?
 >
 >
 > 2016-09-08 18:23 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >
 >> It looks to me like the reason for this is that the gui-lib package
 >> (loaded for anything graphical, I presume, including launching DrRacket)
 >> fills out a hash table for keyboard mappings eagerly (on package load). =
 The
 >> following is from line 551 of /Applications/Racket
 >> v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 >>
 >> ;; fill in hash tables
 >> (for* ([modsyms all-modifier-combinations]                            ; =
 go through all physical key
 >>        [(kvc n) virtual-key-code-name-to-value-ht])                   ; =
 and modifier combinations
 >>   (define modks (modifier-symbol-list->integer modsyms))
 >>   (define s (key-translate n #:modifier-key-state modks))             ; =
 translate to a char
 >>   (unless (string=3D? s "")                                             =
 ; unless key is dead
 >>     (define c (string-ref s 0))
 >>     (hash-set-new! char-to-osx-keycode+modifiers-ht c                 ; =
 store where char is from
 >>                    (list kvc n modsyms modks))                        ; =
 (simplest is kept)
 >>     (cond
 >>       [(null? modsyms)                                               ; a=
 lso, if it is a main char
 >>        (hash-set! char-to-main-char-key-ht c c)                       ; =
   store it as such
 >>        (hash-set! osx-keycode-to-main-char-key-ht n c)]               ;
 >>       [else
 >>        (define mck (hash-ref osx-keycode-to-main-char-key-ht n #f))   ; =
 otherwise find
 >>        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ; =
   and store main char key
 >>
 >> =E2=80=8B
 >>
 >> On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaar=
 d.net>
 >> wrote:
 >>
 >>> That sounds as something that should work.
 >>> As far as I know key-translate is only called when you actually press a
 >>> key.
 >>> So I am surprised that you see the error when DrRacket starts.
 >>>
 >>> I'll need to look up Ukelele.
 >>>
 >>> /Jens Axel
 >>>
 >>>
 >>>
 >>> 2016-09-08 18:11 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>
 >>>> It's not intentionally. Perhaps they are an artifact created by
 >>>> Ukelele. Is there an easy way to determine which key is producing the
 >>>> surrogate code point(s)?
 >>>>
 >>>> The first thing I think of is the dead keys used for creating accents
 >>>> in OS X, but these are also present in the default keyboard layout. Th=
 e
 >>>> only thing I have done with them is move the Alt+E dead key to Alt+Shi=
 ft+`.
 >>>>
 >>>> On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <
 >>>> jensaxel@soegaard.net> wrote:
 >>>>
 >>>>> Here is what I have so far:
 >>>>>
 >>>>> 1) integer->char is being called with an input that aren't accepted
 >>>>> 2) the caller is key-translate a low level function whose job
 >>>>>     is to translate (physical) keycodes into characters using
 >>>>>     a keyboard layout.
 >>>>> 3) it is a bug in key-translate that integer->char is called with
 >>>>>     an integer that doesn't correspond to a character
 >>>>>
 >>>>> 4) From
 >>>>>           integer->char: contract violation
 >>>>>           expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >>>>> #xD800 #xDFFF)))
 >>>>>           given: 55357
 >>>>>     we learn that the operating system translated a keycode to the
 >>>>> codepoint 55357.
 >>>>>     That code point lies in the range D800 to DFFF which are not
 >>>>> accepted by
 >>>>>     integer->char
 >>>>> 5) That range is called "High Surrogates"
 >>>>>     From http://www.alanwood.net/unicode/high_surrogates.html
 >>>>>
 >>>>> Surrogate code points are intended to allow mapping of additional
 >>>>> character planes into the 16-bit Unicode system, thus allowing more t=
 han
 >>>>> 65,536 characters to be represented. The individual surrogate code po=
 ints
 >>>>> do not represent characters; they are intended to be used in pairs, a=
  high
 >>>>> code point followed by a low code point, to stand in for a character =
 in one
 >>>>> of the supplementary planes. Their use is restricted to UTF-16. They =
 can be
 >>>>> used for characters in Linear B Syllabary
 >>>>> <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 >>>>> higher-numbered ranges.
 >>>>>
 >>>>>
 >>>>> Is it intentionally that your layout produces such code points?
 >>>>>
 >>>>> /Jens Axel
 >>>>>
 >>>>>
 >>>>>
 >>>>> 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>>
 >>>>>> Before. If I switch after I launch DrRacket, it appears to work OK,
 >>>>>> although I haven't tried anything substantial to make sure everythin=
 g works.
 >>>>>>
 >>>>>> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <
 >>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>
 >>>>>>> Did you switch to your keyboard layout before or after starting
 >>>>>>> DrRacket?
 >>>>>>>
 >>>>>>> /Jens Axel
 >>>>>>>
 >>>>>>>
 >>>>>>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>>>>>
 >>>>>>>> A new problem report is waiting at
 >>>>>>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>>>>>
 >>>>>>>> Reported by Radon Rosborough for release: 6.6
 >>>>>>>>
 >>>>>>>> *** Description:
 >>>>>>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>>>>>> keyboard layout. If I am using my custom keyboard layout (but not =
 when
 >>>>>>>> using the default keyboard layout), then when:
 >>>>>>>>
 >>>>>>>> - launching the 'drracket' executable,
 >>>>>>>> - opening the DrRacket application, or
 >>>>>>>> - using geiser in Emacs, compiling a file with '#lang slideshow' i=
 n
 >>>>>>>> it,
 >>>>>>>>
 >>>>>>>> Racket crashes immediately with the following error:
 >>>>>>>>
 >>>>>>>> integer->char: contract violation
 >>>>>>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >>>>>>>> #xD800 #xDFFF)))
 >>>>>>>>   given: 55357
 >>>>>>>>   context...:
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/co=
 coa/window.rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/co=
 coa/item.rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/co=
 coa/button.rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/co=
 coa/platform.rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/pl=
 atform.rkt:
 >>>>>>>> [running body]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kerne=
 l.rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.=
 rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rk=
 t:
 >>>>>>>> [traversing imports]
 >>>>>>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket=
 .rkt:
 >>>>>>>> [traversing imports]
 >>>>>>>>
 >>>>>>>> *** How to repeat:
 >>>>>>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 >>>>>>>> reproduce the problem on a virtual machine with a fresh install of=
  El
 >>>>>>>> Capitan 10.11.
 >>>>>>>>
 >>>>>>>> - Download my custom keyboard layout:
 >>>>>>>> https://drive.google.com/open?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>>>>>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard Layouts=
 ".
 >>>>>>>> - In System Preferences > Keyboard > Input Sources, add "My
 >>>>>>>> Keyboard Layout" as an input source.
 >>>>>>>> - Make sure the "Show Input menu in menu bar" checkbox is checked.
 >>>>>>>> - In the Input menu in the menu bar, select "My Keyboard Layout".
 >>>>>>>> - Launch DrRacket. It should crash (and provide the above error
 >>>>>>>> message if it was launched from the command line).
 >>>>>>>>
 >>>>>>>> *** Environment:
 >>>>>>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel
 >>>>>>>> Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~=
 1/RELEASE_X86_64
 >>>>>>>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>>>>>> Human Language: english
 >>>>>>>> (current-memory-use) 252260656
 >>>>>>>> raco pkg (show):
 >>>>>>>> Installation-wide:
 >>>>>>>>  Package            Checksum             Source
 >>>>>>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>>>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>>>>>  [189 auto-installed packages not shown]
 >>>>>>>> User-specific for installation "6.6":
 >>>>>>>>  [none]
 >>>>>>>>
 >>>>>>>>
 >>>>>>>>
 >>>>>>>> Collections:
 >>>>>>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>>>>>  (non-existent-path))
 >>>>>>>> ("/Applications/Racket v6.6/collects"
 >>>>>>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>>>>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "ra=
 cket"
 >>>>>>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"))
 >>>>>>>>
 >>>>>>>> Recent Internal Errors:
 >>>>>>>> Computer Language: (("Initial language" "No language chosen") #(#t
 >>>>>>>> print mixed-fraction-e #f #t debug))
 >>>>>>>>
 >>>>>>>>
 >>>>>>>
 >>>>>>>
 >>>>>>> --
 >>>>>>> --
 >>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>
 >>>>>>>
 >>>>>>
 >>>>>
 >>>>>
 >>>>> --
 >>>>> --
 >>>>> Jens Axel S=C3=B8gaard
 >>>>>
 >>>>>
 >>>>
 >>>
 >>>
 >>> --
 >>> --
 >>> Jens Axel S=C3=B8gaard
 >>>
 >>>
 >>
 >
 >
 > --
 > --
 > Jens Axel S=C3=B8gaard
 >
 >
 
 --001a114124a88358ed053c032535
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr"><div class=3D"markdown-here-wrapper" style=3D""><p style=
 =3D"margin:0px 0px 1.2em!important">Strangely, I get the following error (w=
 ith both my keyboard layout and the standard one):</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre;overflow:auto;border-radius:3px;border:1px solid rgb(204,204,=
 204);padding:0.5em 0.7em;display:block!important">i: undefined;
  cannot use before initialization
   context...:
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-t=
 ranslate.rkt:495:16: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-t=
 ranslate.rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-t=
 ranslate.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/windo=
 w.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/item.=
 rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/butto=
 n.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/platf=
 orm.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform.rk=
 t: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt: [t=
 raversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt: [tra=
 versing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [traversing =
 imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [traversing =
 imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [trave=
 rsing imports]
    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt: [tr=
 aversing imports]
 </code></pre><p style=3D"margin:0px 0px 1.2em!important">I am just getting =
 started with Racket so I don=E2=80=99t know why this would be=E2=80=94it lo=
 oks like <code style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,C=
 ourier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;b=
 order:1px solid rgb(234,234,234);border-radius:3px;display:inline;backgroun=
 d-color:rgb(248,248,248)">i</code> is introduced as a local binding to me. =
 Here is what my modified <code style=3D"font-size:0.85em;font-family:Consol=
 as,Inconsolata,Courier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-=
 space:pre-wrap;border:1px solid rgb(234,234,234);border-radius:3px;display:=
 inline;background-color:rgb(248,248,248)">key-translate</code> looks like:<=
 /p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre;overflow:auto;border-radius:3px;border:1px solid rgb(204,204,=
 204);padding:0.5em 0.7em;display:block!important">(define (key-translate vi=
 rtual-key-code
                        #:key-action            [key-action         kUCKeyAc=
 tionDown]
                        #:modifier-key-state    [modifier-key-state         =
        0]  ; no modifier
                        #:keyboard-type         [keyboard-type        (LMGet=
 KbdType)]
                        #:key-translate-options [key-translate-options      =
       #f]
                        #:dead-key-state        [dead-key-state             =
       #f]  ; no prev state
                        #:keyboard-layout       [layout-in                  =
  &#39;cached]) ; use cached
   (define actual-string-length (box 0))
   (set! key-translate-options
         (or key-translate-options                ; use user settings if pro=
 vided
             (if dead-key-state                   ; otherwise if user has se=
 t dead-key-state,
                 0                                ; then take dead-keys into=
  account
                 kUCKeyTranslateNoDeadKeysFlag))) ; else ignore dead keys
 
   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state)))
 
   (define layout
     (case layout-in
       ; use cached
       [(cached)    (cond
                     [cached-keyboard-layout =3D&gt; values]
                     [else   (set! cached-keyboard-layout (get-current-keybo=
 ard-layout))
                             cached-keyboard-layout])]
       ; refresh cache
       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-layo=
 ut))
                     cached-keyboard-layout]
       ; use provided
       [else          layout-in]))
 
   (UCKeyTranslate layout
                   virtual-key-code
                   key-action
                   (bitwise-and (&gt;&gt; modifier-key-state 8) #xFF)
                   keyboard-type
                   key-translate-options
                   dead-key-state
                   max-string-length
                   actual-string-length
                   output-chars)
   ; get the number of characters returned, and convert to string
   (define n (max 0 (min max-string-length (unbox actual-string-length))))
   (list-&gt;string (for/list ([i (in-range n)])
                   (define i (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 i #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char i)))))
 </code></pre><div title=3D"MDH:U3RyYW5nZWx5LCBJIGdldCB0aGUgZm9sbG93aW5nIGVy=
 cm9yICh3aXRoIGJvdGggbXkga2V5Ym9h
 cmQgbGF5b3V0IGFuZCB0aGUgc3RhbmRhcmQgb25lKTo8ZGl2Pjxicj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2PjxkaXY+PGRpdj5pOiB1bmRlZmluZWQ7PC9kaXY+PGRpdj4mbmJzcDtjYW5ub3QgdXNlIGJ=
 l
 Zm9yZSBpbml0aWFsaXphdGlvbjwvZGl2PjxkaXY+Jm5ic3A7IGNvbnRleHQuLi46PC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1=
 s
 aWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2xhdGUucmt0OjQ5NToxNjogZm9yLWx=
 v
 b3A8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJ=
 l
 L3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2Eva2V5LXRyYW5zbGF0ZS5ya3Q6NTU=
 1
 OjA6IGZvci1sb29wPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQ=
 g
 djYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2x=
 h
 dGUucmt0OiBbcnVubmluZyBib2R5XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGl=
 v
 bnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9=
 3
 aW5kb3cucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS9=
 3
 eC9jb2NvYS9pdGVtLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3B=
 y
 aXZhdGUvd3gvY29jb2EvYnV0dG9uLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl=
 2
 PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWx=
 p
 Yi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvcGxhdGZvcm0ucmt0OiBbdHJhdmVyc2luZyBpbXBvcnR=
 z
 XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmU=
 v
 cGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9wbGF0Zm9ybS5ya3Q6IFtydW5uaW5nIGJvZHl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL2tlcm5lbC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHN=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL21yZWQucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvbXJlZC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWI=
 v
 bXJlZC9tYWluLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJ=
 z
 cDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9yYWNrZXQvZ3V=
 p
 L2Jhc2Uucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9kcnJhY2tldC9kcnJhY2tldC9kcnJ=
 h
 Y2tldC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PC9kaXY+PGRpdj5gYGA8L2Rpdj4=
 8
 ZGl2Pjxicj48L2Rpdj48ZGl2PkkgYW0ganVzdCBnZXR0aW5nIHN0YXJ0ZWQgd2l0aCBSYWNrZXQ=
 g
 c28gSSBkb24ndCBrbm93IHdoeSB0aGlzIHdvdWxkIGJl4oCUaXQgbG9va3MgbGlrZSBgaWAgaXM=
 g
 aW50cm9kdWNlZCBhcyBhIGxvY2FsIGJpbmRpbmcgdG8gbWUuIEhlcmUgaXMgd2hhdCBteSBtb2R=
 p
 ZmllZCBga2V5LXRyYW5zbGF0ZWAgbG9va3MgbGlrZTo8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl=
 2
 PmBgYDwvZGl2PjxkaXY+PGRpdj4oZGVmaW5lIChrZXktdHJhbnNsYXRlIHZpcnR1YWwta2V5LWN=
 v
 ZGU8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzprZXktYWN0aW9uICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7W2tleS1hY3Rpb24gJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7IGtVQ0tleUFjdGlvbkRvd25dPC9kaXY+PGRpdj4mbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyM6bW9kaWZpZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDtbbW9kaWZ=
 p
 ZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDswXSAmbmJzcDs7IG5vIG1vZGlmaWVyPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyM6a2V5Ym9hcmQtdHlwZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 W2tleWJvYXJkLXR5cGUgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KExNR2V0S2JkVHlwZSl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyM6a2V5LXRyYW5zbGF0ZS1vcHR=
 p
 b25zIFtrZXktdHJhbnNsYXRlLW9wdGlvbnMgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsjZl08L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzpkZWF=
 k
 LWtleS1zdGF0ZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDtbZGVhZC1rZXktc3RhdGUgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgI2ZdICZuYnNwOzsgbm8gcHJldiBzdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsjOmtleWJvYXJkLWxheW91dCAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbbGF5b3V0LWl=
 u
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICdjYWNoZWRdKSA7IHVzZSBjYWNoZWQ8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGF=
 j
 dHVhbC1zdHJpbmctbGVuZ3RoIChib3ggMCkpPC9kaXY+PGRpdj4mbmJzcDsgKHNldCEga2V5LXR=
 y
 YW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKG9=
 y
 IGtleS10cmFuc2xhdGUtb3B0aW9ucyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyB1c2UgdXNlciBzZXR0aW5ncyBpZiBwcm92aWRlZDwvZGl=
 2
 PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGlmIGRlYWQ=
 t
 a2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7IDsgb3RoZXJ3aXNlIGlmIHVzZXIgaGFzIHNldCBkZWFkLWtleS1zdGF=
 0
 ZSw8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgMCAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDs7IHRoZW4gdGFrZSBkZWFkLWtleXMgaW50byBhY2NvdW50PC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IGt=
 V
 Q0tleVRyYW5zbGF0ZU5vRGVhZEtleXNGbGFnKSkpIDsgZWxzZSBpZ25vcmUgZGVhZCBrZXlzPC9=
 k
 aXY+PGRpdj48YnI+PC9kaXY+PGRpdj4mbmJzcDsgKHNldCEgZGVhZC1rZXktc3RhdGUgKG9yIGR=
 l
 YWQta2V5LXN0YXRlIChtYWtlLWluaXRpYWwtZGVhZC1rZXktc3RhdGUpKSk8L2Rpdj48ZGl2Pjx=
 i
 cj48L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGxheW91dDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnN=
 w
 OyAoY2FzZSBsYXlvdXQtaW48L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IDsgdXNlIGN=
 h
 Y2hlZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgWyhjYWNoZWQpICZuYnNwOyAmbmJ=
 z
 cDsoY29uZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IFtjYWNoZWQta2V5Ym9hcmQtbGF5b3V0ID0=
 m
 Z3Q7IHZhbHVlc108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbZWxzZSAmbmJzcDsgKHNldCEgY2F=
 j
 aGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V5Ym9hcmQtbGF5b3V0KSk8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgY2FjaGVkLWtleWJ=
 v
 YXJkLWxheW91dF0pXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyByZWZyZXNoIGN=
 h
 Y2hlPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyBbKCNmKSAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgKHNldCEgY2FjaGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V=
 5
 Ym9hcmQtbGF5b3V0KSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBjYWNoZWQta2V5Ym9hcmQtbGF=
 5
 b3V0XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyB1c2UgcHJvdmlkZWQ8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IFtlbHNlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDtsYXlvdXQtaW5dKSk8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl2PiZuYnNwOyAoVUN=
 L
 ZXlUcmFuc2xhdGUgbGF5b3V0PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyB2aXJ0dWFsLWtleS1jb2RlPC9kaXY=
 +
 PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyBrZXktYWN0aW9uPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAoYml0d2lzZS1hbmQgKCZndDs=
 m
 Z3Q7IG1vZGlmaWVyLWtleS1zdGF0ZSA4KSAjeEZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5Ym9hcmQ=
 t
 dHlwZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5LXRyYW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyBkZWFkLWtleS1zdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgbWF4LXN0cmluZy1sZW5ndGg8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7IGFjdHVhbC1zdHJpbmctbGVuZ3RoPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBvdXRwdXQtY2h=
 h
 cnMpPC9kaXY+PGRpdj4mbmJzcDsgOyBnZXQgdGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIHJldHV=
 y
 bmVkLCBhbmQgY29udmVydCB0byBzdHJpbmc8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIG4gKG1=
 h
 eCAwIChtaW4gbWF4LXN0cmluZy1sZW5ndGggKHVuYm94IGFjdHVhbC1zdHJpbmctbGVuZ3RoKSk=
 p
 KTwvZGl2PjxkaXY+Jm5ic3A7IChsaXN0LSZndDtzdHJpbmcgKGZvci9saXN0IChbaSAoaW4tcmF=
 u
 Z2UgbildKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGRlZmluZSBpIChwdHItcmVmIG91dHB1dC1jaGFycyB=
 f
 VW5pQ2hhciBpKSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IChpZiAoJmx0Oz0gJm5ic3A7I3hEODAwIGkgI3h=
 E
 RkZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAiIjwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAoaW50ZWdlci0mZ3Q7Y2hhciBpKSkpKSk8L2Rpdj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2Pg=3D=3D" style=3D"height:0;width:0;max-height:0;max-width:0;overflow:h=
 idden;font-size:0em;padding:0;margin:0">=E2=80=8B</div></div></div><div cla=
 ss=3D"gmail_extra"><br><div class=3D"gmail_quote">On Thu, Sep 8, 2016 at 9:=
 35 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensa=
 xel@soegaard.net" target=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wr=
 ote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border=
 -left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">Progress - so key-t=
 ranslate does get called.<br><br>The two last lines of key-translate are:<b=
 r><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/list ([i (in-range n)])=C2=
 =A0</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;char (ptr-ref output-chars _UniChar i)=
 ))))<br><br>Can you test what happens if you change it to:<br><br><div>=C2=
 =A0 =C2=A0 (list-&gt;string (for/list ([i (in-range n)])=C2=A0</div><div>=
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0(define i (ptr-ref output-chars _UniChar i))</div><=
 div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0(if (&lt;=3D=C2=A0<span style=3D"color:rgb(80,0,=
 80);font-size:12.8px">=C2=A0</span><span style=3D"color:rgb(80,0,80);font-s=
 ize:12.8px">#xD800 i #xDFFF)</span></div><div><span style=3D"color:rgb(80,0=
 ,80);font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 &quot;&quot;</s=
 pan></div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;char i))))=
 )<br><br>?</div><br></div></div><div class=3D"HOEnZb"><div class=3D"h5"><di=
 v class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 18:23 GMT=
 +02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@=
 gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><block=
 quote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc=
  solid;padding-left:1ex"><div dir=3D"ltr"><div><p style=3D"margin:0px 0px 1=
 .2em!important">It looks to me like the reason for this is that the <code s=
 tyle=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace=
 ;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid =
 rgb(234,234,234);border-radius:3px;display:inline;background-color:rgb(248,=
 248,248)">gui-lib</code> package (loaded for anything graphical, I presume,=
  including launching DrRacket) fills out a hash table for keyboard mappings=
  eagerly (on package load). The following is from line 551 of <code style=
 =3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;mar=
 gin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(=
 234,234,234);border-radius:3px;display:inline;background-color:rgb(248,248,=
 248)">/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/coc=
 oa/key-translate.<wbr>rkt</code>:</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">;; fill in hash tabl=
 es
 (for* ([modsyms all-modifier-combinations]                            ; go =
 through all physical key
        [(kvc n) virtual-key-code-name-to-value<wbr>-ht])                   =
 ; and modifier combinations
   (define modks (modifier-symbol-list-&gt;integer modsyms))
   (define s (key-translate n #:modifier-key-state modks))             ; tra=
 nslate to a char
   (unless (string=3D? s &quot;&quot;)                                      =
        ; unless key is dead
     (define c (string-ref s 0))
     (hash-set-new! char-to-osx-keycode+modifiers-<wbr>ht c                 =
 ; store where char is from
                    (list kvc n modsyms modks))                        ; (si=
 mplest is kept)
     (cond=20
       [(null? modsyms)                                               ; also=
 , if it is a main char
        (hash-set! char-to-main-char-key-ht c c)                       ;   s=
 tore it as such
        (hash-set! osx-keycode-to-main-char-key-h<wbr>t n c)]               =
 ;  =20
       [else
        (define mck (hash-ref osx-keycode-to-main-char-key-h<wbr>t n #f))   =
 ; otherwise find=20
        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;   a=
 nd store main char key
 </code></pre><div title=3D"MDH:SXQgbG9va3MgdG8gbWUgbGlrZSB0aGUgcmVhc29uIGZv=
 ciB0aGlzIGlzIHRoYXQgdGhlIGBndWkt
 bGliYCBwYWNrYWdlIChsb2FkZWQgZm9yIGFueXRoaW5nIGdyYXBoaWNhbCwgSSBwcmVzdW1lLCB=
 p
 bmNsdWRpbmcgbGF1bmNoaW5nIERyUmFja2V0KSBmaWxscyBvdXQgYSBoYXNoIHRhYmxlIGZvciB=
 r
 ZXlib2FyZCBtYXBwaW5ncyBlYWdlcmx5IChvbiBwYWNrYWdlIGxvYWQpLiBUaGUgZm9sbG93aW5=
 n
 IGlzIGZyb20gbGluZSA1NTEgb2YgYC9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJhbnNsYXRlLnJrdGA6PGRpdj4=
 8
 YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2PjxkaXY+OzsgZmlsbCBpbiBoYXNoIHRhYmxlczw=
 v
 ZGl2PjxkaXY+KGZvciogKFttb2RzeW1zIGFsbC1tb2RpZmllci1jb21iaW5hdGlvbnNdICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs7IGdvIHRocm91Z2ggYWxsIHBoeXN=
 p
 Y2FsIGtleTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7WyhrdmMgbikgdml=
 y
 dHVhbC1rZXktY29kZS1uYW1lLXRvLXZhbHVlLWh0XSkgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyBhbmQgbW9kaWZpZXIgY29=
 t
 YmluYXRpb25zPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBtb2RrcyAobW9kaWZpZXItc3ltYm9=
 s
 LWxpc3QtJmd0O2ludGVnZXIgbW9kc3ltcykpPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBzICh=
 r
 ZXktdHJhbnNsYXRlIG4gIzptb2RpZmllci1rZXktc3RhdGUgbW9ka3MpKSAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHRyYW5zbGF0ZSB0byBhIGNoYXI8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAodW5sZXNzIChzdHJpbmc9PyBzICIiKSAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgOyB1bmxlc3Mga2V5IGlzIGRlYWQ8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgKGRlZmluZSBjIChzdHJpbmctcmVmIHMgMCkpPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 IChoYXNoLXNldC1uZXchIGNoYXItdG8tb3N4LWtleWNvZGUrbW9kaWZpZXJzLWh0IGMgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHN0b3J=
 l
 IHdoZXJlIGNoYXIgaXMgZnJvbTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGxpc3Qga3ZjIG4gbW9=
 k
 c3ltcyBtb2RrcykpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyAoc2ltcGxlc3QgaXMga2V=
 w
 dCk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgKGNvbmQmbmJzcDs8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7IFsobnVsbD8gbW9kc3ltcykgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyA7IGFsc28sIGlmIGl0IGlzIGEgbWFpbiBjaGFyPC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsoaGFzaC1zZXQhIGNoYXItdG8tbWFpbi1jaGF=
 y
 LWtleS1odCBjIGMpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyAmbmJzcDsgc3RvcmUgaXQgYXMgc3V=
 j
 aDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGhhc2gtc2V0ISBvc3gta2V=
 5
 Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gYyldICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7ICZuYnNwOyZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgW2Vsc2U8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyh=
 k
 ZWZpbmUgbWNrIChoYXNoLXJlZiBvc3gta2V5Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gI2Y=
 p
 KSAmbmJzcDsgOyBvdGhlcndpc2UgZmluZCZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7KHdoZW4gbWNrIChoYXNoLXNldC1uZXchIGNoYXItdG8tbWFpbi1jaGFyLWt=
 l
 eS1odCBjIG1jaykpXSkpKSAmbmJzcDs7ICZuYnNwOyBhbmQgc3RvcmUgbWFpbiBjaGFyIGtleTw=
 v
 ZGl2PjwvZGl2PjxkaXY+YGBgPC9kaXY+" style=3D"min-height:0;width:0;max-height:=
 0;max-width:0;overflow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</=
 div></div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmai=
 l_quote">On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <span dir=
 =3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jen=
 saxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quot=
 e" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">=
 <div dir=3D"ltr"><div>That sounds as something that should work.</div>As fa=
 r as I know=C2=A0key-translate is only called when you actually press a key=
 .<br>So I am surprised that you see the error when DrRacket starts.<br><br>=
 I&#39;ll need to look up Ukelele.<span><font color=3D"#888888"><br><br>/Jen=
 s Axel<br><div><div><br></div><div><br></div></div></font></span></div><div=
 ><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 =
 18:11 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:ra=
 don.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<=
 br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left=
 :1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">It&#39;s not intentional=
 ly. Perhaps they are an artifact created by Ukelele. Is there an easy way t=
 o determine which key is producing the surrogate code point(s)?<div><br></d=
 iv><div>The first thing I think of is the dead keys used for creating accen=
 ts in OS X, but these are also present in the default keyboard layout. The =
 only thing I have done with them is move the Alt+E dead key to Alt+Shift+`.=
 </div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_qu=
 ote">On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <span dir=3D"lt=
 r">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@=
 soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" sty=
 le=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div d=
 ir=3D"ltr"><span style=3D"font-size:12.8px">Here is what I have so far:</sp=
 an><div><span style=3D"font-size:12.8px"><br></span></div><div>1) integer-&=
 gt;char is being called with an input that aren&#39;t accepted</div><div>2)=
  the caller is=C2=A0<span style=3D"color:rgb(51,51,51);font-family:consolas=
 ,&quot;liberation mono&quot;,menlo,courier,monospace;font-size:12px;line-he=
 ight:20px;white-space:pre-wrap">key-translate </span>a low level function w=
 hose job</div><div>=C2=A0 =C2=A0 is to translate (physical) keycodes into c=
 haracters using=C2=A0</div><div>=C2=A0 =C2=A0 a keyboard layout.=C2=A0</div=
 ><div>3) it is a bug in key-translate that integer-&gt;char is called with<=
 /div><div>=C2=A0 =C2=A0 an integer that doesn&#39;t correspond to a charact=
 er</div><div><br></div><div>4) From=C2=A0</div><div><span><span style=3D"fo=
 nt-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 integer-&gt;char: contra=
 ct violation</span><br style=3D"font-size:12.8px"><span style=3D"font-size:=
 12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 expected: (and/c (integer-in 0 #=
 x10FFFF) (not/c (integer-in #xD800 #xDFFF)))</span><br style=3D"font-size:1=
 2.8px"><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 given: 55357<br></span></span>=C2=A0 =C2=A0 we learn that the operating sys=
 tem translated a keycode to the codepoint=C2=A0<span style=3D"font-size:12.=
 8px">55357.</span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0=
  That code point lies in the range D800 to DFFF which are not accepted by</=
 span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 integer-&gt;=
 char</span></div><div><span style=3D"font-size:12.8px">5) That range is cal=
 led &quot;High Surrogates&quot;=C2=A0</span></div><div><span style=3D"font-=
 size:12.8px">=C2=A0 =C2=A0 From=C2=A0</span><span style=3D"font-size:12.8px=
 "><a href=3D"http://www.alanwood.net/unicode/high_surrogates.html" target=
 =3D"_blank">http://www.alanwood.net/u<wbr>nicode/high_surrogates.html</a><b=
 r></span><span style=3D"font-size:12.8px"><br></span><span style=3D"color:r=
 gb(0,0,0);font-family:times;font-size:16px;line-height:19.2px;background-co=
 lor:rgb(255,255,242)">Surrogate code points are intended to allow mapping o=
 f additional character planes into the 16-bit Unicode system, thus allowing=
  more than 65,536 characters to be represented. The individual surrogate co=
 de points do not represent characters; they are intended to be used in pair=
 s, a high code point followed by a low code point, to stand in for a charac=
 ter in one of the supplementary planes. Their use is restricted to UTF-16. =
 They can be used for characters in=C2=A0</span><a href=3D"http://www.alanwo=
 od.net/unicode/linear_b_syllabary.html" style=3D"color:rgb(128,0,128);font-=
 family:times;font-size:16px;line-height:19.2px;background-color:rgb(255,255=
 ,242)" target=3D"_blank">Linear B Syllabary</a><span style=3D"color:rgb(0,0=
 ,0);font-family:times;font-size:16px;line-height:19.2px;background-color:rg=
 b(255,255,242)">=C2=A0and higher-numbered ranges.<br></span></div><div><spa=
 n style=3D"font-size:12.8px"><br></span></div><div><br></div><div>Is it int=
 entionally that your layout produces such code points?</div><span><font col=
 or=3D"#888888"><div><br></div><div>/Jens Axel</div><div><br></div><div><br>=
 </div></font></span></div><div><div><div class=3D"gmail_extra"><br><div cla=
 ss=3D"gmail_quote">2016-09-08 17:50 GMT+02:00 Radon Rosborough <span dir=3D=
 "ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.n=
 eon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D=
 "margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D=
 "ltr">Before. If I switch after I launch DrRacket, it appears to work OK, a=
 lthough I haven&#39;t tried anything substantial to make sure everything wo=
 rks.</div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quot=
 e">On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr"=
 >&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@so=
 egaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=
 =3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=
 =3D"ltr">Did you switch to your keyboard layout before or after starting Dr=
 Racket?<div><br></div><div>/Jens Axel</div><div><br></div></div><div class=
 =3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:32 GMT+02:00 =
  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_b=
 lank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_qu=
 ote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex=
 ">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 
 --001a114124a88358ed053c032535--
From: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
To: Radon Rosborough <radon.neon@gmail.com>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 20:33:27 +0200

 --001a114369260e25b6053c0344cb
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 Sorry. I missed that i was used in for/list.
 Try:
 
 (list->string (for/list ([i (in-range n)]) (define j (ptr-ref output-chars
 _UniChar i)) (if (<=3D #xD800 j #xDFFF) "" (integer->char j)))))
 
 2016-09-08 20:24 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 
 > Strangely, I get the following error (with both my keyboard layout and th=
 e
 > standard one):
 >
 > i: undefined;
 >  cannot use before initialization
 >   context...:
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt:495:16: for-loop
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt:555:0: for-loop
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt: [running body]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/win=
 dow.rkt: [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ite=
 m.rkt: [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/but=
 ton.rkt: [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/pla=
 tform.rkt: [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform.=
 rkt: [running body]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt: =
 [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt: [t=
 raversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [traversin=
 g imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [traversin=
 g imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [tra=
 versing imports]
 >    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt: [=
 traversing imports]
 >
 > I am just getting started with Racket so I don=E2=80=99t know why this wo=
 uld be=E2=80=94it
 > looks like i is introduced as a local binding to me. Here is what my
 > modified key-translate looks like:
 >
 > (define (key-translate virtual-key-code
 >                        #:key-action            [key-action         kUCKey=
 ActionDown]
 >                        #:modifier-key-state    [modifier-key-state       =
          0]  ; no modifier
 >                        #:keyboard-type         [keyboard-type        (LMG=
 etKbdType)]
 >                        #:key-translate-options [key-translate-options    =
         #f]
 >                        #:dead-key-state        [dead-key-state           =
         #f]  ; no prev state
 >                        #:keyboard-layout       [layout-in                =
    'cached]) ; use cached
 >   (define actual-string-length (box 0))
 >   (set! key-translate-options
 >         (or key-translate-options                ; use user settings if p=
 rovided
 >             (if dead-key-state                   ; otherwise if user has =
 set dead-key-state,
 >                 0                                ; then take dead-keys in=
 to account
 >                 kUCKeyTranslateNoDeadKeysFlag))) ; else ignore dead keys
 >
 >   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state)))
 >
 >   (define layout
 >     (case layout-in
 >       ; use cached
 >       [(cached)    (cond
 >                     [cached-keyboard-layout =3D> values]
 >                     [else   (set! cached-keyboard-layout (get-current-key=
 board-layout))
 >                             cached-keyboard-layout])]
 >       ; refresh cache
 >       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-la=
 yout))
 >                     cached-keyboard-layout]
 >       ; use provided
 >       [else          layout-in]))
 >
 >   (UCKeyTranslate layout
 >                   virtual-key-code
 >                   key-action
 >                   (bitwise-and (>> modifier-key-state 8) #xFF)
 >                   keyboard-type
 >                   key-translate-options
 >                   dead-key-state
 >                   max-string-length
 >                   actual-string-length
 >                   output-chars)
 >   ; get the number of characters returned, and convert to string
 >   (define n (max 0 (min max-string-length (unbox actual-string-length))))
 >   (list->string (for/list ([i (in-range n)])
 >                   (define i (ptr-ref output-chars _UniChar i))
 >                   (if (<=3D  #xD800 i #xDFFF)
 >                       ""
 >                       (integer->char i)))))
 >
 > =E2=80=8B
 >
 > On Thu, Sep 8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard=
 .net>
 > wrote:
 >
 >> Progress - so key-translate does get called.
 >>
 >> The two last lines of key-translate are:
 >>
 >>     (list->string (for/list ([i (in-range n)])
 >>                        (integer->char (ptr-ref output-chars _UniChar
 >> i)))))
 >>
 >> Can you test what happens if you change it to:
 >>
 >>     (list->string (for/list ([i (in-range n)])
 >>                            (define i (ptr-ref output-chars _UniChar i))
 >>                            (if (<=3D  #xD800 i #xDFFF)
 >>                                 ""
 >>                                (integer->char i)))))
 >>
 >> ?
 >>
 >>
 >> 2016-09-08 18:23 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>
 >>> It looks to me like the reason for this is that the gui-lib package
 >>> (loaded for anything graphical, I presume, including launching DrRacket=
 )
 >>> fills out a hash table for keyboard mappings eagerly (on package load).=
  The
 >>> following is from line 551 of /Applications/Racket
 >>> v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 >>>
 >>> ;; fill in hash tables
 >>> (for* ([modsyms all-modifier-combinations]                            ;=
  go through all physical key
 >>>        [(kvc n) virtual-key-code-name-to-value-ht])                   ;=
  and modifier combinations
 >>>   (define modks (modifier-symbol-list->integer modsyms))
 >>>   (define s (key-translate n #:modifier-key-state modks))             ;=
  translate to a char
 >>>   (unless (string=3D? s "")                                            =
  ; unless key is dead
 >>>     (define c (string-ref s 0))
 >>>     (hash-set-new! char-to-osx-keycode+modifiers-ht c                 ;=
  store where char is from
 >>>                    (list kvc n modsyms modks))                        ;=
  (simplest is kept)
 >>>     (cond
 >>>       [(null? modsyms)                                               ; =
 also, if it is a main char
 >>>        (hash-set! char-to-main-char-key-ht c c)                       ;=
    store it as such
 >>>        (hash-set! osx-keycode-to-main-char-key-ht n c)]               ;
 >>>       [else
 >>>        (define mck (hash-ref osx-keycode-to-main-char-key-ht n #f))   ;=
  otherwise find
 >>>        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;=
    and store main char key
 >>>
 >>> =E2=80=8B
 >>>
 >>> On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaa=
 rd.net
 >>> > wrote:
 >>>
 >>>> That sounds as something that should work.
 >>>> As far as I know key-translate is only called when you actually press =
 a
 >>>> key.
 >>>> So I am surprised that you see the error when DrRacket starts.
 >>>>
 >>>> I'll need to look up Ukelele.
 >>>>
 >>>> /Jens Axel
 >>>>
 >>>>
 >>>>
 >>>> 2016-09-08 18:11 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>
 >>>>> It's not intentionally. Perhaps they are an artifact created by
 >>>>> Ukelele. Is there an easy way to determine which key is producing the
 >>>>> surrogate code point(s)?
 >>>>>
 >>>>> The first thing I think of is the dead keys used for creating accents
 >>>>> in OS X, but these are also present in the default keyboard layout. T=
 he
 >>>>> only thing I have done with them is move the Alt+E dead key to Alt+Sh=
 ift+`.
 >>>>>
 >>>>> On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <
 >>>>> jensaxel@soegaard.net> wrote:
 >>>>>
 >>>>>> Here is what I have so far:
 >>>>>>
 >>>>>> 1) integer->char is being called with an input that aren't accepted
 >>>>>> 2) the caller is key-translate a low level function whose job
 >>>>>>     is to translate (physical) keycodes into characters using
 >>>>>>     a keyboard layout.
 >>>>>> 3) it is a bug in key-translate that integer->char is called with
 >>>>>>     an integer that doesn't correspond to a character
 >>>>>>
 >>>>>> 4) From
 >>>>>>           integer->char: contract violation
 >>>>>>           expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-i=
 n
 >>>>>> #xD800 #xDFFF)))
 >>>>>>           given: 55357
 >>>>>>     we learn that the operating system translated a keycode to the
 >>>>>> codepoint 55357.
 >>>>>>     That code point lies in the range D800 to DFFF which are not
 >>>>>> accepted by
 >>>>>>     integer->char
 >>>>>> 5) That range is called "High Surrogates"
 >>>>>>     From http://www.alanwood.net/unicode/high_surrogates.html
 >>>>>>
 >>>>>> Surrogate code points are intended to allow mapping of additional
 >>>>>> character planes into the 16-bit Unicode system, thus allowing more =
 than
 >>>>>> 65,536 characters to be represented. The individual surrogate code p=
 oints
 >>>>>> do not represent characters; they are intended to be used in pairs, =
 a high
 >>>>>> code point followed by a low code point, to stand in for a character=
  in one
 >>>>>> of the supplementary planes. Their use is restricted to UTF-16. They=
  can be
 >>>>>> used for characters in Linear B Syllabary
 >>>>>> <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 >>>>>> higher-numbered ranges.
 >>>>>>
 >>>>>>
 >>>>>> Is it intentionally that your layout produces such code points?
 >>>>>>
 >>>>>> /Jens Axel
 >>>>>>
 >>>>>>
 >>>>>>
 >>>>>> 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>>>
 >>>>>>> Before. If I switch after I launch DrRacket, it appears to work OK,
 >>>>>>> although I haven't tried anything substantial to make sure everythi=
 ng works.
 >>>>>>>
 >>>>>>> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <
 >>>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>>
 >>>>>>>> Did you switch to your keyboard layout before or after starting
 >>>>>>>> DrRacket?
 >>>>>>>>
 >>>>>>>> /Jens Axel
 >>>>>>>>
 >>>>>>>>
 >>>>>>>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>>>>>>
 >>>>>>>>> A new problem report is waiting at
 >>>>>>>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>>>>>>
 >>>>>>>>> Reported by Radon Rosborough for release: 6.6
 >>>>>>>>>
 >>>>>>>>> *** Description:
 >>>>>>>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>>>>>>> keyboard layout. If I am using my custom keyboard layout (but not=
  when
 >>>>>>>>> using the default keyboard layout), then when:
 >>>>>>>>>
 >>>>>>>>> - launching the 'drracket' executable,
 >>>>>>>>> - opening the DrRacket application, or
 >>>>>>>>> - using geiser in Emacs, compiling a file with '#lang slideshow'
 >>>>>>>>> in it,
 >>>>>>>>>
 >>>>>>>>> Racket crashes immediately with the following error:
 >>>>>>>>>
 >>>>>>>>> integer->char: contract violation
 >>>>>>>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >>>>>>>>> #xD800 #xDFFF)))
 >>>>>>>>>   given: 55357
 >>>>>>>>>   context...:
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/c=
 ocoa/window.rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/c=
 ocoa/item.rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/c=
 ocoa/button.rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/c=
 ocoa/platform.rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/p=
 latform.rkt:
 >>>>>>>>> [running body]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kern=
 el.rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred=
 .rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.r=
 kt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracke=
 t.rkt:
 >>>>>>>>> [traversing imports]
 >>>>>>>>>
 >>>>>>>>> *** How to repeat:
 >>>>>>>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also
 >>>>>>>>> reproduce the problem on a virtual machine with a fresh install o=
 f El
 >>>>>>>>> Capitan 10.11.
 >>>>>>>>>
 >>>>>>>>> - Download my custom keyboard layout:
 >>>>>>>>> https://drive.google.com/open?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>>>>>>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard
 >>>>>>>>> Layouts".
 >>>>>>>>> - In System Preferences > Keyboard > Input Sources, add "My
 >>>>>>>>> Keyboard Layout" as an input source.
 >>>>>>>>> - Make sure the "Show Input menu in menu bar" checkbox is checked=
 .
 >>>>>>>>> - In the Input menu in the menu bar, select "My Keyboard Layout".
 >>>>>>>>> - Launch DrRacket. It should crash (and provide the above error
 >>>>>>>>> message if it was launched from the command line).
 >>>>>>>>>
 >>>>>>>>> *** Environment:
 >>>>>>>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel
 >>>>>>>>> Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11=
 ~1/RELEASE_X86_64
 >>>>>>>>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>>>>>>> Human Language: english
 >>>>>>>>> (current-memory-use) 252260656
 >>>>>>>>> raco pkg (show):
 >>>>>>>>> Installation-wide:
 >>>>>>>>>  Package            Checksum             Source
 >>>>>>>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>>>>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>>>>>>  [189 auto-installed packages not shown]
 >>>>>>>>> User-specific for installation "6.6":
 >>>>>>>>>  [none]
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>> Collections:
 >>>>>>>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>>>>>>  (non-existent-path))
 >>>>>>>>> ("/Applications/Racket v6.6/collects"
 >>>>>>>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>>>>>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "r=
 acket"
 >>>>>>>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml")=
 )
 >>>>>>>>>
 >>>>>>>>> Recent Internal Errors:
 >>>>>>>>> Computer Language: (("Initial language" "No language chosen") #(#=
 t
 >>>>>>>>> print mixed-fraction-e #f #t debug))
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>
 >>>>>>>>
 >>>>>>>> --
 >>>>>>>> --
 >>>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>>
 >>>>>>>>
 >>>>>>>
 >>>>>>
 >>>>>>
 >>>>>> --
 >>>>>> --
 >>>>>> Jens Axel S=C3=B8gaard
 >>>>>>
 >>>>>>
 >>>>>
 >>>>
 >>>>
 >>>> --
 >>>> --
 >>>> Jens Axel S=C3=B8gaard
 >>>>
 >>>>
 >>>
 >>
 >>
 >> --
 >> --
 >> Jens Axel S=C3=B8gaard
 >>
 >>
 >
 
 
 --=20
 --=20
 Jens Axel S=C3=B8gaard
 
 --001a114369260e25b6053c0344cb
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr">Sorry. I missed that i was used in for/list.<div>Try:<br><=
 div><br></div><div><span style=3D"font-family:consolas,inconsolata,courier,=
 monospace;font-size:10.88px;line-height:15.36px;white-space:pre-wrap;backgr=
 ound-color:rgb(248,248,248)">(list-&gt;string (for/list ([i (in-range n)])
                   (define j (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 j #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char j)))))</span><br></div></div></div>=
 <div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 20:24 =
 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.ne=
 on@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br><bl=
 ockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #=
 ccc solid;padding-left:1ex"><div dir=3D"ltr"><div><p style=3D"margin:0px 0p=
 x 1.2em!important">Strangely, I get the following error (with both my keybo=
 ard layout and the standard one):</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">i: undefined;
  cannot use before initialization
   context...:
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 key-<wbr>translate.rkt:495:16: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 key-<wbr>translate.rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 key-<wbr>translate.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 window.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 item.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 button.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 platform.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/platfo=
 rm.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/kernel.rk=
 t: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/mred.rkt:=
  [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>mred.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>main.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/<wbr>racket/gui/base.rkt: [=
 traversing imports]
    /Applications/Racket v6.6/share/pkgs/drracket/<wbr>drracket/drracket.rkt=
 : [traversing imports]
 </code></pre><p style=3D"margin:0px 0px 1.2em!important">I am just getting =
 started with Racket so I don=E2=80=99t know why this would be=E2=80=94it lo=
 oks like <code style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,C=
 ourier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;b=
 order:1px solid rgb(234,234,234);border-radius:3px;display:inline;backgroun=
 d-color:rgb(248,248,248)">i</code> is introduced as a local binding to me. =
 Here is what my modified <code style=3D"font-size:0.85em;font-family:Consol=
 as,Inconsolata,Courier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-=
 space:pre-wrap;border:1px solid rgb(234,234,234);border-radius:3px;display:=
 inline;background-color:rgb(248,248,248)">key-translate</code> looks like:<=
 /p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">(define (key-transla=
 te virtual-key-code
                        #:key-action            [key-action         kUCKeyAc=
 tionDown]
                        #:modifier-key-state    [modifier-key-state         =
        0]  ; no modifier
                        #:keyboard-type         [keyboard-type        (LMGet=
 KbdType)]
                        #:key-translate-options [key-translate-options      =
       #f]
                        #:dead-key-state        [dead-key-state             =
       #f]  ; no prev state
                        #:keyboard-layout       [layout-in                  =
  &#39;cached]) ; use cached
   (define actual-string-length (box 0))
   (set! key-translate-options
         (or key-translate-options                ; use user settings if pro=
 vided
             (if dead-key-state                   ; otherwise if user has se=
 t dead-key-state,
                 0                                ; then take dead-keys into=
  account
                 kUCKeyTranslateNoDeadKeysFlag)<wbr>)) ; else ignore dead ke=
 ys
 
   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state))<wb=
 r>)
 
   (define layout
     (case layout-in
       ; use cached
       [(cached)    (cond
                     [cached-keyboard-layout =3D&gt; values]
                     [else   (set! cached-keyboard-layout (get-current-keybo=
 ard-layout))
                             cached-keyboard-layout])]
       ; refresh cache
       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-layo=
 ut))
                     cached-keyboard-layout]
       ; use provided
       [else          layout-in]))
 
   (UCKeyTranslate layout
                   virtual-key-code
                   key-action
                   (bitwise-and (&gt;&gt; modifier-key-state 8) #xFF)
                   keyboard-type
                   key-translate-options
                   dead-key-state
                   max-string-length
                   actual-string-length
                   output-chars)
   ; get the number of characters returned, and convert to string
   (define n (max 0 (min max-string-length (unbox actual-string-length))))
   (list-&gt;string (for/list ([i (in-range n)])
                   (define i (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 i #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char i)))))
 </code></pre><div title=3D"MDH:U3RyYW5nZWx5LCBJIGdldCB0aGUgZm9sbG93aW5nIGVy=
 cm9yICh3aXRoIGJvdGggbXkga2V5Ym9h
 cmQgbGF5b3V0IGFuZCB0aGUgc3RhbmRhcmQgb25lKTo8ZGl2Pjxicj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2PjxkaXY+PGRpdj5pOiB1bmRlZmluZWQ7PC9kaXY+PGRpdj4mbmJzcDtjYW5ub3QgdXNlIGJ=
 l
 Zm9yZSBpbml0aWFsaXphdGlvbjwvZGl2PjxkaXY+Jm5ic3A7IGNvbnRleHQuLi46PC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1=
 s
 aWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2xhdGUucmt0OjQ5NToxNjogZm9yLWx=
 v
 b3A8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJ=
 l
 L3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2Eva2V5LXRyYW5zbGF0ZS5ya3Q6NTU=
 1
 OjA6IGZvci1sb29wPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQ=
 g
 djYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2x=
 h
 dGUucmt0OiBbcnVubmluZyBib2R5XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGl=
 v
 bnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9=
 3
 aW5kb3cucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS9=
 3
 eC9jb2NvYS9pdGVtLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3B=
 y
 aXZhdGUvd3gvY29jb2EvYnV0dG9uLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl=
 2
 PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWx=
 p
 Yi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvcGxhdGZvcm0ucmt0OiBbdHJhdmVyc2luZyBpbXBvcnR=
 z
 XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmU=
 v
 cGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9wbGF0Zm9ybS5ya3Q6IFtydW5uaW5nIGJvZHl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL2tlcm5lbC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHN=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL21yZWQucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvbXJlZC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWI=
 v
 bXJlZC9tYWluLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJ=
 z
 cDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9yYWNrZXQvZ3V=
 p
 L2Jhc2Uucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9kcnJhY2tldC9kcnJhY2tldC9kcnJ=
 h
 Y2tldC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PC9kaXY+PGRpdj5gYGA8L2Rpdj4=
 8
 ZGl2Pjxicj48L2Rpdj48ZGl2PkkgYW0ganVzdCBnZXR0aW5nIHN0YXJ0ZWQgd2l0aCBSYWNrZXQ=
 g
 c28gSSBkb24ndCBrbm93IHdoeSB0aGlzIHdvdWxkIGJl4oCUaXQgbG9va3MgbGlrZSBgaWAgaXM=
 g
 aW50cm9kdWNlZCBhcyBhIGxvY2FsIGJpbmRpbmcgdG8gbWUuIEhlcmUgaXMgd2hhdCBteSBtb2R=
 p
 ZmllZCBga2V5LXRyYW5zbGF0ZWAgbG9va3MgbGlrZTo8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl=
 2
 PmBgYDwvZGl2PjxkaXY+PGRpdj4oZGVmaW5lIChrZXktdHJhbnNsYXRlIHZpcnR1YWwta2V5LWN=
 v
 ZGU8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzprZXktYWN0aW9uICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7W2tleS1hY3Rpb24gJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7IGtVQ0tleUFjdGlvbkRvd25dPC9kaXY+PGRpdj4mbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyM6bW9kaWZpZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDtbbW9kaWZ=
 p
 ZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDswXSAmbmJzcDs7IG5vIG1vZGlmaWVyPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyM6a2V5Ym9hcmQtdHlwZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 W2tleWJvYXJkLXR5cGUgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KExNR2V0S2JkVHlwZSl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyM6a2V5LXRyYW5zbGF0ZS1vcHR=
 p
 b25zIFtrZXktdHJhbnNsYXRlLW9wdGlvbnMgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsjZl08L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzpkZWF=
 k
 LWtleS1zdGF0ZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDtbZGVhZC1rZXktc3RhdGUgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgI2ZdICZuYnNwOzsgbm8gcHJldiBzdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsjOmtleWJvYXJkLWxheW91dCAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbbGF5b3V0LWl=
 u
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICdjYWNoZWRdKSA7IHVzZSBjYWNoZWQ8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGF=
 j
 dHVhbC1zdHJpbmctbGVuZ3RoIChib3ggMCkpPC9kaXY+PGRpdj4mbmJzcDsgKHNldCEga2V5LXR=
 y
 YW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKG9=
 y
 IGtleS10cmFuc2xhdGUtb3B0aW9ucyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyB1c2UgdXNlciBzZXR0aW5ncyBpZiBwcm92aWRlZDwvZGl=
 2
 PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGlmIGRlYWQ=
 t
 a2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7IDsgb3RoZXJ3aXNlIGlmIHVzZXIgaGFzIHNldCBkZWFkLWtleS1zdGF=
 0
 ZSw8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgMCAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDs7IHRoZW4gdGFrZSBkZWFkLWtleXMgaW50byBhY2NvdW50PC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IGt=
 V
 Q0tleVRyYW5zbGF0ZU5vRGVhZEtleXNGbGFnKSkpIDsgZWxzZSBpZ25vcmUgZGVhZCBrZXlzPC9=
 k
 aXY+PGRpdj48YnI+PC9kaXY+PGRpdj4mbmJzcDsgKHNldCEgZGVhZC1rZXktc3RhdGUgKG9yIGR=
 l
 YWQta2V5LXN0YXRlIChtYWtlLWluaXRpYWwtZGVhZC1rZXktc3RhdGUpKSk8L2Rpdj48ZGl2Pjx=
 i
 cj48L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGxheW91dDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnN=
 w
 OyAoY2FzZSBsYXlvdXQtaW48L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IDsgdXNlIGN=
 h
 Y2hlZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgWyhjYWNoZWQpICZuYnNwOyAmbmJ=
 z
 cDsoY29uZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IFtjYWNoZWQta2V5Ym9hcmQtbGF5b3V0ID0=
 m
 Z3Q7IHZhbHVlc108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbZWxzZSAmbmJzcDsgKHNldCEgY2F=
 j
 aGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V5Ym9hcmQtbGF5b3V0KSk8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgY2FjaGVkLWtleWJ=
 v
 YXJkLWxheW91dF0pXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyByZWZyZXNoIGN=
 h
 Y2hlPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyBbKCNmKSAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgKHNldCEgY2FjaGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V=
 5
 Ym9hcmQtbGF5b3V0KSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBjYWNoZWQta2V5Ym9hcmQtbGF=
 5
 b3V0XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyB1c2UgcHJvdmlkZWQ8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IFtlbHNlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDtsYXlvdXQtaW5dKSk8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl2PiZuYnNwOyAoVUN=
 L
 ZXlUcmFuc2xhdGUgbGF5b3V0PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyB2aXJ0dWFsLWtleS1jb2RlPC9kaXY=
 +
 PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyBrZXktYWN0aW9uPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAoYml0d2lzZS1hbmQgKCZndDs=
 m
 Z3Q7IG1vZGlmaWVyLWtleS1zdGF0ZSA4KSAjeEZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5Ym9hcmQ=
 t
 dHlwZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5LXRyYW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyBkZWFkLWtleS1zdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgbWF4LXN0cmluZy1sZW5ndGg8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7IGFjdHVhbC1zdHJpbmctbGVuZ3RoPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBvdXRwdXQtY2h=
 h
 cnMpPC9kaXY+PGRpdj4mbmJzcDsgOyBnZXQgdGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIHJldHV=
 y
 bmVkLCBhbmQgY29udmVydCB0byBzdHJpbmc8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIG4gKG1=
 h
 eCAwIChtaW4gbWF4LXN0cmluZy1sZW5ndGggKHVuYm94IGFjdHVhbC1zdHJpbmctbGVuZ3RoKSk=
 p
 KTwvZGl2PjxkaXY+Jm5ic3A7IChsaXN0LSZndDtzdHJpbmcgKGZvci9saXN0IChbaSAoaW4tcmF=
 u
 Z2UgbildKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGRlZmluZSBpIChwdHItcmVmIG91dHB1dC1jaGFycyB=
 f
 VW5pQ2hhciBpKSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IChpZiAoJmx0Oz0gJm5ic3A7I3hEODAwIGkgI3h=
 E
 RkZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAiIjwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAoaW50ZWdlci0mZ3Q7Y2hhciBpKSkpKSk8L2Rpdj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2Pg=3D=3D" style=3D"min-height:0;width:0;max-height:0;max-width:0;overfl=
 ow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</div></div></div><div=
  class=3D"HOEnZb"><div class=3D"h5"><div class=3D"gmail_extra"><br><div cla=
 ss=3D"gmail_quote">On Thu, Sep 8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <=
 span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_bl=
 ank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gm=
 ail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-le=
 ft:1ex"><div dir=3D"ltr">Progress - so key-translate does get called.<br><b=
 r>The two last lines of key-translate are:<br><br><div>=C2=A0 =C2=A0 (list-=
 &gt;string (for/list ([i (in-range n)])=C2=A0</div><div>=C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-=
 &gt;char (ptr-ref output-chars _UniChar i)))))<br><br>Can you test what hap=
 pens if you change it to:<br><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/l=
 ist ([i (in-range n)])=C2=A0</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(define i (pt=
 r-ref output-chars _UniChar i))</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(if (&lt;=
 =3D=C2=A0<span style=3D"color:rgb(80,0,80);font-size:12.8px">=C2=A0</span><=
 span style=3D"color:rgb(80,0,80);font-size:12.8px">#xD800 i #xDFFF)</span><=
 /div><div><span style=3D"color:rgb(80,0,80);font-size:12.8px">=C2=A0 =C2=A0=
  =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 &quot;&quot;</span></div><div>=C2=A0 =C2=A0 =C2=A0=
  =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0(integer-&gt;char i)))))<br><br>?</div><br></div></div><di=
 v><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08=
  18:23 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:r=
 adon.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:=
 <br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-lef=
 t:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr"><div><p style=3D"margin=
 :0px 0px 1.2em!important">It looks to me like the reason for this is that t=
 he <code style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier=
 ,monospace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;border:=
 1px solid rgb(234,234,234);border-radius:3px;display:inline;background-colo=
 r:rgb(248,248,248)">gui-lib</code> package (loaded for anything graphical, =
 I presume, including launching DrRacket) fills out a hash table for keyboar=
 d mappings eagerly (on package load). The following is from line 551 of <co=
 de style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monos=
 pace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px so=
 lid rgb(234,234,234);border-radius:3px;display:inline;background-color:rgb(=
 248,248,248)">/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivat=
 e/wx/cocoa/key-translate.<wbr>rkt</code>:</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">;; fill in hash tabl=
 es
 (for* ([modsyms all-modifier-combinations]                            ; go =
 through all physical key
        [(kvc n) virtual-key-code-name-to-value<wbr>-ht])                   =
 ; and modifier combinations
   (define modks (modifier-symbol-list-&gt;integer modsyms))
   (define s (key-translate n #:modifier-key-state modks))             ; tra=
 nslate to a char
   (unless (string=3D? s &quot;&quot;)                                      =
        ; unless key is dead
     (define c (string-ref s 0))
     (hash-set-new! char-to-osx-keycode+modifiers-<wbr>ht c                 =
 ; store where char is from
                    (list kvc n modsyms modks))                        ; (si=
 mplest is kept)
     (cond=20
       [(null? modsyms)                                               ; also=
 , if it is a main char
        (hash-set! char-to-main-char-key-ht c c)                       ;   s=
 tore it as such
        (hash-set! osx-keycode-to-main-char-key-h<wbr>t n c)]               =
 ;  =20
       [else
        (define mck (hash-ref osx-keycode-to-main-char-key-h<wbr>t n #f))   =
 ; otherwise find=20
        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;   a=
 nd store main char key
 </code></pre><div title=3D"MDH:SXQgbG9va3MgdG8gbWUgbGlrZSB0aGUgcmVhc29uIGZv=
 ciB0aGlzIGlzIHRoYXQgdGhlIGBndWkt
 bGliYCBwYWNrYWdlIChsb2FkZWQgZm9yIGFueXRoaW5nIGdyYXBoaWNhbCwgSSBwcmVzdW1lLCB=
 p
 bmNsdWRpbmcgbGF1bmNoaW5nIERyUmFja2V0KSBmaWxscyBvdXQgYSBoYXNoIHRhYmxlIGZvciB=
 r
 ZXlib2FyZCBtYXBwaW5ncyBlYWdlcmx5IChvbiBwYWNrYWdlIGxvYWQpLiBUaGUgZm9sbG93aW5=
 n
 IGlzIGZyb20gbGluZSA1NTEgb2YgYC9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJhbnNsYXRlLnJrdGA6PGRpdj4=
 8
 YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2PjxkaXY+OzsgZmlsbCBpbiBoYXNoIHRhYmxlczw=
 v
 ZGl2PjxkaXY+KGZvciogKFttb2RzeW1zIGFsbC1tb2RpZmllci1jb21iaW5hdGlvbnNdICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs7IGdvIHRocm91Z2ggYWxsIHBoeXN=
 p
 Y2FsIGtleTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7WyhrdmMgbikgdml=
 y
 dHVhbC1rZXktY29kZS1uYW1lLXRvLXZhbHVlLWh0XSkgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyBhbmQgbW9kaWZpZXIgY29=
 t
 YmluYXRpb25zPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBtb2RrcyAobW9kaWZpZXItc3ltYm9=
 s
 LWxpc3QtJmd0O2ludGVnZXIgbW9kc3ltcykpPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBzICh=
 r
 ZXktdHJhbnNsYXRlIG4gIzptb2RpZmllci1rZXktc3RhdGUgbW9ka3MpKSAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHRyYW5zbGF0ZSB0byBhIGNoYXI8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAodW5sZXNzIChzdHJpbmc9PyBzICIiKSAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgOyB1bmxlc3Mga2V5IGlzIGRlYWQ8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgKGRlZmluZSBjIChzdHJpbmctcmVmIHMgMCkpPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 IChoYXNoLXNldC1uZXchIGNoYXItdG8tb3N4LWtleWNvZGUrbW9kaWZpZXJzLWh0IGMgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHN0b3J=
 l
 IHdoZXJlIGNoYXIgaXMgZnJvbTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGxpc3Qga3ZjIG4gbW9=
 k
 c3ltcyBtb2RrcykpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyAoc2ltcGxlc3QgaXMga2V=
 w
 dCk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgKGNvbmQmbmJzcDs8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7IFsobnVsbD8gbW9kc3ltcykgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyA7IGFsc28sIGlmIGl0IGlzIGEgbWFpbiBjaGFyPC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsoaGFzaC1zZXQhIGNoYXItdG8tbWFpbi1jaGF=
 y
 LWtleS1odCBjIGMpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyAmbmJzcDsgc3RvcmUgaXQgYXMgc3V=
 j
 aDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGhhc2gtc2V0ISBvc3gta2V=
 5
 Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gYyldICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7ICZuYnNwOyZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgW2Vsc2U8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyh=
 k
 ZWZpbmUgbWNrIChoYXNoLXJlZiBvc3gta2V5Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gI2Y=
 p
 KSAmbmJzcDsgOyBvdGhlcndpc2UgZmluZCZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7KHdoZW4gbWNrIChoYXNoLXNldC1uZXchIGNoYXItdG8tbWFpbi1jaGFyLWt=
 l
 eS1odCBjIG1jaykpXSkpKSAmbmJzcDs7ICZuYnNwOyBhbmQgc3RvcmUgbWFpbiBjaGFyIGtleTw=
 v
 ZGl2PjwvZGl2PjxkaXY+YGBgPC9kaXY+" style=3D"min-height:0;width:0;max-height:=
 0;max-width:0;overflow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</=
 div></div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmai=
 l_quote">On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <span dir=
 =3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jen=
 saxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quot=
 e" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">=
 <div dir=3D"ltr"><div>That sounds as something that should work.</div>As fa=
 r as I know=C2=A0key-translate is only called when you actually press a key=
 .<br>So I am surprised that you see the error when DrRacket starts.<br><br>=
 I&#39;ll need to look up Ukelele.<span><font color=3D"#888888"><br><br>/Jen=
 s Axel<br><div><div><br></div><div><br></div></div></font></span></div><div=
 ><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 =
 18:11 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:ra=
 don.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<=
 br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left=
 :1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">It&#39;s not intentional=
 ly. Perhaps they are an artifact created by Ukelele. Is there an easy way t=
 o determine which key is producing the surrogate code point(s)?<div><br></d=
 iv><div>The first thing I think of is the dead keys used for creating accen=
 ts in OS X, but these are also present in the default keyboard layout. The =
 only thing I have done with them is move the Alt+E dead key to Alt+Shift+`.=
 </div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_qu=
 ote">On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <span dir=3D"lt=
 r">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@=
 soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" sty=
 le=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div d=
 ir=3D"ltr"><span style=3D"font-size:12.8px">Here is what I have so far:</sp=
 an><div><span style=3D"font-size:12.8px"><br></span></div><div>1) integer-&=
 gt;char is being called with an input that aren&#39;t accepted</div><div>2)=
  the caller is=C2=A0<span style=3D"color:rgb(51,51,51);font-family:consolas=
 ,&quot;liberation mono&quot;,menlo,courier,monospace;font-size:12px;line-he=
 ight:20px;white-space:pre-wrap">key-translate </span>a low level function w=
 hose job</div><div>=C2=A0 =C2=A0 is to translate (physical) keycodes into c=
 haracters using=C2=A0</div><div>=C2=A0 =C2=A0 a keyboard layout.=C2=A0</div=
 ><div>3) it is a bug in key-translate that integer-&gt;char is called with<=
 /div><div>=C2=A0 =C2=A0 an integer that doesn&#39;t correspond to a charact=
 er</div><div><br></div><div>4) From=C2=A0</div><div><span><span style=3D"fo=
 nt-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 integer-&gt;char: contra=
 ct violation</span><br style=3D"font-size:12.8px"><span style=3D"font-size:=
 12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 expected: (and/c (integer-in 0 #=
 x10FFFF) (not/c (integer-in #xD800 #xDFFF)))</span><br style=3D"font-size:1=
 2.8px"><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 given: 55357<br></span></span>=C2=A0 =C2=A0 we learn that the operating sys=
 tem translated a keycode to the codepoint=C2=A0<span style=3D"font-size:12.=
 8px">55357.</span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0=
  That code point lies in the range D800 to DFFF which are not accepted by</=
 span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 integer-&gt;=
 char</span></div><div><span style=3D"font-size:12.8px">5) That range is cal=
 led &quot;High Surrogates&quot;=C2=A0</span></div><div><span style=3D"font-=
 size:12.8px">=C2=A0 =C2=A0 From=C2=A0</span><span style=3D"font-size:12.8px=
 "><a href=3D"http://www.alanwood.net/unicode/high_surrogates.html" target=
 =3D"_blank">http://www.alanwood.net/u<wbr>nicode/high_surrogates.html</a><b=
 r></span><span style=3D"font-size:12.8px"><br></span><span style=3D"color:r=
 gb(0,0,0);font-family:times;font-size:16px;line-height:19.2px;background-co=
 lor:rgb(255,255,242)">Surrogate code points are intended to allow mapping o=
 f additional character planes into the 16-bit Unicode system, thus allowing=
  more than 65,536 characters to be represented. The individual surrogate co=
 de points do not represent characters; they are intended to be used in pair=
 s, a high code point followed by a low code point, to stand in for a charac=
 ter in one of the supplementary planes. Their use is restricted to UTF-16. =
 They can be used for characters in=C2=A0</span><a href=3D"http://www.alanwo=
 od.net/unicode/linear_b_syllabary.html" style=3D"color:rgb(128,0,128);font-=
 family:times;font-size:16px;line-height:19.2px;background-color:rgb(255,255=
 ,242)" target=3D"_blank">Linear B Syllabary</a><span style=3D"color:rgb(0,0=
 ,0);font-family:times;font-size:16px;line-height:19.2px;background-color:rg=
 b(255,255,242)">=C2=A0and higher-numbered ranges.<br></span></div><div><spa=
 n style=3D"font-size:12.8px"><br></span></div><div><br></div><div>Is it int=
 entionally that your layout produces such code points?</div><span><font col=
 or=3D"#888888"><div><br></div><div>/Jens Axel</div><div><br></div><div><br>=
 </div></font></span></div><div><div><div class=3D"gmail_extra"><br><div cla=
 ss=3D"gmail_quote">2016-09-08 17:50 GMT+02:00 Radon Rosborough <span dir=3D=
 "ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.n=
 eon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D=
 "margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D=
 "ltr">Before. If I switch after I launch DrRacket, it appears to work OK, a=
 lthough I haven&#39;t tried anything substantial to make sure everything wo=
 rks.</div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quot=
 e">On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr"=
 >&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@so=
 egaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=
 =3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=
 =3D"ltr">Did you switch to your keyboard layout before or after starting Dr=
 Racket?<div><br></div><div>/Jens Axel</div><div><br></div></div><div class=
 =3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:32 GMT+02:00 =
  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_b=
 lank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_qu=
 ote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex=
 ">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div class=3D"gmail_signature" data-smartmail=3D"gmail_signature">-- <br>Je=
 ns Axel S=C3=B8gaard<br><br></div>
 </div>
 
 --001a114369260e25b6053c0344cb--
From: Radon Rosborough <radon.neon@gmail.com>
To: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Thu, 8 Sep 2016 11:40:24 -0700

 --001a114127905c9fd1053c035fdc
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 Now I get
 
 list->string: contract violation
   expected: (listof char?)
   given: '("" "")
   context...:
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:555:0:
 for-loop
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:555:0:
 for-loop
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 [running body]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/window.rkt: [traversing
 imports]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/item.rkt: [traversing
 imports]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/button.rkt: [traversing
 imports]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/platform.rkt:
 [traversing imports]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/wx/platform.rkt: [running body]
    /Applications/Racket
 v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt:
 [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt:
 [traversing imports]
    /Applications/Racket
 v6.6/share/pkgs/drracket/drracket/drracket.rkt: [traversing imports]
 
 It looks like the empty strings need to be removed from the list before
 being passed to list->string.
 =E2=80=8B
 
 On Thu, Sep 8, 2016 at 11:33 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard.=
 net>
 wrote:
 
 > Sorry. I missed that i was used in for/list.
 > Try:
 >
 > (list->string (for/list ([i (in-range n)]) (define j (ptr-ref output-char=
 s
 > _UniChar i)) (if (<=3D #xD800 j #xDFFF) "" (integer->char j)))))
 >
 > 2016-09-08 20:24 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >
 >> Strangely, I get the following error (with both my keyboard layout and
 >> the standard one):
 >>
 >> i: undefined;
 >>  cannot use before initialization
 >>   context...:
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ke=
 y-translate.rkt:495:16: for-loop
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ke=
 y-translate.rkt:555:0: for-loop
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ke=
 y-translate.rkt: [running body]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/wi=
 ndow.rkt: [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/it=
 em.rkt: [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/bu=
 tton.rkt: [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/pl=
 atform.rkt: [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform=
 .rkt: [running body]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt:=
  [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt: [=
 traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [traversi=
 ng imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [traversi=
 ng imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [tr=
 aversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt: =
 [traversing imports]
 >>
 >> I am just getting started with Racket so I don=E2=80=99t know why this w=
 ould
 >> be=E2=80=94it looks like i is introduced as a local binding to me. Here =
 is what
 >> my modified key-translate looks like:
 >>
 >> (define (key-translate virtual-key-code
 >>                        #:key-action            [key-action         kUCKe=
 yActionDown]
 >>                        #:modifier-key-state    [modifier-key-state      =
           0]  ; no modifier
 >>                        #:keyboard-type         [keyboard-type        (LM=
 GetKbdType)]
 >>                        #:key-translate-options [key-translate-options   =
          #f]
 >>                        #:dead-key-state        [dead-key-state          =
          #f]  ; no prev state
 >>                        #:keyboard-layout       [layout-in               =
     'cached]) ; use cached
 >>   (define actual-string-length (box 0))
 >>   (set! key-translate-options
 >>         (or key-translate-options                ; use user settings if =
 provided
 >>             (if dead-key-state                   ; otherwise if user has=
  set dead-key-state,
 >>                 0                                ; then take dead-keys i=
 nto account
 >>                 kUCKeyTranslateNoDeadKeysFlag))) ; else ignore dead keys
 >>
 >>   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state))=
 )
 >>
 >>   (define layout
 >>     (case layout-in
 >>       ; use cached
 >>       [(cached)    (cond
 >>                     [cached-keyboard-layout =3D> values]
 >>                     [else   (set! cached-keyboard-layout (get-current-ke=
 yboard-layout))
 >>                             cached-keyboard-layout])]
 >>       ; refresh cache
 >>       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-l=
 ayout))
 >>                     cached-keyboard-layout]
 >>       ; use provided
 >>       [else          layout-in]))
 >>
 >>   (UCKeyTranslate layout
 >>                   virtual-key-code
 >>                   key-action
 >>                   (bitwise-and (>> modifier-key-state 8) #xFF)
 >>                   keyboard-type
 >>                   key-translate-options
 >>                   dead-key-state
 >>                   max-string-length
 >>                   actual-string-length
 >>                   output-chars)
 >>   ; get the number of characters returned, and convert to string
 >>   (define n (max 0 (min max-string-length (unbox actual-string-length)))=
 )
 >>   (list->string (for/list ([i (in-range n)])
 >>                   (define i (ptr-ref output-chars _UniChar i))
 >>                   (if (<=3D  #xD800 i #xDFFF)
 >>                       ""
 >>                       (integer->char i)))))
 >>
 >> =E2=80=8B
 >>
 >> On Thu, Sep 8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaar=
 d.net>
 >> wrote:
 >>
 >>> Progress - so key-translate does get called.
 >>>
 >>> The two last lines of key-translate are:
 >>>
 >>>     (list->string (for/list ([i (in-range n)])
 >>>                        (integer->char (ptr-ref output-chars _UniChar
 >>> i)))))
 >>>
 >>> Can you test what happens if you change it to:
 >>>
 >>>     (list->string (for/list ([i (in-range n)])
 >>>                            (define i (ptr-ref output-chars _UniChar i))
 >>>                            (if (<=3D  #xD800 i #xDFFF)
 >>>                                 ""
 >>>                                (integer->char i)))))
 >>>
 >>> ?
 >>>
 >>>
 >>> 2016-09-08 18:23 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>
 >>>> It looks to me like the reason for this is that the gui-lib package
 >>>> (loaded for anything graphical, I presume, including launching DrRacke=
 t)
 >>>> fills out a hash table for keyboard mappings eagerly (on package load)=
 . The
 >>>> following is from line 551 of /Applications/Racket
 >>>> v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 >>>>
 >>>> ;; fill in hash tables
 >>>> (for* ([modsyms all-modifier-combinations]                            =
 ; go through all physical key
 >>>>        [(kvc n) virtual-key-code-name-to-value-ht])                   =
 ; and modifier combinations
 >>>>   (define modks (modifier-symbol-list->integer modsyms))
 >>>>   (define s (key-translate n #:modifier-key-state modks))             =
 ; translate to a char
 >>>>   (unless (string=3D? s "")                                           =
   ; unless key is dead
 >>>>     (define c (string-ref s 0))
 >>>>     (hash-set-new! char-to-osx-keycode+modifiers-ht c                 =
 ; store where char is from
 >>>>                    (list kvc n modsyms modks))                        =
 ; (simplest is kept)
 >>>>     (cond
 >>>>       [(null? modsyms)                                               ;=
  also, if it is a main char
 >>>>        (hash-set! char-to-main-char-key-ht c c)                       =
 ;   store it as such
 >>>>        (hash-set! osx-keycode-to-main-char-key-ht n c)]               =
 ;
 >>>>       [else
 >>>>        (define mck (hash-ref osx-keycode-to-main-char-key-ht n #f))   =
 ; otherwise find
 >>>>        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  =
 ;   and store main char key
 >>>>
 >>>> =E2=80=8B
 >>>>
 >>>> On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <
 >>>> jensaxel@soegaard.net> wrote:
 >>>>
 >>>>> That sounds as something that should work.
 >>>>> As far as I know key-translate is only called when you actually press
 >>>>> a key.
 >>>>> So I am surprised that you see the error when DrRacket starts.
 >>>>>
 >>>>> I'll need to look up Ukelele.
 >>>>>
 >>>>> /Jens Axel
 >>>>>
 >>>>>
 >>>>>
 >>>>> 2016-09-08 18:11 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>>
 >>>>>> It's not intentionally. Perhaps they are an artifact created by
 >>>>>> Ukelele. Is there an easy way to determine which key is producing th=
 e
 >>>>>> surrogate code point(s)?
 >>>>>>
 >>>>>> The first thing I think of is the dead keys used for creating accent=
 s
 >>>>>> in OS X, but these are also present in the default keyboard layout. =
 The
 >>>>>> only thing I have done with them is move the Alt+E dead key to Alt+S=
 hift+`.
 >>>>>>
 >>>>>> On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <
 >>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>
 >>>>>>> Here is what I have so far:
 >>>>>>>
 >>>>>>> 1) integer->char is being called with an input that aren't accepted
 >>>>>>> 2) the caller is key-translate a low level function whose job
 >>>>>>>     is to translate (physical) keycodes into characters using
 >>>>>>>     a keyboard layout.
 >>>>>>> 3) it is a bug in key-translate that integer->char is called with
 >>>>>>>     an integer that doesn't correspond to a character
 >>>>>>>
 >>>>>>> 4) From
 >>>>>>>           integer->char: contract violation
 >>>>>>>           expected: (and/c (integer-in 0 #x10FFFF) (not/c
 >>>>>>> (integer-in #xD800 #xDFFF)))
 >>>>>>>           given: 55357
 >>>>>>>     we learn that the operating system translated a keycode to the
 >>>>>>> codepoint 55357.
 >>>>>>>     That code point lies in the range D800 to DFFF which are not
 >>>>>>> accepted by
 >>>>>>>     integer->char
 >>>>>>> 5) That range is called "High Surrogates"
 >>>>>>>     From http://www.alanwood.net/unicode/high_surrogates.html
 >>>>>>>
 >>>>>>> Surrogate code points are intended to allow mapping of additional
 >>>>>>> character planes into the 16-bit Unicode system, thus allowing more=
  than
 >>>>>>> 65,536 characters to be represented. The individual surrogate code =
 points
 >>>>>>> do not represent characters; they are intended to be used in pairs,=
  a high
 >>>>>>> code point followed by a low code point, to stand in for a characte=
 r in one
 >>>>>>> of the supplementary planes. Their use is restricted to UTF-16. The=
 y can be
 >>>>>>> used for characters in Linear B Syllabary
 >>>>>>> <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 >>>>>>> higher-numbered ranges.
 >>>>>>>
 >>>>>>>
 >>>>>>> Is it intentionally that your layout produces such code points?
 >>>>>>>
 >>>>>>> /Jens Axel
 >>>>>>>
 >>>>>>>
 >>>>>>>
 >>>>>>> 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>>>>
 >>>>>>>> Before. If I switch after I launch DrRacket, it appears to work OK=
 ,
 >>>>>>>> although I haven't tried anything substantial to make sure everyth=
 ing works.
 >>>>>>>>
 >>>>>>>> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <
 >>>>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>>>
 >>>>>>>>> Did you switch to your keyboard layout before or after starting
 >>>>>>>>> DrRacket?
 >>>>>>>>>
 >>>>>>>>> /Jens Axel
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>>>>>>>
 >>>>>>>>>> A new problem report is waiting at
 >>>>>>>>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>>>>>>>
 >>>>>>>>>> Reported by Radon Rosborough for release: 6.6
 >>>>>>>>>>
 >>>>>>>>>> *** Description:
 >>>>>>>>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>>>>>>>> keyboard layout. If I am using my custom keyboard layout (but no=
 t when
 >>>>>>>>>> using the default keyboard layout), then when:
 >>>>>>>>>>
 >>>>>>>>>> - launching the 'drracket' executable,
 >>>>>>>>>> - opening the DrRacket application, or
 >>>>>>>>>> - using geiser in Emacs, compiling a file with '#lang slideshow'
 >>>>>>>>>> in it,
 >>>>>>>>>>
 >>>>>>>>>> Racket crashes immediately with the following error:
 >>>>>>>>>>
 >>>>>>>>>> integer->char: contract violation
 >>>>>>>>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >>>>>>>>>> #xD800 #xDFFF)))
 >>>>>>>>>>   given: 55357
 >>>>>>>>>>   context...:
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/=
 cocoa/window.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/=
 cocoa/item.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/=
 cocoa/button.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/=
 cocoa/platform.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/=
 platform.rkt:
 >>>>>>>>>> [running body]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/ker=
 nel.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mre=
 d.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.=
 rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drrack=
 et.rkt:
 >>>>>>>>>> [traversing imports]
 >>>>>>>>>>
 >>>>>>>>>> *** How to repeat:
 >>>>>>>>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can als=
 o
 >>>>>>>>>> reproduce the problem on a virtual machine with a fresh install =
 of El
 >>>>>>>>>> Capitan 10.11.
 >>>>>>>>>>
 >>>>>>>>>> - Download my custom keyboard layout:
 >>>>>>>>>> https://drive.google.com/open?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>>>>>>>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard
 >>>>>>>>>> Layouts".
 >>>>>>>>>> - In System Preferences > Keyboard > Input Sources, add "My
 >>>>>>>>>> Keyboard Layout" as an input source.
 >>>>>>>>>> - Make sure the "Show Input menu in menu bar" checkbox is checke=
 d.
 >>>>>>>>>> - In the Input menu in the menu bar, select "My Keyboard Layout"=
 .
 >>>>>>>>>> - Launch DrRacket. It should crash (and provide the above error
 >>>>>>>>>> message if it was launched from the command line).
 >>>>>>>>>>
 >>>>>>>>>> *** Environment:
 >>>>>>>>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel
 >>>>>>>>>> Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.1=
 1~1/RELEASE_X86_64
 >>>>>>>>>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>>>>>>>> Human Language: english
 >>>>>>>>>> (current-memory-use) 252260656
 >>>>>>>>>> raco pkg (show):
 >>>>>>>>>> Installation-wide:
 >>>>>>>>>>  Package            Checksum             Source
 >>>>>>>>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>>>>>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>>>>>>>  [189 auto-installed packages not shown]
 >>>>>>>>>> User-specific for installation "6.6":
 >>>>>>>>>>  [none]
 >>>>>>>>>>
 >>>>>>>>>>
 >>>>>>>>>>
 >>>>>>>>>> Collections:
 >>>>>>>>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>>>>>>>  (non-existent-path))
 >>>>>>>>>> ("/Applications/Racket v6.6/collects"
 >>>>>>>>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>>>>>>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "=
 racket"
 >>>>>>>>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml"=
 ))
 >>>>>>>>>>
 >>>>>>>>>> Recent Internal Errors:
 >>>>>>>>>> Computer Language: (("Initial language" "No language chosen")
 >>>>>>>>>> #(#t print mixed-fraction-e #f #t debug))
 >>>>>>>>>>
 >>>>>>>>>>
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>> --
 >>>>>>>>> --
 >>>>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>
 >>>>>>>
 >>>>>>>
 >>>>>>> --
 >>>>>>> --
 >>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>
 >>>>>>>
 >>>>>>
 >>>>>
 >>>>>
 >>>>> --
 >>>>> --
 >>>>> Jens Axel S=C3=B8gaard
 >>>>>
 >>>>>
 >>>>
 >>>
 >>>
 >>> --
 >>> --
 >>> Jens Axel S=C3=B8gaard
 >>>
 >>>
 >>
 >
 >
 > --
 > --
 > Jens Axel S=C3=B8gaard
 >
 >
 
 --001a114127905c9fd1053c035fdc
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr"><div class=3D"markdown-here-wrapper" style=3D""><p style=
 =3D"margin:0px 0px 1.2em!important">Now I get</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre;overflow:auto;border-radius:3px;border:1px solid rgb(204,204,=
 204);padding:0.5em 0.7em;display:block!important">list-&gt;string: contract=
  violation
   expected: (listof char?)
   given: &#39;(&quot;&quot; &quot;&quot;)
   context...:
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-t=
 ranslate.rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-t=
 ranslate.rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-t=
 ranslate.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/windo=
 w.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/item.=
 rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/butto=
 n.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/platf=
 orm.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform.rk=
 t: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt: [t=
 raversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt: [tra=
 versing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [traversing =
 imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [traversing =
 imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [trave=
 rsing imports]
    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt: [tr=
 aversing imports]
 </code></pre><p style=3D"margin:0px 0px 1.2em!important">It looks like the =
 empty strings need to be removed from the list before being passed to <code=
  style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospa=
 ce;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px soli=
 d rgb(234,234,234);border-radius:3px;display:inline;background-color:rgb(24=
 8,248,248)">list-&gt;string</code>.</p>
 <div title=3D"MDH:Tm93IEkgZ2V0PGRpdj48YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2P=
 jxkaXY+bGlzdC0mZ3Q7
 c3RyaW5nOiBjb250cmFjdCB2aW9sYXRpb248L2Rpdj48ZGl2PiZuYnNwOyBleHBlY3RlZDogKGx=
 p
 c3RvZiBjaGFyPyk8L2Rpdj48ZGl2PiZuYnNwOyBnaXZlbjogJygiIiAiIik8L2Rpdj48ZGl2PiZ=
 u
 YnNwOyBjb250ZXh0Li4uOjwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmF=
 j
 a2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJ=
 h
 bnNsYXRlLnJrdDo1NTU6MDogZm9yLWxvb3A8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGl=
 j
 YXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29=
 j
 b2Eva2V5LXRyYW5zbGF0ZS5ya3Q6NTU1OjA6IGZvci1sb29wPC9kaXY+PGRpdj4mbmJzcDsgJm5=
 i
 c3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml=
 2
 YXRlL3d4L2NvY29hL2tleS10cmFuc2xhdGUucmt0OiBbcnVubmluZyBib2R5XTwvZGl2PjxkaXY=
 +
 Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGl=
 i
 L21yZWQvcHJpdmF0ZS93eC9jb2NvYS93aW5kb3cucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9pdGVtLnJrdDogW3RyYXZlcnNpbmcgaW1=
 w
 b3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3N=
 o
 YXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvYnV0dG9uLnJrdDogW3RyYXZ=
 l
 cnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2t=
 l
 dCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvcGxhdGZvcm0=
 u
 cmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWN=
 h
 dGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9wbGF=
 0
 Zm9ybS5ya3Q6IFtydW5uaW5nIGJvZHldPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F=
 0
 aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL2tlcm5lbC5=
 y
 a3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F=
 0
 aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL21yZWQucmt=
 0
 OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGl=
 v
 bnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvbXJlZC5ya3Q6IFt0cmF2ZXJ=
 z
 aW5nIGltcG9ydHNdPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQ=
 g
 djYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9tYWluLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J=
 0
 c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJ=
 l
 L3BrZ3MvZ3VpLWxpYi9yYWNrZXQvZ3VpL2Jhc2Uucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9kcnJhY2tldC9kcnJhY2tldC9kcnJhY2tldC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9=
 k
 aXY+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl2Pkl0IGxvb2tzIGxpa2U=
 g
 dGhlIGVtcHR5IHN0cmluZ3MgbmVlZCB0byBiZSByZW1vdmVkIGZyb20gdGhlIGxpc3QgYmVmb3J=
 l
 IGJlaW5nIHBhc3NlZCB0byBgbGlzdC0mZ3Q7c3RyaW5nYC48L2Rpdj4=3D" style=3D"height=
 :0;width:0;max-height:0;max-width:0;overflow:hidden;font-size:0em;padding:0=
 ;margin:0">=E2=80=8B</div></div></div><div class=3D"gmail_extra"><br><div c=
 lass=3D"gmail_quote">On Thu, Sep 8, 2016 at 11:33 AM, Jens Axel S=C3=B8gaar=
 d <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"=
 _blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D=
 "gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding=
 -left:1ex"><div dir=3D"ltr">Sorry. I missed that i was used in for/list.<di=
 v>Try:<br><div><br></div><div><span style=3D"font-family:consolas,inconsola=
 ta,courier,monospace;font-size:10.88px;line-height:15.36px;white-space:pre-=
 wrap;background-color:rgb(248,248,248)">(list-&gt;string (for/list ([i (in-=
 range n)])
                   (define j (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 j #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char j)))))</span><br></div></div></div>=
 <div class=3D"HOEnZb"><div class=3D"h5"><div class=3D"gmail_extra"><br><div=
  class=3D"gmail_quote">2016-09-08 20:24 GMT+02:00 Radon Rosborough <span di=
 r=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">rad=
 on.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" styl=
 e=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div di=
 r=3D"ltr"><div><p style=3D"margin:0px 0px 1.2em!important">Strangely, I get=
  the following error (with both my keyboard layout and the standard one):</=
 p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">i: undefined;
  cannot use before initialization
   context...:
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt:495:16: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 window.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 item.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 button.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 platform.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/platfo=
 rm.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/kernel.rk=
 t: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/mred.rkt:=
  [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/base.rkt: [=
 traversing imports]
    /Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/drracket.rkt=
 : [traversing imports]
 </code></pre><p style=3D"margin:0px 0px 1.2em!important">I am just getting =
 started with Racket so I don=E2=80=99t know why this would be=E2=80=94it lo=
 oks like <code style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,C=
 ourier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;b=
 order:1px solid rgb(234,234,234);border-radius:3px;display:inline;backgroun=
 d-color:rgb(248,248,248)">i</code> is introduced as a local binding to me. =
 Here is what my modified <code style=3D"font-size:0.85em;font-family:Consol=
 as,Inconsolata,Courier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-=
 space:pre-wrap;border:1px solid rgb(234,234,234);border-radius:3px;display:=
 inline;background-color:rgb(248,248,248)">key-translate</code> looks like:<=
 /p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">(define (key-transla=
 te virtual-key-code
                        #:key-action            [key-action         kUCKeyAc=
 tionDown]
                        #:modifier-key-state    [modifier-key-state         =
        0]  ; no modifier
                        #:keyboard-type         [keyboard-type        (LMGet=
 KbdType)]
                        #:key-translate-options [key-translate-options      =
       #f]
                        #:dead-key-state        [dead-key-state             =
       #f]  ; no prev state
                        #:keyboard-layout       [layout-in                  =
  &#39;cached]) ; use cached
   (define actual-string-length (box 0))
   (set! key-translate-options
         (or key-translate-options                ; use user settings if pro=
 vided
             (if dead-key-state                   ; otherwise if user has se=
 t dead-key-state,
                 0                                ; then take dead-keys into=
  account
                 kUCKeyTranslateNoDeadKeysFlag)<wbr>)) ; else ignore dead ke=
 ys
 
   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state))<wb=
 r>)
 
   (define layout
     (case layout-in
       ; use cached
       [(cached)    (cond
                     [cached-keyboard-layout =3D&gt; values]
                     [else   (set! cached-keyboard-layout (get-current-keybo=
 ard-layout))
                             cached-keyboard-layout])]
       ; refresh cache
       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-layo=
 ut))
                     cached-keyboard-layout]
       ; use provided
       [else          layout-in]))
 
   (UCKeyTranslate layout
                   virtual-key-code
                   key-action
                   (bitwise-and (&gt;&gt; modifier-key-state 8) #xFF)
                   keyboard-type
                   key-translate-options
                   dead-key-state
                   max-string-length
                   actual-string-length
                   output-chars)
   ; get the number of characters returned, and convert to string
   (define n (max 0 (min max-string-length (unbox actual-string-length))))
   (list-&gt;string (for/list ([i (in-range n)])
                   (define i (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 i #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char i)))))
 </code></pre><div title=3D"MDH:U3RyYW5nZWx5LCBJIGdldCB0aGUgZm9sbG93aW5nIGVy=
 cm9yICh3aXRoIGJvdGggbXkga2V5Ym9h
 cmQgbGF5b3V0IGFuZCB0aGUgc3RhbmRhcmQgb25lKTo8ZGl2Pjxicj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2PjxkaXY+PGRpdj5pOiB1bmRlZmluZWQ7PC9kaXY+PGRpdj4mbmJzcDtjYW5ub3QgdXNlIGJ=
 l
 Zm9yZSBpbml0aWFsaXphdGlvbjwvZGl2PjxkaXY+Jm5ic3A7IGNvbnRleHQuLi46PC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1=
 s
 aWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2xhdGUucmt0OjQ5NToxNjogZm9yLWx=
 v
 b3A8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJ=
 l
 L3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2Eva2V5LXRyYW5zbGF0ZS5ya3Q6NTU=
 1
 OjA6IGZvci1sb29wPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQ=
 g
 djYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2x=
 h
 dGUucmt0OiBbcnVubmluZyBib2R5XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGl=
 v
 bnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9=
 3
 aW5kb3cucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS9=
 3
 eC9jb2NvYS9pdGVtLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3B=
 y
 aXZhdGUvd3gvY29jb2EvYnV0dG9uLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl=
 2
 PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWx=
 p
 Yi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvcGxhdGZvcm0ucmt0OiBbdHJhdmVyc2luZyBpbXBvcnR=
 z
 XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmU=
 v
 cGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9wbGF0Zm9ybS5ya3Q6IFtydW5uaW5nIGJvZHl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL2tlcm5lbC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHN=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL21yZWQucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvbXJlZC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWI=
 v
 bXJlZC9tYWluLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJ=
 z
 cDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9yYWNrZXQvZ3V=
 p
 L2Jhc2Uucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9kcnJhY2tldC9kcnJhY2tldC9kcnJ=
 h
 Y2tldC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PC9kaXY+PGRpdj5gYGA8L2Rpdj4=
 8
 ZGl2Pjxicj48L2Rpdj48ZGl2PkkgYW0ganVzdCBnZXR0aW5nIHN0YXJ0ZWQgd2l0aCBSYWNrZXQ=
 g
 c28gSSBkb24ndCBrbm93IHdoeSB0aGlzIHdvdWxkIGJl4oCUaXQgbG9va3MgbGlrZSBgaWAgaXM=
 g
 aW50cm9kdWNlZCBhcyBhIGxvY2FsIGJpbmRpbmcgdG8gbWUuIEhlcmUgaXMgd2hhdCBteSBtb2R=
 p
 ZmllZCBga2V5LXRyYW5zbGF0ZWAgbG9va3MgbGlrZTo8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl=
 2
 PmBgYDwvZGl2PjxkaXY+PGRpdj4oZGVmaW5lIChrZXktdHJhbnNsYXRlIHZpcnR1YWwta2V5LWN=
 v
 ZGU8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzprZXktYWN0aW9uICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7W2tleS1hY3Rpb24gJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7IGtVQ0tleUFjdGlvbkRvd25dPC9kaXY+PGRpdj4mbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyM6bW9kaWZpZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDtbbW9kaWZ=
 p
 ZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDswXSAmbmJzcDs7IG5vIG1vZGlmaWVyPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyM6a2V5Ym9hcmQtdHlwZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 W2tleWJvYXJkLXR5cGUgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KExNR2V0S2JkVHlwZSl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyM6a2V5LXRyYW5zbGF0ZS1vcHR=
 p
 b25zIFtrZXktdHJhbnNsYXRlLW9wdGlvbnMgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsjZl08L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzpkZWF=
 k
 LWtleS1zdGF0ZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDtbZGVhZC1rZXktc3RhdGUgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgI2ZdICZuYnNwOzsgbm8gcHJldiBzdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsjOmtleWJvYXJkLWxheW91dCAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbbGF5b3V0LWl=
 u
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICdjYWNoZWRdKSA7IHVzZSBjYWNoZWQ8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGF=
 j
 dHVhbC1zdHJpbmctbGVuZ3RoIChib3ggMCkpPC9kaXY+PGRpdj4mbmJzcDsgKHNldCEga2V5LXR=
 y
 YW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKG9=
 y
 IGtleS10cmFuc2xhdGUtb3B0aW9ucyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyB1c2UgdXNlciBzZXR0aW5ncyBpZiBwcm92aWRlZDwvZGl=
 2
 PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGlmIGRlYWQ=
 t
 a2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7IDsgb3RoZXJ3aXNlIGlmIHVzZXIgaGFzIHNldCBkZWFkLWtleS1zdGF=
 0
 ZSw8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgMCAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDs7IHRoZW4gdGFrZSBkZWFkLWtleXMgaW50byBhY2NvdW50PC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IGt=
 V
 Q0tleVRyYW5zbGF0ZU5vRGVhZEtleXNGbGFnKSkpIDsgZWxzZSBpZ25vcmUgZGVhZCBrZXlzPC9=
 k
 aXY+PGRpdj48YnI+PC9kaXY+PGRpdj4mbmJzcDsgKHNldCEgZGVhZC1rZXktc3RhdGUgKG9yIGR=
 l
 YWQta2V5LXN0YXRlIChtYWtlLWluaXRpYWwtZGVhZC1rZXktc3RhdGUpKSk8L2Rpdj48ZGl2Pjx=
 i
 cj48L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGxheW91dDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnN=
 w
 OyAoY2FzZSBsYXlvdXQtaW48L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IDsgdXNlIGN=
 h
 Y2hlZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgWyhjYWNoZWQpICZuYnNwOyAmbmJ=
 z
 cDsoY29uZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IFtjYWNoZWQta2V5Ym9hcmQtbGF5b3V0ID0=
 m
 Z3Q7IHZhbHVlc108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbZWxzZSAmbmJzcDsgKHNldCEgY2F=
 j
 aGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V5Ym9hcmQtbGF5b3V0KSk8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgY2FjaGVkLWtleWJ=
 v
 YXJkLWxheW91dF0pXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyByZWZyZXNoIGN=
 h
 Y2hlPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyBbKCNmKSAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgKHNldCEgY2FjaGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V=
 5
 Ym9hcmQtbGF5b3V0KSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBjYWNoZWQta2V5Ym9hcmQtbGF=
 5
 b3V0XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyB1c2UgcHJvdmlkZWQ8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IFtlbHNlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDtsYXlvdXQtaW5dKSk8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl2PiZuYnNwOyAoVUN=
 L
 ZXlUcmFuc2xhdGUgbGF5b3V0PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyB2aXJ0dWFsLWtleS1jb2RlPC9kaXY=
 +
 PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyBrZXktYWN0aW9uPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAoYml0d2lzZS1hbmQgKCZndDs=
 m
 Z3Q7IG1vZGlmaWVyLWtleS1zdGF0ZSA4KSAjeEZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5Ym9hcmQ=
 t
 dHlwZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5LXRyYW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyBkZWFkLWtleS1zdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgbWF4LXN0cmluZy1sZW5ndGg8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7IGFjdHVhbC1zdHJpbmctbGVuZ3RoPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBvdXRwdXQtY2h=
 h
 cnMpPC9kaXY+PGRpdj4mbmJzcDsgOyBnZXQgdGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIHJldHV=
 y
 bmVkLCBhbmQgY29udmVydCB0byBzdHJpbmc8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIG4gKG1=
 h
 eCAwIChtaW4gbWF4LXN0cmluZy1sZW5ndGggKHVuYm94IGFjdHVhbC1zdHJpbmctbGVuZ3RoKSk=
 p
 KTwvZGl2PjxkaXY+Jm5ic3A7IChsaXN0LSZndDtzdHJpbmcgKGZvci9saXN0IChbaSAoaW4tcmF=
 u
 Z2UgbildKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGRlZmluZSBpIChwdHItcmVmIG91dHB1dC1jaGFycyB=
 f
 VW5pQ2hhciBpKSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IChpZiAoJmx0Oz0gJm5ic3A7I3hEODAwIGkgI3h=
 E
 RkZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAiIjwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAoaW50ZWdlci0mZ3Q7Y2hhciBpKSkpKSk8L2Rpdj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2Pg=3D=3D" style=3D"min-height:0;width:0;max-height:0;max-width:0;overfl=
 ow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</div></div></div><div=
 ><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">On Thu, Sep=
  8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=
 =3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@soegaard.net</=
 a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0=
  0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">Pro=
 gress - so key-translate does get called.<br><br>The two last lines of key-=
 translate are:<br><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/list ([i (in=
 -range n)])=C2=A0</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;char (ptr-ref output-cha=
 rs _UniChar i)))))<br><br>Can you test what happens if you change it to:<br=
 ><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/list ([i (in-range n)])=C2=A0=
 </div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(define i (ptr-ref output-chars _UniChar =
 i))</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(if (&lt;=3D=C2=A0<span style=3D"colo=
 r:rgb(80,0,80);font-size:12.8px">=C2=A0</span><span style=3D"color:rgb(80,0=
 ,80);font-size:12.8px">#xD800 i #xDFFF)</span></div><div><span style=3D"col=
 or:rgb(80,0,80);font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0=
  =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 &quo=
 t;&quot;</span></div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;=
 char i)))))<br><br>?</div><br></div></div><div><div><div class=3D"gmail_ext=
 ra"><br><div class=3D"gmail_quote">2016-09-08 18:23 GMT+02:00 Radon Rosboro=
 ugh <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D=
 "_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail=
 _quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:=
 1ex"><div dir=3D"ltr"><div><p style=3D"margin:0px 0px 1.2em!important">It l=
 ooks to me like the reason for this is that the <code style=3D"font-size:0.=
 85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px 0.15em;p=
 adding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234,234);bor=
 der-radius:3px;display:inline;background-color:rgb(248,248,248)">gui-lib</c=
 ode> package (loaded for anything graphical, I presume, including launching=
  DrRacket) fills out a hash table for keyboard mappings eagerly (on package=
  load). The following is from line 551 of <code style=3D"font-size:0.85em;f=
 ont-family:Consolas,Inconsolata,Courier,monospace;margin:0px 0.15em;padding=
 :0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234,234);border-ra=
 dius:3px;display:inline;background-color:rgb(248,248,248)">/Applications/Ra=
 cket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/key-translate.<wbr>=
 rkt</code>:</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">;; fill in hash tabl=
 es
 (for* ([modsyms all-modifier-combinations]                            ; go =
 through all physical key
        [(kvc n) virtual-key-code-name-to-value<wbr>-ht])                   =
 ; and modifier combinations
   (define modks (modifier-symbol-list-&gt;integer modsyms))
   (define s (key-translate n #:modifier-key-state modks))             ; tra=
 nslate to a char
   (unless (string=3D? s &quot;&quot;)                                      =
        ; unless key is dead
     (define c (string-ref s 0))
     (hash-set-new! char-to-osx-keycode+modifiers-<wbr>ht c                 =
 ; store where char is from
                    (list kvc n modsyms modks))                        ; (si=
 mplest is kept)
     (cond=20
       [(null? modsyms)                                               ; also=
 , if it is a main char
        (hash-set! char-to-main-char-key-ht c c)                       ;   s=
 tore it as such
        (hash-set! osx-keycode-to-main-char-key-h<wbr>t n c)]               =
 ;  =20
       [else
        (define mck (hash-ref osx-keycode-to-main-char-key-h<wbr>t n #f))   =
 ; otherwise find=20
        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;   a=
 nd store main char key
 </code></pre><div title=3D"MDH:SXQgbG9va3MgdG8gbWUgbGlrZSB0aGUgcmVhc29uIGZv=
 ciB0aGlzIGlzIHRoYXQgdGhlIGBndWkt
 bGliYCBwYWNrYWdlIChsb2FkZWQgZm9yIGFueXRoaW5nIGdyYXBoaWNhbCwgSSBwcmVzdW1lLCB=
 p
 bmNsdWRpbmcgbGF1bmNoaW5nIERyUmFja2V0KSBmaWxscyBvdXQgYSBoYXNoIHRhYmxlIGZvciB=
 r
 ZXlib2FyZCBtYXBwaW5ncyBlYWdlcmx5IChvbiBwYWNrYWdlIGxvYWQpLiBUaGUgZm9sbG93aW5=
 n
 IGlzIGZyb20gbGluZSA1NTEgb2YgYC9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJhbnNsYXRlLnJrdGA6PGRpdj4=
 8
 YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2PjxkaXY+OzsgZmlsbCBpbiBoYXNoIHRhYmxlczw=
 v
 ZGl2PjxkaXY+KGZvciogKFttb2RzeW1zIGFsbC1tb2RpZmllci1jb21iaW5hdGlvbnNdICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs7IGdvIHRocm91Z2ggYWxsIHBoeXN=
 p
 Y2FsIGtleTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7WyhrdmMgbikgdml=
 y
 dHVhbC1rZXktY29kZS1uYW1lLXRvLXZhbHVlLWh0XSkgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyBhbmQgbW9kaWZpZXIgY29=
 t
 YmluYXRpb25zPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBtb2RrcyAobW9kaWZpZXItc3ltYm9=
 s
 LWxpc3QtJmd0O2ludGVnZXIgbW9kc3ltcykpPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBzICh=
 r
 ZXktdHJhbnNsYXRlIG4gIzptb2RpZmllci1rZXktc3RhdGUgbW9ka3MpKSAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHRyYW5zbGF0ZSB0byBhIGNoYXI8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAodW5sZXNzIChzdHJpbmc9PyBzICIiKSAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgOyB1bmxlc3Mga2V5IGlzIGRlYWQ8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgKGRlZmluZSBjIChzdHJpbmctcmVmIHMgMCkpPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 IChoYXNoLXNldC1uZXchIGNoYXItdG8tb3N4LWtleWNvZGUrbW9kaWZpZXJzLWh0IGMgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHN0b3J=
 l
 IHdoZXJlIGNoYXIgaXMgZnJvbTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGxpc3Qga3ZjIG4gbW9=
 k
 c3ltcyBtb2RrcykpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyAoc2ltcGxlc3QgaXMga2V=
 w
 dCk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgKGNvbmQmbmJzcDs8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7IFsobnVsbD8gbW9kc3ltcykgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyA7IGFsc28sIGlmIGl0IGlzIGEgbWFpbiBjaGFyPC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsoaGFzaC1zZXQhIGNoYXItdG8tbWFpbi1jaGF=
 y
 LWtleS1odCBjIGMpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyAmbmJzcDsgc3RvcmUgaXQgYXMgc3V=
 j
 aDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGhhc2gtc2V0ISBvc3gta2V=
 5
 Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gYyldICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7ICZuYnNwOyZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgW2Vsc2U8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyh=
 k
 ZWZpbmUgbWNrIChoYXNoLXJlZiBvc3gta2V5Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gI2Y=
 p
 KSAmbmJzcDsgOyBvdGhlcndpc2UgZmluZCZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7KHdoZW4gbWNrIChoYXNoLXNldC1uZXchIGNoYXItdG8tbWFpbi1jaGFyLWt=
 l
 eS1odCBjIG1jaykpXSkpKSAmbmJzcDs7ICZuYnNwOyBhbmQgc3RvcmUgbWFpbiBjaGFyIGtleTw=
 v
 ZGl2PjwvZGl2PjxkaXY+YGBgPC9kaXY+" style=3D"min-height:0;width:0;max-height:=
 0;max-width:0;overflow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</=
 div></div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmai=
 l_quote">On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <span dir=
 =3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jen=
 saxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quot=
 e" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">=
 <div dir=3D"ltr"><div>That sounds as something that should work.</div>As fa=
 r as I know=C2=A0key-translate is only called when you actually press a key=
 .<br>So I am surprised that you see the error when DrRacket starts.<br><br>=
 I&#39;ll need to look up Ukelele.<span><font color=3D"#888888"><br><br>/Jen=
 s Axel<br><div><div><br></div><div><br></div></div></font></span></div><div=
 ><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 =
 18:11 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:ra=
 don.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<=
 br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left=
 :1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">It&#39;s not intentional=
 ly. Perhaps they are an artifact created by Ukelele. Is there an easy way t=
 o determine which key is producing the surrogate code point(s)?<div><br></d=
 iv><div>The first thing I think of is the dead keys used for creating accen=
 ts in OS X, but these are also present in the default keyboard layout. The =
 only thing I have done with them is move the Alt+E dead key to Alt+Shift+`.=
 </div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_qu=
 ote">On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <span dir=3D"lt=
 r">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@=
 soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" sty=
 le=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div d=
 ir=3D"ltr"><span style=3D"font-size:12.8px">Here is what I have so far:</sp=
 an><div><span style=3D"font-size:12.8px"><br></span></div><div>1) integer-&=
 gt;char is being called with an input that aren&#39;t accepted</div><div>2)=
  the caller is=C2=A0<span style=3D"color:rgb(51,51,51);font-family:consolas=
 ,&quot;liberation mono&quot;,menlo,courier,monospace;font-size:12px;line-he=
 ight:20px;white-space:pre-wrap">key-translate </span>a low level function w=
 hose job</div><div>=C2=A0 =C2=A0 is to translate (physical) keycodes into c=
 haracters using=C2=A0</div><div>=C2=A0 =C2=A0 a keyboard layout.=C2=A0</div=
 ><div>3) it is a bug in key-translate that integer-&gt;char is called with<=
 /div><div>=C2=A0 =C2=A0 an integer that doesn&#39;t correspond to a charact=
 er</div><div><br></div><div>4) From=C2=A0</div><div><span><span style=3D"fo=
 nt-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 integer-&gt;char: contra=
 ct violation</span><br style=3D"font-size:12.8px"><span style=3D"font-size:=
 12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 expected: (and/c (integer-in 0 #=
 x10FFFF) (not/c (integer-in #xD800 #xDFFF)))</span><br style=3D"font-size:1=
 2.8px"><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 given: 55357<br></span></span>=C2=A0 =C2=A0 we learn that the operating sys=
 tem translated a keycode to the codepoint=C2=A0<span style=3D"font-size:12.=
 8px">55357.</span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0=
  That code point lies in the range D800 to DFFF which are not accepted by</=
 span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 integer-&gt;=
 char</span></div><div><span style=3D"font-size:12.8px">5) That range is cal=
 led &quot;High Surrogates&quot;=C2=A0</span></div><div><span style=3D"font-=
 size:12.8px">=C2=A0 =C2=A0 From=C2=A0</span><span style=3D"font-size:12.8px=
 "><a href=3D"http://www.alanwood.net/unicode/high_surrogates.html" target=
 =3D"_blank">http://www.alanwood.net/u<wbr>nicode/high_surrogates.html</a><b=
 r></span><span style=3D"font-size:12.8px"><br></span><span style=3D"color:r=
 gb(0,0,0);font-family:times;font-size:16px;line-height:19.2px;background-co=
 lor:rgb(255,255,242)">Surrogate code points are intended to allow mapping o=
 f additional character planes into the 16-bit Unicode system, thus allowing=
  more than 65,536 characters to be represented. The individual surrogate co=
 de points do not represent characters; they are intended to be used in pair=
 s, a high code point followed by a low code point, to stand in for a charac=
 ter in one of the supplementary planes. Their use is restricted to UTF-16. =
 They can be used for characters in=C2=A0</span><a href=3D"http://www.alanwo=
 od.net/unicode/linear_b_syllabary.html" style=3D"color:rgb(128,0,128);font-=
 family:times;font-size:16px;line-height:19.2px;background-color:rgb(255,255=
 ,242)" target=3D"_blank">Linear B Syllabary</a><span style=3D"color:rgb(0,0=
 ,0);font-family:times;font-size:16px;line-height:19.2px;background-color:rg=
 b(255,255,242)">=C2=A0and higher-numbered ranges.<br></span></div><div><spa=
 n style=3D"font-size:12.8px"><br></span></div><div><br></div><div>Is it int=
 entionally that your layout produces such code points?</div><span><font col=
 or=3D"#888888"><div><br></div><div>/Jens Axel</div><div><br></div><div><br>=
 </div></font></span></div><div><div><div class=3D"gmail_extra"><br><div cla=
 ss=3D"gmail_quote">2016-09-08 17:50 GMT+02:00 Radon Rosborough <span dir=3D=
 "ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.n=
 eon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D=
 "margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D=
 "ltr">Before. If I switch after I launch DrRacket, it appears to work OK, a=
 lthough I haven&#39;t tried anything substantial to make sure everything wo=
 rks.</div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quot=
 e">On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr"=
 >&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@so=
 egaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=
 =3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=
 =3D"ltr">Did you switch to your keyboard layout before or after starting Dr=
 Racket?<div><br></div><div>/Jens Axel</div><div><br></div></div><div class=
 =3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:32 GMT+02:00 =
  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_b=
 lank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_qu=
 ote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex=
 ">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 
 --001a114127905c9fd1053c035fdc--
From: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
To: Radon Rosborough <radon.neon@gmail.com>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Fri, 9 Sep 2016 13:36:28 +0200

 --001a11436926ac2d4d053c118e33
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 Hi Radon,
 
 This translates all characters in the range from #xD800 to #xDFFF to a
 single space.
 This is probably not "The Right Way" to handle surrogates, but at least you
 should be able to start DrRacket.
 
 (list->string (for/list ([i (in-range n)])
                   (define j (ptr-ref output-chars _UniChar i))
                   (if (<=3D #xD800 j #xDFFF)
                       #\space
                       (integer->char j))))
 
 /Jens Axel
 
 
 2016-09-08 20:40 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 
 > Now I get
 >
 > list->string: contract violation
 >   expected: (listof char?)
 >   given: '("" "")
 >   context...:
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt:555:0: for-loop
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt:555:0: for-loop
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key=
 -translate.rkt: [running body]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/win=
 dow.rkt: [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ite=
 m.rkt: [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/but=
 ton.rkt: [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/pla=
 tform.rkt: [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform.=
 rkt: [running body]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt: =
 [traversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt: [t=
 raversing imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [traversin=
 g imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [traversin=
 g imports]
 >    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [tra=
 versing imports]
 >    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt: [=
 traversing imports]
 >
 > It looks like the empty strings need to be removed from the list before
 > being passed to list->string.
 > =E2=80=8B
 >
 > On Thu, Sep 8, 2016 at 11:33 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaar=
 d.net>
 > wrote:
 >
 >> Sorry. I missed that i was used in for/list.
 >> Try:
 >>
 >> (list->string (for/list ([i (in-range n)]) (define j (ptr-ref
 >> output-chars _UniChar i)) (if (<=3D #xD800 j #xDFFF) "" (integer->char j=
 )))))
 >>
 >> 2016-09-08 20:24 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>
 >>> Strangely, I get the following error (with both my keyboard layout and
 >>> the standard one):
 >>>
 >>> i: undefined;
 >>>  cannot use before initialization
 >>>   context...:
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/k=
 ey-translate.rkt:495:16: for-loop
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/k=
 ey-translate.rkt:555:0: for-loop
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/k=
 ey-translate.rkt: [running body]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/w=
 indow.rkt: [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/i=
 tem.rkt: [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/b=
 utton.rkt: [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/p=
 latform.rkt: [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platfor=
 m.rkt: [running body]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt=
 : [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt: =
 [traversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [travers=
 ing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [travers=
 ing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [t=
 raversing imports]
 >>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt:=
  [traversing imports]
 >>>
 >>> I am just getting started with Racket so I don=E2=80=99t know why this =
 would
 >>> be=E2=80=94it looks like i is introduced as a local binding to me. Here=
  is what
 >>> my modified key-translate looks like:
 >>>
 >>> (define (key-translate virtual-key-code
 >>>                        #:key-action            [key-action         kUCK=
 eyActionDown]
 >>>                        #:modifier-key-state    [modifier-key-state     =
            0]  ; no modifier
 >>>                        #:keyboard-type         [keyboard-type        (L=
 MGetKbdType)]
 >>>                        #:key-translate-options [key-translate-options  =
           #f]
 >>>                        #:dead-key-state        [dead-key-state         =
           #f]  ; no prev state
 >>>                        #:keyboard-layout       [layout-in              =
      'cached]) ; use cached
 >>>   (define actual-string-length (box 0))
 >>>   (set! key-translate-options
 >>>         (or key-translate-options                ; use user settings if=
  provided
 >>>             (if dead-key-state                   ; otherwise if user ha=
 s set dead-key-state,
 >>>                 0                                ; then take dead-keys =
 into account
 >>>                 kUCKeyTranslateNoDeadKeysFlag))) ; else ignore dead key=
 s
 >>>
 >>>   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state)=
 ))
 >>>
 >>>   (define layout
 >>>     (case layout-in
 >>>       ; use cached
 >>>       [(cached)    (cond
 >>>                     [cached-keyboard-layout =3D> values]
 >>>                     [else   (set! cached-keyboard-layout (get-current-k=
 eyboard-layout))
 >>>                             cached-keyboard-layout])]
 >>>       ; refresh cache
 >>>       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-=
 layout))
 >>>                     cached-keyboard-layout]
 >>>       ; use provided
 >>>       [else          layout-in]))
 >>>
 >>>   (UCKeyTranslate layout
 >>>                   virtual-key-code
 >>>                   key-action
 >>>                   (bitwise-and (>> modifier-key-state 8) #xFF)
 >>>                   keyboard-type
 >>>                   key-translate-options
 >>>                   dead-key-state
 >>>                   max-string-length
 >>>                   actual-string-length
 >>>                   output-chars)
 >>>   ; get the number of characters returned, and convert to string
 >>>   (define n (max 0 (min max-string-length (unbox actual-string-length))=
 ))
 >>>   (list->string (for/list ([i (in-range n)])
 >>>                   (define i (ptr-ref output-chars _UniChar i))
 >>>                   (if (<=3D  #xD800 i #xDFFF)
 >>>                       ""
 >>>                       (integer->char i)))))
 >>>
 >>> =E2=80=8B
 >>>
 >>> On Thu, Sep 8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaa=
 rd.net
 >>> > wrote:
 >>>
 >>>> Progress - so key-translate does get called.
 >>>>
 >>>> The two last lines of key-translate are:
 >>>>
 >>>>     (list->string (for/list ([i (in-range n)])
 >>>>                        (integer->char (ptr-ref output-chars _UniChar
 >>>> i)))))
 >>>>
 >>>> Can you test what happens if you change it to:
 >>>>
 >>>>     (list->string (for/list ([i (in-range n)])
 >>>>                            (define i (ptr-ref output-chars _UniChar i)=
 )
 >>>>                            (if (<=3D  #xD800 i #xDFFF)
 >>>>                                 ""
 >>>>                                (integer->char i)))))
 >>>>
 >>>> ?
 >>>>
 >>>>
 >>>> 2016-09-08 18:23 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>
 >>>>> It looks to me like the reason for this is that the gui-lib package
 >>>>> (loaded for anything graphical, I presume, including launching DrRack=
 et)
 >>>>> fills out a hash table for keyboard mappings eagerly (on package load=
 ). The
 >>>>> following is from line 551 of /Applications/Racket
 >>>>> v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 >>>>>
 >>>>> ;; fill in hash tables
 >>>>> (for* ([modsyms all-modifier-combinations]                           =
  ; go through all physical key
 >>>>>        [(kvc n) virtual-key-code-name-to-value-ht])                  =
  ; and modifier combinations
 >>>>>   (define modks (modifier-symbol-list->integer modsyms))
 >>>>>   (define s (key-translate n #:modifier-key-state modks))            =
  ; translate to a char
 >>>>>   (unless (string=3D? s "")                                          =
    ; unless key is dead
 >>>>>     (define c (string-ref s 0))
 >>>>>     (hash-set-new! char-to-osx-keycode+modifiers-ht c                =
  ; store where char is from
 >>>>>                    (list kvc n modsyms modks))                       =
  ; (simplest is kept)
 >>>>>     (cond
 >>>>>       [(null? modsyms)                                               =
 ; also, if it is a main char
 >>>>>        (hash-set! char-to-main-char-key-ht c c)                      =
  ;   store it as such
 >>>>>        (hash-set! osx-keycode-to-main-char-key-ht n c)]              =
  ;
 >>>>>       [else
 >>>>>        (define mck (hash-ref osx-keycode-to-main-char-key-ht n #f))  =
  ; otherwise find
 >>>>>        (when mck (hash-set-new! char-to-main-char-key-ht c mck))]))) =
  ;   and store main char key
 >>>>>
 >>>>> =E2=80=8B
 >>>>>
 >>>>> On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <
 >>>>> jensaxel@soegaard.net> wrote:
 >>>>>
 >>>>>> That sounds as something that should work.
 >>>>>> As far as I know key-translate is only called when you actually pres=
 s
 >>>>>> a key.
 >>>>>> So I am surprised that you see the error when DrRacket starts.
 >>>>>>
 >>>>>> I'll need to look up Ukelele.
 >>>>>>
 >>>>>> /Jens Axel
 >>>>>>
 >>>>>>
 >>>>>>
 >>>>>> 2016-09-08 18:11 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>>>
 >>>>>>> It's not intentionally. Perhaps they are an artifact created by
 >>>>>>> Ukelele. Is there an easy way to determine which key is producing t=
 he
 >>>>>>> surrogate code point(s)?
 >>>>>>>
 >>>>>>> The first thing I think of is the dead keys used for creating
 >>>>>>> accents in OS X, but these are also present in the default keyboard=
  layout.
 >>>>>>> The only thing I have done with them is move the Alt+E dead key to
 >>>>>>> Alt+Shift+`.
 >>>>>>>
 >>>>>>> On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <
 >>>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>>
 >>>>>>>> Here is what I have so far:
 >>>>>>>>
 >>>>>>>> 1) integer->char is being called with an input that aren't accepte=
 d
 >>>>>>>> 2) the caller is key-translate a low level function whose job
 >>>>>>>>     is to translate (physical) keycodes into characters using
 >>>>>>>>     a keyboard layout.
 >>>>>>>> 3) it is a bug in key-translate that integer->char is called with
 >>>>>>>>     an integer that doesn't correspond to a character
 >>>>>>>>
 >>>>>>>> 4) From
 >>>>>>>>           integer->char: contract violation
 >>>>>>>>           expected: (and/c (integer-in 0 #x10FFFF) (not/c
 >>>>>>>> (integer-in #xD800 #xDFFF)))
 >>>>>>>>           given: 55357
 >>>>>>>>     we learn that the operating system translated a keycode to the
 >>>>>>>> codepoint 55357.
 >>>>>>>>     That code point lies in the range D800 to DFFF which are not
 >>>>>>>> accepted by
 >>>>>>>>     integer->char
 >>>>>>>> 5) That range is called "High Surrogates"
 >>>>>>>>     From http://www.alanwood.net/unicode/high_surrogates.html
 >>>>>>>>
 >>>>>>>> Surrogate code points are intended to allow mapping of additional
 >>>>>>>> character planes into the 16-bit Unicode system, thus allowing mor=
 e than
 >>>>>>>> 65,536 characters to be represented. The individual surrogate code=
  points
 >>>>>>>> do not represent characters; they are intended to be used in pairs=
 , a high
 >>>>>>>> code point followed by a low code point, to stand in for a charact=
 er in one
 >>>>>>>> of the supplementary planes. Their use is restricted to UTF-16. Th=
 ey can be
 >>>>>>>> used for characters in Linear B Syllabary
 >>>>>>>> <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 >>>>>>>> higher-numbered ranges.
 >>>>>>>>
 >>>>>>>>
 >>>>>>>> Is it intentionally that your layout produces such code points?
 >>>>>>>>
 >>>>>>>> /Jens Axel
 >>>>>>>>
 >>>>>>>>
 >>>>>>>>
 >>>>>>>> 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>=
 :
 >>>>>>>>
 >>>>>>>>> Before. If I switch after I launch DrRacket, it appears to work
 >>>>>>>>> OK, although I haven't tried anything substantial to make sure ev=
 erything
 >>>>>>>>> works.
 >>>>>>>>>
 >>>>>>>>> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <
 >>>>>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>>>>
 >>>>>>>>>> Did you switch to your keyboard layout before or after starting
 >>>>>>>>>> DrRacket?
 >>>>>>>>>>
 >>>>>>>>>> /Jens Axel
 >>>>>>>>>>
 >>>>>>>>>>
 >>>>>>>>>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>>>>>>>>
 >>>>>>>>>>> A new problem report is waiting at
 >>>>>>>>>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>>>>>>>>
 >>>>>>>>>>> Reported by Radon Rosborough for release: 6.6
 >>>>>>>>>>>
 >>>>>>>>>>> *** Description:
 >>>>>>>>>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>>>>>>>>> keyboard layout. If I am using my custom keyboard layout (but n=
 ot when
 >>>>>>>>>>> using the default keyboard layout), then when:
 >>>>>>>>>>>
 >>>>>>>>>>> - launching the 'drracket' executable,
 >>>>>>>>>>> - opening the DrRacket application, or
 >>>>>>>>>>> - using geiser in Emacs, compiling a file with '#lang slideshow=
 '
 >>>>>>>>>>> in it,
 >>>>>>>>>>>
 >>>>>>>>>>> Racket crashes immediately with the following error:
 >>>>>>>>>>>
 >>>>>>>>>>> integer->char: contract violation
 >>>>>>>>>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >>>>>>>>>>> #xD800 #xDFFF)))
 >>>>>>>>>>>   given: 55357
 >>>>>>>>>>>   context...:
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx=
 /cocoa/window.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx=
 /cocoa/item.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx=
 /cocoa/button.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx=
 /cocoa/platform.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx=
 /platform.rkt:
 >>>>>>>>>>> [running body]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/ke=
 rnel.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mr=
 ed.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base=
 .rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drrac=
 ket.rkt:
 >>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>
 >>>>>>>>>>> *** How to repeat:
 >>>>>>>>>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can
 >>>>>>>>>>> also reproduce the problem on a virtual machine with a fresh in=
 stall of El
 >>>>>>>>>>> Capitan 10.11.
 >>>>>>>>>>>
 >>>>>>>>>>> - Download my custom keyboard layout:
 >>>>>>>>>>> https://drive.google.com/open?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U
 >>>>>>>>>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard
 >>>>>>>>>>> Layouts".
 >>>>>>>>>>> - In System Preferences > Keyboard > Input Sources, add "My
 >>>>>>>>>>> Keyboard Layout" as an input source.
 >>>>>>>>>>> - Make sure the "Show Input menu in menu bar" checkbox is
 >>>>>>>>>>> checked.
 >>>>>>>>>>> - In the Input menu in the menu bar, select "My Keyboard Layout=
 ".
 >>>>>>>>>>> - Launch DrRacket. It should crash (and provide the above error
 >>>>>>>>>>> message if it was launched from the command line).
 >>>>>>>>>>>
 >>>>>>>>>>> *** Environment:
 >>>>>>>>>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin Kernel
 >>>>>>>>>>> Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.=
 11~1/RELEASE_X86_64
 >>>>>>>>>>> x86_64" (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>>>>>>>>> Human Language: english
 >>>>>>>>>>> (current-memory-use) 252260656
 >>>>>>>>>>> raco pkg (show):
 >>>>>>>>>>> Installation-wide:
 >>>>>>>>>>>  Package            Checksum             Source
 >>>>>>>>>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>>>>>>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>>>>>>>>  [189 auto-installed packages not shown]
 >>>>>>>>>>> User-specific for installation "6.6":
 >>>>>>>>>>>  [none]
 >>>>>>>>>>>
 >>>>>>>>>>>
 >>>>>>>>>>>
 >>>>>>>>>>> Collections:
 >>>>>>>>>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>>>>>>>>  (non-existent-path))
 >>>>>>>>>>> ("/Applications/Racket v6.6/collects"
 >>>>>>>>>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>>>>>>>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" =
 "racket"
 >>>>>>>>>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xml=
 "))
 >>>>>>>>>>>
 >>>>>>>>>>> Recent Internal Errors:
 >>>>>>>>>>> Computer Language: (("Initial language" "No language chosen")
 >>>>>>>>>>> #(#t print mixed-fraction-e #f #t debug))
 >>>>>>>>>>>
 >>>>>>>>>>>
 >>>>>>>>>>
 >>>>>>>>>>
 >>>>>>>>>> --
 >>>>>>>>>> --
 >>>>>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>>>>
 >>>>>>>>>>
 >>>>>>>>>
 >>>>>>>>
 >>>>>>>>
 >>>>>>>> --
 >>>>>>>> --
 >>>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>>
 >>>>>>>>
 >>>>>>>
 >>>>>>
 >>>>>>
 >>>>>> --
 >>>>>> --
 >>>>>> Jens Axel S=C3=B8gaard
 >>>>>>
 >>>>>>
 >>>>>
 >>>>
 >>>>
 >>>> --
 >>>> --
 >>>> Jens Axel S=C3=B8gaard
 >>>>
 >>>>
 >>>
 >>
 >>
 >> --
 >> --
 >> Jens Axel S=C3=B8gaard
 >>
 >>
 >
 
 
 --=20
 --=20
 Jens Axel S=C3=B8gaard
 
 --001a11436926ac2d4d053c118e33
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr">Hi Radon,<div><br></div><div>This translates all character=
 s in the range from #xD800 to #xDFFF to a single space.</div><div>This is p=
 robably not &quot;The Right Way&quot; to handle surrogates, but at least yo=
 u</div><div>should be able to start DrRacket.<br><div><br></div><div><div>(=
 list-&gt;string (for/list ([i (in-range n)])</div><div>=C2=A0 =C2=A0 =C2=A0=
  =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 (define j (ptr-ref output-chars =
 _UniChar i))</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 (if (&lt;=3D #xD800 j #xDFFF)</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 #\space</div><div>=C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 (=
 integer-&gt;char j))))<br><br>/Jens Axel</div></div></div><div><br></div></=
 div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 20=
 :40 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:rado=
 n.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<br=
 ><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1=
 px #ccc solid;padding-left:1ex"><div dir=3D"ltr"><div><p style=3D"margin:0p=
 x 0px 1.2em!important">Now I get</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">list-&gt;string: con=
 tract violation
   expected: (listof char?)
   given: &#39;(&quot;&quot; &quot;&quot;)
   context...:
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 key-<wbr>translate.rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 key-<wbr>translate.rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 key-<wbr>translate.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 window.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 item.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 button.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/cocoa/=
 platform.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/wx/platfo=
 rm.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/kernel.rk=
 t: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>private/mred.rkt:=
  [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>mred.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/<wbr>main.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/<wbr>racket/gui/base.rkt: [=
 traversing imports]
    /Applications/Racket v6.6/share/pkgs/drracket/<wbr>drracket/drracket.rkt=
 : [traversing imports]
 </code></pre><p style=3D"margin:0px 0px 1.2em!important">It looks like the =
 empty strings need to be removed from the list before being passed to <code=
  style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospa=
 ce;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px soli=
 d rgb(234,234,234);border-radius:3px;display:inline;background-color:rgb(24=
 8,248,248)">list-&gt;string</code>.</p>
 <div title=3D"MDH:Tm93IEkgZ2V0PGRpdj48YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2P=
 jxkaXY+bGlzdC0mZ3Q7
 c3RyaW5nOiBjb250cmFjdCB2aW9sYXRpb248L2Rpdj48ZGl2PiZuYnNwOyBleHBlY3RlZDogKGx=
 p
 c3RvZiBjaGFyPyk8L2Rpdj48ZGl2PiZuYnNwOyBnaXZlbjogJygiIiAiIik8L2Rpdj48ZGl2PiZ=
 u
 YnNwOyBjb250ZXh0Li4uOjwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmF=
 j
 a2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJ=
 h
 bnNsYXRlLnJrdDo1NTU6MDogZm9yLWxvb3A8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGl=
 j
 YXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29=
 j
 b2Eva2V5LXRyYW5zbGF0ZS5ya3Q6NTU1OjA6IGZvci1sb29wPC9kaXY+PGRpdj4mbmJzcDsgJm5=
 i
 c3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml=
 2
 YXRlL3d4L2NvY29hL2tleS10cmFuc2xhdGUucmt0OiBbcnVubmluZyBib2R5XTwvZGl2PjxkaXY=
 +
 Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGl=
 i
 L21yZWQvcHJpdmF0ZS93eC9jb2NvYS93aW5kb3cucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9pdGVtLnJrdDogW3RyYXZlcnNpbmcgaW1=
 w
 b3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3N=
 o
 YXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvYnV0dG9uLnJrdDogW3RyYXZ=
 l
 cnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2t=
 l
 dCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvcGxhdGZvcm0=
 u
 cmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWN=
 h
 dGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9wbGF=
 0
 Zm9ybS5ya3Q6IFtydW5uaW5nIGJvZHldPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F=
 0
 aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL2tlcm5lbC5=
 y
 a3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F=
 0
 aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL21yZWQucmt=
 0
 OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGl=
 v
 bnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvbXJlZC5ya3Q6IFt0cmF2ZXJ=
 z
 aW5nIGltcG9ydHNdPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQ=
 g
 djYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9tYWluLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J=
 0
 c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJ=
 l
 L3BrZ3MvZ3VpLWxpYi9yYWNrZXQvZ3VpL2Jhc2Uucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9kcnJhY2tldC9kcnJhY2tldC9kcnJhY2tldC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9=
 k
 aXY+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl2Pkl0IGxvb2tzIGxpa2U=
 g
 dGhlIGVtcHR5IHN0cmluZ3MgbmVlZCB0byBiZSByZW1vdmVkIGZyb20gdGhlIGxpc3QgYmVmb3J=
 l
 IGJlaW5nIHBhc3NlZCB0byBgbGlzdC0mZ3Q7c3RyaW5nYC48L2Rpdj4=3D" style=3D"min-he=
 ight:0;width:0;max-height:0;max-width:0;overflow:hidden;font-size:0em;paddi=
 ng:0;margin:0">=E2=80=8B</div></div></div><div class=3D"HOEnZb"><div class=
 =3D"h5"><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">On Thu, S=
 ep 8, 2016 at 11:33 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a hre=
 f=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@soegaard.net<=
 /a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:=
 0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">So=
 rry. I missed that i was used in for/list.<div>Try:<br><div><br></div><div>=
 <span style=3D"font-family:consolas,inconsolata,courier,monospace;font-size=
 :10.88px;line-height:15.36px;white-space:pre-wrap;background-color:rgb(248,=
 248,248)">(list-&gt;string (for/list ([i (in-range n)])
                   (define j (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 j #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char j)))))</span><br></div></div></div>=
 <div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09=
 -08 20:24 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailt=
 o:radon.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</spa=
 n>:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-=
 left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr"><div><p style=3D"mar=
 gin:0px 0px 1.2em!important">Strangely, I get the following error (with bot=
 h my keyboard layout and the standard one):</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">i: undefined;
  cannot use before initialization
   context...:
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt:495:16: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 window.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 item.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 button.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 platform.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/platfo=
 rm.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/kernel.rk=
 t: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/mred.rkt:=
  [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/base.rkt: [=
 traversing imports]
    /Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/drracket.rkt=
 : [traversing imports]
 </code></pre><p style=3D"margin:0px 0px 1.2em!important">I am just getting =
 started with Racket so I don=E2=80=99t know why this would be=E2=80=94it lo=
 oks like <code style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,C=
 ourier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;b=
 order:1px solid rgb(234,234,234);border-radius:3px;display:inline;backgroun=
 d-color:rgb(248,248,248)">i</code> is introduced as a local binding to me. =
 Here is what my modified <code style=3D"font-size:0.85em;font-family:Consol=
 as,Inconsolata,Courier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-=
 space:pre-wrap;border:1px solid rgb(234,234,234);border-radius:3px;display:=
 inline;background-color:rgb(248,248,248)">key-translate</code> looks like:<=
 /p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">(define (key-transla=
 te virtual-key-code
                        #:key-action            [key-action         kUCKeyAc=
 tionDown]
                        #:modifier-key-state    [modifier-key-state         =
        0]  ; no modifier
                        #:keyboard-type         [keyboard-type        (LMGet=
 KbdType)]
                        #:key-translate-options [key-translate-options      =
       #f]
                        #:dead-key-state        [dead-key-state             =
       #f]  ; no prev state
                        #:keyboard-layout       [layout-in                  =
  &#39;cached]) ; use cached
   (define actual-string-length (box 0))
   (set! key-translate-options
         (or key-translate-options                ; use user settings if pro=
 vided
             (if dead-key-state                   ; otherwise if user has se=
 t dead-key-state,
                 0                                ; then take dead-keys into=
  account
                 kUCKeyTranslateNoDeadKeysFlag)<wbr>)) ; else ignore dead ke=
 ys
 
   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state))<wb=
 r>)
 
   (define layout
     (case layout-in
       ; use cached
       [(cached)    (cond
                     [cached-keyboard-layout =3D&gt; values]
                     [else   (set! cached-keyboard-layout (get-current-keybo=
 ard-layout))
                             cached-keyboard-layout])]
       ; refresh cache
       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-layo=
 ut))
                     cached-keyboard-layout]
       ; use provided
       [else          layout-in]))
 
   (UCKeyTranslate layout
                   virtual-key-code
                   key-action
                   (bitwise-and (&gt;&gt; modifier-key-state 8) #xFF)
                   keyboard-type
                   key-translate-options
                   dead-key-state
                   max-string-length
                   actual-string-length
                   output-chars)
   ; get the number of characters returned, and convert to string
   (define n (max 0 (min max-string-length (unbox actual-string-length))))
   (list-&gt;string (for/list ([i (in-range n)])
                   (define i (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 i #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char i)))))
 </code></pre><div title=3D"MDH:U3RyYW5nZWx5LCBJIGdldCB0aGUgZm9sbG93aW5nIGVy=
 cm9yICh3aXRoIGJvdGggbXkga2V5Ym9h
 cmQgbGF5b3V0IGFuZCB0aGUgc3RhbmRhcmQgb25lKTo8ZGl2Pjxicj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2PjxkaXY+PGRpdj5pOiB1bmRlZmluZWQ7PC9kaXY+PGRpdj4mbmJzcDtjYW5ub3QgdXNlIGJ=
 l
 Zm9yZSBpbml0aWFsaXphdGlvbjwvZGl2PjxkaXY+Jm5ic3A7IGNvbnRleHQuLi46PC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1=
 s
 aWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2xhdGUucmt0OjQ5NToxNjogZm9yLWx=
 v
 b3A8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJ=
 l
 L3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2Eva2V5LXRyYW5zbGF0ZS5ya3Q6NTU=
 1
 OjA6IGZvci1sb29wPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQ=
 g
 djYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2x=
 h
 dGUucmt0OiBbcnVubmluZyBib2R5XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGl=
 v
 bnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9=
 3
 aW5kb3cucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS9=
 3
 eC9jb2NvYS9pdGVtLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3B=
 y
 aXZhdGUvd3gvY29jb2EvYnV0dG9uLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl=
 2
 PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWx=
 p
 Yi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvcGxhdGZvcm0ucmt0OiBbdHJhdmVyc2luZyBpbXBvcnR=
 z
 XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmU=
 v
 cGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9wbGF0Zm9ybS5ya3Q6IFtydW5uaW5nIGJvZHl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL2tlcm5lbC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHN=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL21yZWQucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvbXJlZC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWI=
 v
 bXJlZC9tYWluLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJ=
 z
 cDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9yYWNrZXQvZ3V=
 p
 L2Jhc2Uucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9kcnJhY2tldC9kcnJhY2tldC9kcnJ=
 h
 Y2tldC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PC9kaXY+PGRpdj5gYGA8L2Rpdj4=
 8
 ZGl2Pjxicj48L2Rpdj48ZGl2PkkgYW0ganVzdCBnZXR0aW5nIHN0YXJ0ZWQgd2l0aCBSYWNrZXQ=
 g
 c28gSSBkb24ndCBrbm93IHdoeSB0aGlzIHdvdWxkIGJl4oCUaXQgbG9va3MgbGlrZSBgaWAgaXM=
 g
 aW50cm9kdWNlZCBhcyBhIGxvY2FsIGJpbmRpbmcgdG8gbWUuIEhlcmUgaXMgd2hhdCBteSBtb2R=
 p
 ZmllZCBga2V5LXRyYW5zbGF0ZWAgbG9va3MgbGlrZTo8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl=
 2
 PmBgYDwvZGl2PjxkaXY+PGRpdj4oZGVmaW5lIChrZXktdHJhbnNsYXRlIHZpcnR1YWwta2V5LWN=
 v
 ZGU8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzprZXktYWN0aW9uICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7W2tleS1hY3Rpb24gJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7IGtVQ0tleUFjdGlvbkRvd25dPC9kaXY+PGRpdj4mbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyM6bW9kaWZpZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDtbbW9kaWZ=
 p
 ZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDswXSAmbmJzcDs7IG5vIG1vZGlmaWVyPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyM6a2V5Ym9hcmQtdHlwZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 W2tleWJvYXJkLXR5cGUgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KExNR2V0S2JkVHlwZSl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyM6a2V5LXRyYW5zbGF0ZS1vcHR=
 p
 b25zIFtrZXktdHJhbnNsYXRlLW9wdGlvbnMgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsjZl08L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzpkZWF=
 k
 LWtleS1zdGF0ZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDtbZGVhZC1rZXktc3RhdGUgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgI2ZdICZuYnNwOzsgbm8gcHJldiBzdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsjOmtleWJvYXJkLWxheW91dCAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbbGF5b3V0LWl=
 u
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICdjYWNoZWRdKSA7IHVzZSBjYWNoZWQ8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGF=
 j
 dHVhbC1zdHJpbmctbGVuZ3RoIChib3ggMCkpPC9kaXY+PGRpdj4mbmJzcDsgKHNldCEga2V5LXR=
 y
 YW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKG9=
 y
 IGtleS10cmFuc2xhdGUtb3B0aW9ucyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyB1c2UgdXNlciBzZXR0aW5ncyBpZiBwcm92aWRlZDwvZGl=
 2
 PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGlmIGRlYWQ=
 t
 a2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7IDsgb3RoZXJ3aXNlIGlmIHVzZXIgaGFzIHNldCBkZWFkLWtleS1zdGF=
 0
 ZSw8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgMCAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDs7IHRoZW4gdGFrZSBkZWFkLWtleXMgaW50byBhY2NvdW50PC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IGt=
 V
 Q0tleVRyYW5zbGF0ZU5vRGVhZEtleXNGbGFnKSkpIDsgZWxzZSBpZ25vcmUgZGVhZCBrZXlzPC9=
 k
 aXY+PGRpdj48YnI+PC9kaXY+PGRpdj4mbmJzcDsgKHNldCEgZGVhZC1rZXktc3RhdGUgKG9yIGR=
 l
 YWQta2V5LXN0YXRlIChtYWtlLWluaXRpYWwtZGVhZC1rZXktc3RhdGUpKSk8L2Rpdj48ZGl2Pjx=
 i
 cj48L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGxheW91dDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnN=
 w
 OyAoY2FzZSBsYXlvdXQtaW48L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IDsgdXNlIGN=
 h
 Y2hlZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgWyhjYWNoZWQpICZuYnNwOyAmbmJ=
 z
 cDsoY29uZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IFtjYWNoZWQta2V5Ym9hcmQtbGF5b3V0ID0=
 m
 Z3Q7IHZhbHVlc108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbZWxzZSAmbmJzcDsgKHNldCEgY2F=
 j
 aGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V5Ym9hcmQtbGF5b3V0KSk8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgY2FjaGVkLWtleWJ=
 v
 YXJkLWxheW91dF0pXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyByZWZyZXNoIGN=
 h
 Y2hlPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyBbKCNmKSAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgKHNldCEgY2FjaGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V=
 5
 Ym9hcmQtbGF5b3V0KSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBjYWNoZWQta2V5Ym9hcmQtbGF=
 5
 b3V0XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyB1c2UgcHJvdmlkZWQ8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IFtlbHNlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDtsYXlvdXQtaW5dKSk8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl2PiZuYnNwOyAoVUN=
 L
 ZXlUcmFuc2xhdGUgbGF5b3V0PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyB2aXJ0dWFsLWtleS1jb2RlPC9kaXY=
 +
 PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyBrZXktYWN0aW9uPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAoYml0d2lzZS1hbmQgKCZndDs=
 m
 Z3Q7IG1vZGlmaWVyLWtleS1zdGF0ZSA4KSAjeEZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5Ym9hcmQ=
 t
 dHlwZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5LXRyYW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyBkZWFkLWtleS1zdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgbWF4LXN0cmluZy1sZW5ndGg8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7IGFjdHVhbC1zdHJpbmctbGVuZ3RoPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBvdXRwdXQtY2h=
 h
 cnMpPC9kaXY+PGRpdj4mbmJzcDsgOyBnZXQgdGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIHJldHV=
 y
 bmVkLCBhbmQgY29udmVydCB0byBzdHJpbmc8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIG4gKG1=
 h
 eCAwIChtaW4gbWF4LXN0cmluZy1sZW5ndGggKHVuYm94IGFjdHVhbC1zdHJpbmctbGVuZ3RoKSk=
 p
 KTwvZGl2PjxkaXY+Jm5ic3A7IChsaXN0LSZndDtzdHJpbmcgKGZvci9saXN0IChbaSAoaW4tcmF=
 u
 Z2UgbildKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGRlZmluZSBpIChwdHItcmVmIG91dHB1dC1jaGFycyB=
 f
 VW5pQ2hhciBpKSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IChpZiAoJmx0Oz0gJm5ic3A7I3hEODAwIGkgI3h=
 E
 RkZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAiIjwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAoaW50ZWdlci0mZ3Q7Y2hhciBpKSkpKSk8L2Rpdj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2Pg=3D=3D" style=3D"min-height:0;width:0;max-height:0;max-width:0;overfl=
 ow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</div></div></div><div=
 ><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">On Thu, Sep=
  8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=
 =3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@soegaard.net</=
 a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0=
  0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">Pro=
 gress - so key-translate does get called.<br><br>The two last lines of key-=
 translate are:<br><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/list ([i (in=
 -range n)])=C2=A0</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;char (ptr-ref output-cha=
 rs _UniChar i)))))<br><br>Can you test what happens if you change it to:<br=
 ><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/list ([i (in-range n)])=C2=A0=
 </div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(define i (ptr-ref output-chars _UniChar =
 i))</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(if (&lt;=3D=C2=A0<span style=3D"colo=
 r:rgb(80,0,80);font-size:12.8px">=C2=A0</span><span style=3D"color:rgb(80,0=
 ,80);font-size:12.8px">#xD800 i #xDFFF)</span></div><div><span style=3D"col=
 or:rgb(80,0,80);font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0=
  =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 &quo=
 t;&quot;</span></div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;=
 char i)))))<br><br>?</div><br></div></div><div><div><div class=3D"gmail_ext=
 ra"><br><div class=3D"gmail_quote">2016-09-08 18:23 GMT+02:00 Radon Rosboro=
 ugh <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D=
 "_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail=
 _quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:=
 1ex"><div dir=3D"ltr"><div><p style=3D"margin:0px 0px 1.2em!important">It l=
 ooks to me like the reason for this is that the <code style=3D"font-size:0.=
 85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px 0.15em;p=
 adding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234,234);bor=
 der-radius:3px;display:inline;background-color:rgb(248,248,248)">gui-lib</c=
 ode> package (loaded for anything graphical, I presume, including launching=
  DrRacket) fills out a hash table for keyboard mappings eagerly (on package=
  load). The following is from line 551 of <code style=3D"font-size:0.85em;f=
 ont-family:Consolas,Inconsolata,Courier,monospace;margin:0px 0.15em;padding=
 :0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234,234);border-ra=
 dius:3px;display:inline;background-color:rgb(248,248,248)">/Applications/Ra=
 cket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/key-translate.<wbr>=
 rkt</code>:</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">;; fill in hash tabl=
 es
 (for* ([modsyms all-modifier-combinations]                            ; go =
 through all physical key
        [(kvc n) virtual-key-code-name-to-value<wbr>-ht])                   =
 ; and modifier combinations
   (define modks (modifier-symbol-list-&gt;integer modsyms))
   (define s (key-translate n #:modifier-key-state modks))             ; tra=
 nslate to a char
   (unless (string=3D? s &quot;&quot;)                                      =
        ; unless key is dead
     (define c (string-ref s 0))
     (hash-set-new! char-to-osx-keycode+modifiers-<wbr>ht c                 =
 ; store where char is from
                    (list kvc n modsyms modks))                        ; (si=
 mplest is kept)
     (cond=20
       [(null? modsyms)                                               ; also=
 , if it is a main char
        (hash-set! char-to-main-char-key-ht c c)                       ;   s=
 tore it as such
        (hash-set! osx-keycode-to-main-char-key-h<wbr>t n c)]               =
 ;  =20
       [else
        (define mck (hash-ref osx-keycode-to-main-char-key-h<wbr>t n #f))   =
 ; otherwise find=20
        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;   a=
 nd store main char key
 </code></pre><div title=3D"MDH:SXQgbG9va3MgdG8gbWUgbGlrZSB0aGUgcmVhc29uIGZv=
 ciB0aGlzIGlzIHRoYXQgdGhlIGBndWkt
 bGliYCBwYWNrYWdlIChsb2FkZWQgZm9yIGFueXRoaW5nIGdyYXBoaWNhbCwgSSBwcmVzdW1lLCB=
 p
 bmNsdWRpbmcgbGF1bmNoaW5nIERyUmFja2V0KSBmaWxscyBvdXQgYSBoYXNoIHRhYmxlIGZvciB=
 r
 ZXlib2FyZCBtYXBwaW5ncyBlYWdlcmx5IChvbiBwYWNrYWdlIGxvYWQpLiBUaGUgZm9sbG93aW5=
 n
 IGlzIGZyb20gbGluZSA1NTEgb2YgYC9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJhbnNsYXRlLnJrdGA6PGRpdj4=
 8
 YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2PjxkaXY+OzsgZmlsbCBpbiBoYXNoIHRhYmxlczw=
 v
 ZGl2PjxkaXY+KGZvciogKFttb2RzeW1zIGFsbC1tb2RpZmllci1jb21iaW5hdGlvbnNdICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs7IGdvIHRocm91Z2ggYWxsIHBoeXN=
 p
 Y2FsIGtleTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7WyhrdmMgbikgdml=
 y
 dHVhbC1rZXktY29kZS1uYW1lLXRvLXZhbHVlLWh0XSkgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyBhbmQgbW9kaWZpZXIgY29=
 t
 YmluYXRpb25zPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBtb2RrcyAobW9kaWZpZXItc3ltYm9=
 s
 LWxpc3QtJmd0O2ludGVnZXIgbW9kc3ltcykpPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBzICh=
 r
 ZXktdHJhbnNsYXRlIG4gIzptb2RpZmllci1rZXktc3RhdGUgbW9ka3MpKSAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHRyYW5zbGF0ZSB0byBhIGNoYXI8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAodW5sZXNzIChzdHJpbmc9PyBzICIiKSAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgOyB1bmxlc3Mga2V5IGlzIGRlYWQ8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgKGRlZmluZSBjIChzdHJpbmctcmVmIHMgMCkpPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 IChoYXNoLXNldC1uZXchIGNoYXItdG8tb3N4LWtleWNvZGUrbW9kaWZpZXJzLWh0IGMgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHN0b3J=
 l
 IHdoZXJlIGNoYXIgaXMgZnJvbTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGxpc3Qga3ZjIG4gbW9=
 k
 c3ltcyBtb2RrcykpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyAoc2ltcGxlc3QgaXMga2V=
 w
 dCk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgKGNvbmQmbmJzcDs8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7IFsobnVsbD8gbW9kc3ltcykgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyA7IGFsc28sIGlmIGl0IGlzIGEgbWFpbiBjaGFyPC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsoaGFzaC1zZXQhIGNoYXItdG8tbWFpbi1jaGF=
 y
 LWtleS1odCBjIGMpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyAmbmJzcDsgc3RvcmUgaXQgYXMgc3V=
 j
 aDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGhhc2gtc2V0ISBvc3gta2V=
 5
 Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gYyldICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7ICZuYnNwOyZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgW2Vsc2U8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyh=
 k
 ZWZpbmUgbWNrIChoYXNoLXJlZiBvc3gta2V5Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gI2Y=
 p
 KSAmbmJzcDsgOyBvdGhlcndpc2UgZmluZCZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7KHdoZW4gbWNrIChoYXNoLXNldC1uZXchIGNoYXItdG8tbWFpbi1jaGFyLWt=
 l
 eS1odCBjIG1jaykpXSkpKSAmbmJzcDs7ICZuYnNwOyBhbmQgc3RvcmUgbWFpbiBjaGFyIGtleTw=
 v
 ZGl2PjwvZGl2PjxkaXY+YGBgPC9kaXY+" style=3D"min-height:0;width:0;max-height:=
 0;max-width:0;overflow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</=
 div></div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmai=
 l_quote">On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <span dir=
 =3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jen=
 saxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quot=
 e" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">=
 <div dir=3D"ltr"><div>That sounds as something that should work.</div>As fa=
 r as I know=C2=A0key-translate is only called when you actually press a key=
 .<br>So I am surprised that you see the error when DrRacket starts.<br><br>=
 I&#39;ll need to look up Ukelele.<span><font color=3D"#888888"><br><br>/Jen=
 s Axel<br><div><div><br></div><div><br></div></div></font></span></div><div=
 ><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 =
 18:11 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:ra=
 don.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<=
 br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left=
 :1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">It&#39;s not intentional=
 ly. Perhaps they are an artifact created by Ukelele. Is there an easy way t=
 o determine which key is producing the surrogate code point(s)?<div><br></d=
 iv><div>The first thing I think of is the dead keys used for creating accen=
 ts in OS X, but these are also present in the default keyboard layout. The =
 only thing I have done with them is move the Alt+E dead key to Alt+Shift+`.=
 </div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_qu=
 ote">On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <span dir=3D"lt=
 r">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@=
 soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" sty=
 le=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div d=
 ir=3D"ltr"><span style=3D"font-size:12.8px">Here is what I have so far:</sp=
 an><div><span style=3D"font-size:12.8px"><br></span></div><div>1) integer-&=
 gt;char is being called with an input that aren&#39;t accepted</div><div>2)=
  the caller is=C2=A0<span style=3D"color:rgb(51,51,51);font-family:consolas=
 ,&quot;liberation mono&quot;,menlo,courier,monospace;font-size:12px;line-he=
 ight:20px;white-space:pre-wrap">key-translate </span>a low level function w=
 hose job</div><div>=C2=A0 =C2=A0 is to translate (physical) keycodes into c=
 haracters using=C2=A0</div><div>=C2=A0 =C2=A0 a keyboard layout.=C2=A0</div=
 ><div>3) it is a bug in key-translate that integer-&gt;char is called with<=
 /div><div>=C2=A0 =C2=A0 an integer that doesn&#39;t correspond to a charact=
 er</div><div><br></div><div>4) From=C2=A0</div><div><span><span style=3D"fo=
 nt-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 integer-&gt;char: contra=
 ct violation</span><br style=3D"font-size:12.8px"><span style=3D"font-size:=
 12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 expected: (and/c (integer-in 0 #=
 x10FFFF) (not/c (integer-in #xD800 #xDFFF)))</span><br style=3D"font-size:1=
 2.8px"><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 given: 55357<br></span></span>=C2=A0 =C2=A0 we learn that the operating sys=
 tem translated a keycode to the codepoint=C2=A0<span style=3D"font-size:12.=
 8px">55357.</span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0=
  That code point lies in the range D800 to DFFF which are not accepted by</=
 span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 integer-&gt;=
 char</span></div><div><span style=3D"font-size:12.8px">5) That range is cal=
 led &quot;High Surrogates&quot;=C2=A0</span></div><div><span style=3D"font-=
 size:12.8px">=C2=A0 =C2=A0 From=C2=A0</span><span style=3D"font-size:12.8px=
 "><a href=3D"http://www.alanwood.net/unicode/high_surrogates.html" target=
 =3D"_blank">http://www.alanwood.net/u<wbr>nicode/high_surrogates.html</a><b=
 r></span><span style=3D"font-size:12.8px"><br></span><span style=3D"color:r=
 gb(0,0,0);font-family:times;font-size:16px;line-height:19.2px;background-co=
 lor:rgb(255,255,242)">Surrogate code points are intended to allow mapping o=
 f additional character planes into the 16-bit Unicode system, thus allowing=
  more than 65,536 characters to be represented. The individual surrogate co=
 de points do not represent characters; they are intended to be used in pair=
 s, a high code point followed by a low code point, to stand in for a charac=
 ter in one of the supplementary planes. Their use is restricted to UTF-16. =
 They can be used for characters in=C2=A0</span><a href=3D"http://www.alanwo=
 od.net/unicode/linear_b_syllabary.html" style=3D"color:rgb(128,0,128);font-=
 family:times;font-size:16px;line-height:19.2px;background-color:rgb(255,255=
 ,242)" target=3D"_blank">Linear B Syllabary</a><span style=3D"color:rgb(0,0=
 ,0);font-family:times;font-size:16px;line-height:19.2px;background-color:rg=
 b(255,255,242)">=C2=A0and higher-numbered ranges.<br></span></div><div><spa=
 n style=3D"font-size:12.8px"><br></span></div><div><br></div><div>Is it int=
 entionally that your layout produces such code points?</div><span><font col=
 or=3D"#888888"><div><br></div><div>/Jens Axel</div><div><br></div><div><br>=
 </div></font></span></div><div><div><div class=3D"gmail_extra"><br><div cla=
 ss=3D"gmail_quote">2016-09-08 17:50 GMT+02:00 Radon Rosborough <span dir=3D=
 "ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.n=
 eon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D=
 "margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D=
 "ltr">Before. If I switch after I launch DrRacket, it appears to work OK, a=
 lthough I haven&#39;t tried anything substantial to make sure everything wo=
 rks.</div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quot=
 e">On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr"=
 >&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@so=
 egaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=
 =3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=
 =3D"ltr">Did you switch to your keyboard layout before or after starting Dr=
 Racket?<div><br></div><div>/Jens Axel</div><div><br></div></div><div class=
 =3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:32 GMT+02:00 =
  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_b=
 lank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_qu=
 ote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex=
 ">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div class=3D"gmail_signature" data-smartmail=3D"gmail_signature">-- <br>Je=
 ns Axel S=C3=B8gaard<br><br></div>
 </div>
 
 --001a11436926ac2d4d053c118e33--
From: Radon Rosborough <radon.neon@gmail.com>
To: =?UTF-8?Q?Jens_Axel_S=C3=B8gaard?= <jensaxel@soegaard.net>
Cc: bugs <bugs@racket-lang.org>, nobody <nobody@racket-lang.org>,
        bug-notification <bug-notification@racket-lang.org>
Subject: Re: [racket-bug] all/15347: Racket crashes on launch with some OSX
 keyboard layouts
Date: Fri, 9 Sep 2016 08:09:29 -0700

 --001a114117e2db1a7f053c148a94
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 This appears to work. Thanks!
 
 On Fri, Sep 9, 2016 at 4:36 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaard.n=
 et>
 wrote:
 
 > Hi Radon,
 >
 > This translates all characters in the range from #xD800 to #xDFFF to a
 > single space.
 > This is probably not "The Right Way" to handle surrogates, but at least y=
 ou
 > should be able to start DrRacket.
 >
 > (list->string (for/list ([i (in-range n)])
 >                   (define j (ptr-ref output-chars _UniChar i))
 >                   (if (<=3D #xD800 j #xDFFF)
 >                       #\space
 >                       (integer->char j))))
 >
 > /Jens Axel
 >
 >
 > 2016-09-08 20:40 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >
 >> Now I get
 >>
 >> list->string: contract violation
 >>   expected: (listof char?)
 >>   given: '("" "")
 >>   context...:
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ke=
 y-translate.rkt:555:0: for-loop
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ke=
 y-translate.rkt:555:0: for-loop
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/ke=
 y-translate.rkt: [running body]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/wi=
 ndow.rkt: [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/it=
 em.rkt: [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/bu=
 tton.rkt: [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/pl=
 atform.rkt: [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platform=
 .rkt: [running body]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rkt:=
  [traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt: [=
 traversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [traversi=
 ng imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [traversi=
 ng imports]
 >>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [tr=
 aversing imports]
 >>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt: =
 [traversing imports]
 >>
 >> It looks like the empty strings need to be removed from the list before
 >> being passed to list->string.
 >> =E2=80=8B
 >>
 >> On Thu, Sep 8, 2016 at 11:33 AM, Jens Axel S=C3=B8gaard <jensaxel@soegaa=
 rd.net
 >> > wrote:
 >>
 >>> Sorry. I missed that i was used in for/list.
 >>> Try:
 >>>
 >>> (list->string (for/list ([i (in-range n)]) (define j (ptr-ref
 >>> output-chars _UniChar i)) (if (<=3D #xD800 j #xDFFF) "" (integer->char =
 j)))))
 >>>
 >>> 2016-09-08 20:24 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>
 >>>> Strangely, I get the following error (with both my keyboard layout and
 >>>> the standard one):
 >>>>
 >>>> i: undefined;
 >>>>  cannot use before initialization
 >>>>   context...:
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 key-translate.rkt:495:16: for-loop
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 key-translate.rkt:555:0: for-loop
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 key-translate.rkt: [running body]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 window.rkt: [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 item.rkt: [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 button.rkt: [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/=
 platform.rkt: [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/wx/platfo=
 rm.rkt: [running body]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/kernel.rk=
 t: [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/mred.rkt:=
  [traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt: [traver=
 sing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt: [traver=
 sing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/base.rkt: [=
 traversing imports]
 >>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drracket.rkt=
 : [traversing imports]
 >>>>
 >>>> I am just getting started with Racket so I don=E2=80=99t know why this=
  would
 >>>> be=E2=80=94it looks like i is introduced as a local binding to me. Her=
 e is
 >>>> what my modified key-translate looks like:
 >>>>
 >>>> (define (key-translate virtual-key-code
 >>>>                        #:key-action            [key-action         kUC=
 KeyActionDown]
 >>>>                        #:modifier-key-state    [modifier-key-state    =
             0]  ; no modifier
 >>>>                        #:keyboard-type         [keyboard-type        (=
 LMGetKbdType)]
 >>>>                        #:key-translate-options [key-translate-options =
            #f]
 >>>>                        #:dead-key-state        [dead-key-state        =
            #f]  ; no prev state
 >>>>                        #:keyboard-layout       [layout-in             =
       'cached]) ; use cached
 >>>>   (define actual-string-length (box 0))
 >>>>   (set! key-translate-options
 >>>>         (or key-translate-options                ; use user settings i=
 f provided
 >>>>             (if dead-key-state                   ; otherwise if user h=
 as set dead-key-state,
 >>>>                 0                                ; then take dead-keys=
  into account
 >>>>                 kUCKeyTranslateNoDeadKeysFlag))) ; else ignore dead ke=
 ys
 >>>>
 >>>>   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state=
 )))
 >>>>
 >>>>   (define layout
 >>>>     (case layout-in
 >>>>       ; use cached
 >>>>       [(cached)    (cond
 >>>>                     [cached-keyboard-layout =3D> values]
 >>>>                     [else   (set! cached-keyboard-layout (get-current-=
 keyboard-layout))
 >>>>                             cached-keyboard-layout])]
 >>>>       ; refresh cache
 >>>>       [(#f)         (set! cached-keyboard-layout (get-current-keyboard=
 -layout))
 >>>>                     cached-keyboard-layout]
 >>>>       ; use provided
 >>>>       [else          layout-in]))
 >>>>
 >>>>   (UCKeyTranslate layout
 >>>>                   virtual-key-code
 >>>>                   key-action
 >>>>                   (bitwise-and (>> modifier-key-state 8) #xFF)
 >>>>                   keyboard-type
 >>>>                   key-translate-options
 >>>>                   dead-key-state
 >>>>                   max-string-length
 >>>>                   actual-string-length
 >>>>                   output-chars)
 >>>>   ; get the number of characters returned, and convert to string
 >>>>   (define n (max 0 (min max-string-length (unbox actual-string-length)=
 )))
 >>>>   (list->string (for/list ([i (in-range n)])
 >>>>                   (define i (ptr-ref output-chars _UniChar i))
 >>>>                   (if (<=3D  #xD800 i #xDFFF)
 >>>>                       ""
 >>>>                       (integer->char i)))))
 >>>>
 >>>> =E2=80=8B
 >>>>
 >>>> On Thu, Sep 8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <
 >>>> jensaxel@soegaard.net> wrote:
 >>>>
 >>>>> Progress - so key-translate does get called.
 >>>>>
 >>>>> The two last lines of key-translate are:
 >>>>>
 >>>>>     (list->string (for/list ([i (in-range n)])
 >>>>>                        (integer->char (ptr-ref output-chars _UniChar
 >>>>> i)))))
 >>>>>
 >>>>> Can you test what happens if you change it to:
 >>>>>
 >>>>>     (list->string (for/list ([i (in-range n)])
 >>>>>                            (define i (ptr-ref output-chars _UniChar i=
 ))
 >>>>>                            (if (<=3D  #xD800 i #xDFFF)
 >>>>>                                 ""
 >>>>>                                (integer->char i)))))
 >>>>>
 >>>>> ?
 >>>>>
 >>>>>
 >>>>> 2016-09-08 18:23 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>>
 >>>>>> It looks to me like the reason for this is that the gui-lib package
 >>>>>> (loaded for anything graphical, I presume, including launching DrRac=
 ket)
 >>>>>> fills out a hash table for keyboard mappings eagerly (on package loa=
 d). The
 >>>>>> following is from line 551 of /Applications/Racket
 >>>>>> v6.6/share/pkgs/gui-lib/mred/private/wx/cocoa/key-translate.rkt:
 >>>>>>
 >>>>>> ;; fill in hash tables
 >>>>>> (for* ([modsyms all-modifier-combinations]                          =
   ; go through all physical key
 >>>>>>        [(kvc n) virtual-key-code-name-to-value-ht])                 =
   ; and modifier combinations
 >>>>>>   (define modks (modifier-symbol-list->integer modsyms))
 >>>>>>   (define s (key-translate n #:modifier-key-state modks))           =
   ; translate to a char
 >>>>>>   (unless (string=3D? s "")                                         =
     ; unless key is dead
 >>>>>>     (define c (string-ref s 0))
 >>>>>>     (hash-set-new! char-to-osx-keycode+modifiers-ht c               =
   ; store where char is from
 >>>>>>                    (list kvc n modsyms modks))                      =
   ; (simplest is kept)
 >>>>>>     (cond
 >>>>>>       [(null? modsyms)                                              =
  ; also, if it is a main char
 >>>>>>        (hash-set! char-to-main-char-key-ht c c)                     =
   ;   store it as such
 >>>>>>        (hash-set! osx-keycode-to-main-char-key-ht n c)]             =
   ;
 >>>>>>       [else
 >>>>>>        (define mck (hash-ref osx-keycode-to-main-char-key-ht n #f)) =
   ; otherwise find
 >>>>>>        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))=
   ;   and store main char key
 >>>>>>
 >>>>>> =E2=80=8B
 >>>>>>
 >>>>>> On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <
 >>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>
 >>>>>>> That sounds as something that should work.
 >>>>>>> As far as I know key-translate is only called when you actually
 >>>>>>> press a key.
 >>>>>>> So I am surprised that you see the error when DrRacket starts.
 >>>>>>>
 >>>>>>> I'll need to look up Ukelele.
 >>>>>>>
 >>>>>>> /Jens Axel
 >>>>>>>
 >>>>>>>
 >>>>>>>
 >>>>>>> 2016-09-08 18:11 GMT+02:00 Radon Rosborough <radon.neon@gmail.com>:
 >>>>>>>
 >>>>>>>> It's not intentionally. Perhaps they are an artifact created by
 >>>>>>>> Ukelele. Is there an easy way to determine which key is producing =
 the
 >>>>>>>> surrogate code point(s)?
 >>>>>>>>
 >>>>>>>> The first thing I think of is the dead keys used for creating
 >>>>>>>> accents in OS X, but these are also present in the default keyboar=
 d layout.
 >>>>>>>> The only thing I have done with them is move the Alt+E dead key to
 >>>>>>>> Alt+Shift+`.
 >>>>>>>>
 >>>>>>>> On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <
 >>>>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>>>
 >>>>>>>>> Here is what I have so far:
 >>>>>>>>>
 >>>>>>>>> 1) integer->char is being called with an input that aren't accept=
 ed
 >>>>>>>>> 2) the caller is key-translate a low level function whose job
 >>>>>>>>>     is to translate (physical) keycodes into characters using
 >>>>>>>>>     a keyboard layout.
 >>>>>>>>> 3) it is a bug in key-translate that integer->char is called with
 >>>>>>>>>     an integer that doesn't correspond to a character
 >>>>>>>>>
 >>>>>>>>> 4) From
 >>>>>>>>>           integer->char: contract violation
 >>>>>>>>>           expected: (and/c (integer-in 0 #x10FFFF) (not/c
 >>>>>>>>> (integer-in #xD800 #xDFFF)))
 >>>>>>>>>           given: 55357
 >>>>>>>>>     we learn that the operating system translated a keycode to th=
 e
 >>>>>>>>> codepoint 55357.
 >>>>>>>>>     That code point lies in the range D800 to DFFF which are not
 >>>>>>>>> accepted by
 >>>>>>>>>     integer->char
 >>>>>>>>> 5) That range is called "High Surrogates"
 >>>>>>>>>     From http://www.alanwood.net/unicode/high_surrogates.html
 >>>>>>>>>
 >>>>>>>>> Surrogate code points are intended to allow mapping of additional
 >>>>>>>>> character planes into the 16-bit Unicode system, thus allowing mo=
 re than
 >>>>>>>>> 65,536 characters to be represented. The individual surrogate cod=
 e points
 >>>>>>>>> do not represent characters; they are intended to be used in pair=
 s, a high
 >>>>>>>>> code point followed by a low code point, to stand in for a charac=
 ter in one
 >>>>>>>>> of the supplementary planes. Their use is restricted to UTF-16. T=
 hey can be
 >>>>>>>>> used for characters in Linear B Syllabary
 >>>>>>>>> <http://www.alanwood.net/unicode/linear_b_syllabary.html> and
 >>>>>>>>> higher-numbered ranges.
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>> Is it intentionally that your layout produces such code points?
 >>>>>>>>>
 >>>>>>>>> /Jens Axel
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>> 2016-09-08 17:50 GMT+02:00 Radon Rosborough <radon.neon@gmail.com=
 >
 >>>>>>>>> :
 >>>>>>>>>
 >>>>>>>>>> Before. If I switch after I launch DrRacket, it appears to work
 >>>>>>>>>> OK, although I haven't tried anything substantial to make sure e=
 verything
 >>>>>>>>>> works.
 >>>>>>>>>>
 >>>>>>>>>> On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <
 >>>>>>>>>> jensaxel@soegaard.net> wrote:
 >>>>>>>>>>
 >>>>>>>>>>> Did you switch to your keyboard layout before or after starting
 >>>>>>>>>>> DrRacket?
 >>>>>>>>>>>
 >>>>>>>>>>> /Jens Axel
 >>>>>>>>>>>
 >>>>>>>>>>>
 >>>>>>>>>>> 2016-09-08 17:32 GMT+02:00 <radon.neon@gmail.com>:
 >>>>>>>>>>>
 >>>>>>>>>>>> A new problem report is waiting at
 >>>>>>>>>>>>   http://bugs.racket-lang.org/query/?cmd=3Dview&pr=3D15347
 >>>>>>>>>>>>
 >>>>>>>>>>>> Reported by Radon Rosborough for release: 6.6
 >>>>>>>>>>>>
 >>>>>>>>>>>> *** Description:
 >>>>>>>>>>>> I use Ukelele (scripts.sil.org/ukelele) to manage a custom OSX
 >>>>>>>>>>>> keyboard layout. If I am using my custom keyboard layout (but =
 not when
 >>>>>>>>>>>> using the default keyboard layout), then when:
 >>>>>>>>>>>>
 >>>>>>>>>>>> - launching the 'drracket' executable,
 >>>>>>>>>>>> - opening the DrRacket application, or
 >>>>>>>>>>>> - using geiser in Emacs, compiling a file with '#lang
 >>>>>>>>>>>> slideshow' in it,
 >>>>>>>>>>>>
 >>>>>>>>>>>> Racket crashes immediately with the following error:
 >>>>>>>>>>>>
 >>>>>>>>>>>> integer->char: contract violation
 >>>>>>>>>>>>   expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in
 >>>>>>>>>>>> #xD800 #xDFFF)))
 >>>>>>>>>>>>   given: 55357
 >>>>>>>>>>>>   context...:
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:495:16: for-loop
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>>>> rivate/wx/cocoa/key-translate.rkt:552:0: for-loop
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p
 >>>>>>>>>>>> rivate/wx/cocoa/key-translate.rkt: [running body]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/w=
 x/cocoa/window.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/w=
 x/cocoa/item.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/w=
 x/cocoa/button.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/w=
 x/cocoa/platform.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/w=
 x/platform.rkt:
 >>>>>>>>>>>> [running body]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/k=
 ernel.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/private/m=
 red.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/mred.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/main.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/gui-lib/racket/gui/bas=
 e.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>    /Applications/Racket v6.6/share/pkgs/drracket/drracket/drra=
 cket.rkt:
 >>>>>>>>>>>> [traversing imports]
 >>>>>>>>>>>>
 >>>>>>>>>>>> *** How to repeat:
 >>>>>>>>>>>> I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can
 >>>>>>>>>>>> also reproduce the problem on a virtual machine with a fresh i=
 nstall of El
 >>>>>>>>>>>> Capitan 10.11.
 >>>>>>>>>>>>
 >>>>>>>>>>>> - Download my custom keyboard layout:
 >>>>>>>>>>>> https://drive.google.com/open?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0=
 U
 >>>>>>>>>>>> - Place "My Keyboard Layout.bundle" in "~/Library/Keyboard
 >>>>>>>>>>>> Layouts".
 >>>>>>>>>>>> - In System Preferences > Keyboard > Input Sources, add "My
 >>>>>>>>>>>> Keyboard Layout" as an input source.
 >>>>>>>>>>>> - Make sure the "Show Input menu in menu bar" checkbox is
 >>>>>>>>>>>> checked.
 >>>>>>>>>>>> - In the Input menu in the menu bar, select "My Keyboard
 >>>>>>>>>>>> Layout".
 >>>>>>>>>>>> - Launch DrRacket. It should crash (and provide the above erro=
 r
 >>>>>>>>>>>> message if it was launched from the command line).
 >>>>>>>>>>>>
 >>>>>>>>>>>> *** Environment:
 >>>>>>>>>>>> macosx "Darwin WL-222-71.WPA.Claremont.Edu 15.6.0 Darwin
 >>>>>>>>>>>> Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016;
 >>>>>>>>>>>> root:xnu-3248.60.11~1/RELEASE_X86_64 x86_64"
 >>>>>>>>>>>> (x86_64-macosx/3m) (get-display-depth) =3D 32
 >>>>>>>>>>>> Human Language: english
 >>>>>>>>>>>> (current-memory-use) 252260656
 >>>>>>>>>>>> raco pkg (show):
 >>>>>>>>>>>> Installation-wide:
 >>>>>>>>>>>>  Package            Checksum             Source
 >>>>>>>>>>>>  main-distribution  e24e5af07557ac0f...  catalog...tribution
 >>>>>>>>>>>>  racket-lib         21b7fee99c95a8d7...  catalog racket-lib
 >>>>>>>>>>>>  [189 auto-installed packages not shown]
 >>>>>>>>>>>> User-specific for installation "6.6":
 >>>>>>>>>>>>  [none]
 >>>>>>>>>>>>
 >>>>>>>>>>>>
 >>>>>>>>>>>>
 >>>>>>>>>>>> Collections:
 >>>>>>>>>>>> ("/Users/raxod502/Library/Racket/6.6/collects"
 >>>>>>>>>>>>  (non-existent-path))
 >>>>>>>>>>>> ("/Applications/Racket v6.6/collects"
 >>>>>>>>>>>>  ("acks" "compiler" "data" "db" "dynext" "ffi" "file" "info"
 >>>>>>>>>>>> "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet"=
  "racket"
 >>>>>>>>>>>> "raco" "reader" "realm" "s-exp" "setup" "syntax" "version" "xm=
 l"))
 >>>>>>>>>>>>
 >>>>>>>>>>>> Recent Internal Errors:
 >>>>>>>>>>>> Computer Language: (("Initial language" "No language chosen")
 >>>>>>>>>>>> #(#t print mixed-fraction-e #f #t debug))
 >>>>>>>>>>>>
 >>>>>>>>>>>>
 >>>>>>>>>>>
 >>>>>>>>>>>
 >>>>>>>>>>> --
 >>>>>>>>>>> --
 >>>>>>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>>>>>
 >>>>>>>>>>>
 >>>>>>>>>>
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>> --
 >>>>>>>>> --
 >>>>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>>>
 >>>>>>>>>
 >>>>>>>>
 >>>>>>>
 >>>>>>>
 >>>>>>> --
 >>>>>>> --
 >>>>>>> Jens Axel S=C3=B8gaard
 >>>>>>>
 >>>>>>>
 >>>>>>
 >>>>>
 >>>>>
 >>>>> --
 >>>>> --
 >>>>> Jens Axel S=C3=B8gaard
 >>>>>
 >>>>>
 >>>>
 >>>
 >>>
 >>> --
 >>> --
 >>> Jens Axel S=C3=B8gaard
 >>>
 >>>
 >>
 >
 >
 > --
 > --
 > Jens Axel S=C3=B8gaard
 >
 >
 
 --001a114117e2db1a7f053c148a94
 Content-Type: text/html; charset=UTF-8
 Content-Transfer-Encoding: quoted-printable
 
 <div dir=3D"ltr">This appears to work. Thanks!<div class=3D"gmail_extra"><b=
 r><div class=3D"gmail_quote">On Fri, Sep 9, 2016 at 4:36 AM, Jens Axel S=C3=
 =B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" tar=
 get=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote c=
 lass=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;=
 padding-left:1ex"><div dir=3D"ltr">Hi Radon,<div><br></div><div>This transl=
 ates all characters in the range from #xD800 to #xDFFF to a single space.</=
 div><div>This is probably not &quot;The Right Way&quot; to handle surrogate=
 s, but at least you</div><div>should be able to start DrRacket.<br><div><br=
 ></div><div><span><div>(list-&gt;string (for/list ([i (in-range n)])</div><=
 div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 (define =
 j (ptr-ref output-chars _UniChar i))</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 (if (&lt;=3D #xD800 j #xDFFF)</div></spa=
 n><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 #\space</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 (integer-&gt;char j))))<span><font color=3D=
 "#888888"><br><br>/Jens Axel</font></span></div></div></div><div><br></div>=
 </div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2=
 016-09-08 20:40 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D=
 "mailto:radon.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt=
 ;</span>:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;b=
 order-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr"><div><p style=
 =3D"margin:0px 0px 1.2em!important">Now I get</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">list-&gt;string: con=
 tract violation
   expected: (listof char?)
   given: &#39;(&quot;&quot; &quot;&quot;)
   context...:
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 window.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 item.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 button.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 platform.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/platfo=
 rm.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/kernel.rk=
 t: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/mred.rkt:=
  [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/base.rkt: [=
 traversing imports]
    /Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/drracket.rkt=
 : [traversing imports]
 </code></pre><p style=3D"margin:0px 0px 1.2em!important">It looks like the =
 empty strings need to be removed from the list before being passed to <code=
  style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospa=
 ce;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px soli=
 d rgb(234,234,234);border-radius:3px;display:inline;background-color:rgb(24=
 8,248,248)">list-&gt;string</code>.</p>
 <div title=3D"MDH:Tm93IEkgZ2V0PGRpdj48YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2P=
 jxkaXY+bGlzdC0mZ3Q7
 c3RyaW5nOiBjb250cmFjdCB2aW9sYXRpb248L2Rpdj48ZGl2PiZuYnNwOyBleHBlY3RlZDogKGx=
 p
 c3RvZiBjaGFyPyk8L2Rpdj48ZGl2PiZuYnNwOyBnaXZlbjogJygiIiAiIik8L2Rpdj48ZGl2PiZ=
 u
 YnNwOyBjb250ZXh0Li4uOjwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmF=
 j
 a2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJ=
 h
 bnNsYXRlLnJrdDo1NTU6MDogZm9yLWxvb3A8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGl=
 j
 YXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29=
 j
 b2Eva2V5LXRyYW5zbGF0ZS5ya3Q6NTU1OjA6IGZvci1sb29wPC9kaXY+PGRpdj4mbmJzcDsgJm5=
 i
 c3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml=
 2
 YXRlL3d4L2NvY29hL2tleS10cmFuc2xhdGUucmt0OiBbcnVubmluZyBib2R5XTwvZGl2PjxkaXY=
 +
 Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGl=
 i
 L21yZWQvcHJpdmF0ZS93eC9jb2NvYS93aW5kb3cucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9pdGVtLnJrdDogW3RyYXZlcnNpbmcgaW1=
 w
 b3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3N=
 o
 YXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvYnV0dG9uLnJrdDogW3RyYXZ=
 l
 cnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2t=
 l
 dCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvcGxhdGZvcm0=
 u
 cmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWN=
 h
 dGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9wbGF=
 0
 Zm9ybS5ya3Q6IFtydW5uaW5nIGJvZHldPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F=
 0
 aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL2tlcm5lbC5=
 y
 a3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F=
 0
 aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL21yZWQucmt=
 0
 OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGl=
 v
 bnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvbXJlZC5ya3Q6IFt0cmF2ZXJ=
 z
 aW5nIGltcG9ydHNdPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQ=
 g
 djYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9tYWluLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J=
 0
 c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJ=
 l
 L3BrZ3MvZ3VpLWxpYi9yYWNrZXQvZ3VpL2Jhc2Uucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9kcnJhY2tldC9kcnJhY2tldC9kcnJhY2tldC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9=
 k
 aXY+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl2Pkl0IGxvb2tzIGxpa2U=
 g
 dGhlIGVtcHR5IHN0cmluZ3MgbmVlZCB0byBiZSByZW1vdmVkIGZyb20gdGhlIGxpc3QgYmVmb3J=
 l
 IGJlaW5nIHBhc3NlZCB0byBgbGlzdC0mZ3Q7c3RyaW5nYC48L2Rpdj4=3D" style=3D"min-he=
 ight:0;width:0;max-height:0;max-width:0;overflow:hidden;font-size:0em;paddi=
 ng:0;margin:0">=E2=80=8B</div></div></div><div><div><div class=3D"gmail_ext=
 ra"><br><div class=3D"gmail_quote">On Thu, Sep 8, 2016 at 11:33 AM, Jens Ax=
 el S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.n=
 et" target=3D"_blank">jensaxel@soegaard.net</a>&gt;</span> wrote:<br><block=
 quote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc=
  solid;padding-left:1ex"><div dir=3D"ltr">Sorry. I missed that i was used i=
 n for/list.<div>Try:<br><div><br></div><div><span style=3D"font-family:cons=
 olas,inconsolata,courier,monospace;font-size:10.88px;line-height:15.36px;wh=
 ite-space:pre-wrap;background-color:rgb(248,248,248)">(list-&gt;string (for=
 /list ([i (in-range n)])
                   (define j (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 j #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char j)))))</span><br></div></div></div>=
 <div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09=
 -08 20:24 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailt=
 o:radon.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</spa=
 n>:<br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-=
 left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr"><div><p style=3D"mar=
 gin:0px 0px 1.2em!important">Strangely, I get the following error (with bot=
 h my keyboard layout and the standard one):</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">i: undefined;
  cannot use before initialization
   context...:
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt:495:16: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt:555:0: for-loop
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 key-translate.<wbr>rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 window.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 item.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 button.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/=
 platform.rkt: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/platfo=
 rm.rkt: [running body]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/kernel.rk=
 t: [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/mred.rkt:=
  [traversing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rkt: [traver=
 sing imports]
    /Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/base.rkt: [=
 traversing imports]
    /Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/drracket.rkt=
 : [traversing imports]
 </code></pre><p style=3D"margin:0px 0px 1.2em!important">I am just getting =
 started with Racket so I don=E2=80=99t know why this would be=E2=80=94it lo=
 oks like <code style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,C=
 ourier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-space:pre-wrap;b=
 order:1px solid rgb(234,234,234);border-radius:3px;display:inline;backgroun=
 d-color:rgb(248,248,248)">i</code> is introduced as a local binding to me. =
 Here is what my modified <code style=3D"font-size:0.85em;font-family:Consol=
 as,Inconsolata,Courier,monospace;margin:0px 0.15em;padding:0px 0.3em;white-=
 space:pre-wrap;border:1px solid rgb(234,234,234);border-radius:3px;display:=
 inline;background-color:rgb(248,248,248)">key-translate</code> looks like:<=
 /p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">(define (key-transla=
 te virtual-key-code
                        #:key-action            [key-action         kUCKeyAc=
 tionDown]
                        #:modifier-key-state    [modifier-key-state         =
        0]  ; no modifier
                        #:keyboard-type         [keyboard-type        (LMGet=
 KbdType)]
                        #:key-translate-options [key-translate-options      =
       #f]
                        #:dead-key-state        [dead-key-state             =
       #f]  ; no prev state
                        #:keyboard-layout       [layout-in                  =
  &#39;cached]) ; use cached
   (define actual-string-length (box 0))
   (set! key-translate-options
         (or key-translate-options                ; use user settings if pro=
 vided
             (if dead-key-state                   ; otherwise if user has se=
 t dead-key-state,
                 0                                ; then take dead-keys into=
  account
                 kUCKeyTranslateNoDeadKeysFlag)<wbr>)) ; else ignore dead ke=
 ys
 
   (set! dead-key-state (or dead-key-state (make-initial-dead-key-state))<wb=
 r>)
 
   (define layout
     (case layout-in
       ; use cached
       [(cached)    (cond
                     [cached-keyboard-layout =3D&gt; values]
                     [else   (set! cached-keyboard-layout (get-current-keybo=
 ard-layout))
                             cached-keyboard-layout])]
       ; refresh cache
       [(#f)         (set! cached-keyboard-layout (get-current-keyboard-layo=
 ut))
                     cached-keyboard-layout]
       ; use provided
       [else          layout-in]))
 
   (UCKeyTranslate layout
                   virtual-key-code
                   key-action
                   (bitwise-and (&gt;&gt; modifier-key-state 8) #xFF)
                   keyboard-type
                   key-translate-options
                   dead-key-state
                   max-string-length
                   actual-string-length
                   output-chars)
   ; get the number of characters returned, and convert to string
   (define n (max 0 (min max-string-length (unbox actual-string-length))))
   (list-&gt;string (for/list ([i (in-range n)])
                   (define i (ptr-ref output-chars _UniChar i))
                   (if (&lt;=3D  #xD800 i #xDFFF)
                       &quot;&quot;
                       (integer-&gt;char i)))))
 </code></pre><div title=3D"MDH:U3RyYW5nZWx5LCBJIGdldCB0aGUgZm9sbG93aW5nIGVy=
 cm9yICh3aXRoIGJvdGggbXkga2V5Ym9h
 cmQgbGF5b3V0IGFuZCB0aGUgc3RhbmRhcmQgb25lKTo8ZGl2Pjxicj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2PjxkaXY+PGRpdj5pOiB1bmRlZmluZWQ7PC9kaXY+PGRpdj4mbmJzcDtjYW5ub3QgdXNlIGJ=
 l
 Zm9yZSBpbml0aWFsaXphdGlvbjwvZGl2PjxkaXY+Jm5ic3A7IGNvbnRleHQuLi46PC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1=
 s
 aWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2xhdGUucmt0OjQ5NToxNjogZm9yLWx=
 v
 b3A8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJ=
 l
 L3BrZ3MvZ3VpLWxpYi9tcmVkL3ByaXZhdGUvd3gvY29jb2Eva2V5LXRyYW5zbGF0ZS5ya3Q6NTU=
 1
 OjA6IGZvci1sb29wPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQ=
 g
 djYuNi9zaGFyZS9wa2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL3d4L2NvY29hL2tleS10cmFuc2x=
 h
 dGUucmt0OiBbcnVubmluZyBib2R5XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGl=
 v
 bnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9=
 3
 aW5kb3cucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS9=
 3
 eC9jb2NvYS9pdGVtLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9tcmVkL3B=
 y
 aXZhdGUvd3gvY29jb2EvYnV0dG9uLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl=
 2
 PiZuYnNwOyAmbmJzcDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWx=
 p
 Yi9tcmVkL3ByaXZhdGUvd3gvY29jb2EvcGxhdGZvcm0ucmt0OiBbdHJhdmVyc2luZyBpbXBvcnR=
 z
 XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmU=
 v
 cGtncy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9wbGF0Zm9ybS5ya3Q6IFtydW5uaW5nIGJvZHl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL2tlcm5lbC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHN=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9=
 w
 a2dzL2d1aS1saWIvbXJlZC9wcml2YXRlL21yZWQucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTw=
 v
 ZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvbXJlZC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7L0FwcGxpY2F0aW9ucy9SYWNrZXQgdjYuNi9zaGFyZS9wa2dzL2d1aS1saWI=
 v
 bXJlZC9tYWluLnJrdDogW3RyYXZlcnNpbmcgaW1wb3J0c108L2Rpdj48ZGl2PiZuYnNwOyAmbmJ=
 z
 cDsvQXBwbGljYXRpb25zL1JhY2tldCB2Ni42L3NoYXJlL3BrZ3MvZ3VpLWxpYi9yYWNrZXQvZ3V=
 p
 L2Jhc2Uucmt0OiBbdHJhdmVyc2luZyBpbXBvcnRzXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOy9=
 B
 cHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGtncy9kcnJhY2tldC9kcnJhY2tldC9kcnJ=
 h
 Y2tldC5ya3Q6IFt0cmF2ZXJzaW5nIGltcG9ydHNdPC9kaXY+PC9kaXY+PGRpdj5gYGA8L2Rpdj4=
 8
 ZGl2Pjxicj48L2Rpdj48ZGl2PkkgYW0ganVzdCBnZXR0aW5nIHN0YXJ0ZWQgd2l0aCBSYWNrZXQ=
 g
 c28gSSBkb24ndCBrbm93IHdoeSB0aGlzIHdvdWxkIGJl4oCUaXQgbG9va3MgbGlrZSBgaWAgaXM=
 g
 aW50cm9kdWNlZCBhcyBhIGxvY2FsIGJpbmRpbmcgdG8gbWUuIEhlcmUgaXMgd2hhdCBteSBtb2R=
 p
 ZmllZCBga2V5LXRyYW5zbGF0ZWAgbG9va3MgbGlrZTo8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl=
 2
 PmBgYDwvZGl2PjxkaXY+PGRpdj4oZGVmaW5lIChrZXktdHJhbnNsYXRlIHZpcnR1YWwta2V5LWN=
 v
 ZGU8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzprZXktYWN0aW9uICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7W2tleS1hY3Rpb24gJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7IGtVQ0tleUFjdGlvbkRvd25dPC9kaXY+PGRpdj4mbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyM6bW9kaWZpZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDtbbW9kaWZ=
 p
 ZXIta2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDswXSAmbmJzcDs7IG5vIG1vZGlmaWVyPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyM6a2V5Ym9hcmQtdHlwZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 W2tleWJvYXJkLXR5cGUgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KExNR2V0S2JkVHlwZSl=
 d
 PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyM6a2V5LXRyYW5zbGF0ZS1vcHR=
 p
 b25zIFtrZXktdHJhbnNsYXRlLW9wdGlvbnMgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsjZl08L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IzpkZWF=
 k
 LWtleS1zdGF0ZSAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDtbZGVhZC1rZXktc3RhdGUgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgI2ZdICZuYnNwOzsgbm8gcHJldiBzdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsjOmtleWJvYXJkLWxheW91dCAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbbGF5b3V0LWl=
 u
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICdjYWNoZWRdKSA7IHVzZSBjYWNoZWQ8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGF=
 j
 dHVhbC1zdHJpbmctbGVuZ3RoIChib3ggMCkpPC9kaXY+PGRpdj4mbmJzcDsgKHNldCEga2V5LXR=
 y
 YW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKG9=
 y
 IGtleS10cmFuc2xhdGUtb3B0aW9ucyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyB1c2UgdXNlciBzZXR0aW5ncyBpZiBwcm92aWRlZDwvZGl=
 2
 PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGlmIGRlYWQ=
 t
 a2V5LXN0YXRlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7IDsgb3RoZXJ3aXNlIGlmIHVzZXIgaGFzIHNldCBkZWFkLWtleS1zdGF=
 0
 ZSw8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgMCAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDs7IHRoZW4gdGFrZSBkZWFkLWtleXMgaW50byBhY2NvdW50PC9kaXY+PGRpdj4=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IGt=
 V
 Q0tleVRyYW5zbGF0ZU5vRGVhZEtleXNGbGFnKSkpIDsgZWxzZSBpZ25vcmUgZGVhZCBrZXlzPC9=
 k
 aXY+PGRpdj48YnI+PC9kaXY+PGRpdj4mbmJzcDsgKHNldCEgZGVhZC1rZXktc3RhdGUgKG9yIGR=
 l
 YWQta2V5LXN0YXRlIChtYWtlLWluaXRpYWwtZGVhZC1rZXktc3RhdGUpKSk8L2Rpdj48ZGl2Pjx=
 i
 cj48L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIGxheW91dDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnN=
 w
 OyAoY2FzZSBsYXlvdXQtaW48L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IDsgdXNlIGN=
 h
 Y2hlZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgWyhjYWNoZWQpICZuYnNwOyAmbmJ=
 z
 cDsoY29uZDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IFtjYWNoZWQta2V5Ym9hcmQtbGF5b3V0ID0=
 m
 Z3Q7IHZhbHVlc108L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBbZWxzZSAmbmJzcDsgKHNldCEgY2F=
 j
 aGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V5Ym9hcmQtbGF5b3V0KSk8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgY2FjaGVkLWtleWJ=
 v
 YXJkLWxheW91dF0pXTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyByZWZyZXNoIGN=
 h
 Y2hlPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyBbKCNmKSAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgKHNldCEgY2FjaGVkLWtleWJvYXJkLWxheW91dCAoZ2V0LWN1cnJlbnQta2V=
 5
 Ym9hcmQtbGF5b3V0KSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBjYWNoZWQta2V5Ym9hcmQtbGF=
 5
 b3V0XTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgOyB1c2UgcHJvdmlkZWQ8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7IFtlbHNlICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDtsYXlvdXQtaW5dKSk8L2Rpdj48ZGl2Pjxicj48L2Rpdj48ZGl2PiZuYnNwOyAoVUN=
 L
 ZXlUcmFuc2xhdGUgbGF5b3V0PC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyB2aXJ0dWFsLWtleS1jb2RlPC9kaXY=
 +
 PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyBrZXktYWN0aW9uPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAoYml0d2lzZS1hbmQgKCZndDs=
 m
 Z3Q7IG1vZGlmaWVyLWtleS1zdGF0ZSA4KSAjeEZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5Ym9hcmQ=
 t
 dHlwZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsga2V5LXRyYW5zbGF0ZS1vcHRpb25zPC9kaXY+PGRpdj4mbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyBkZWFkLWtleS1zdGF0ZTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgbWF4LXN0cmluZy1sZW5ndGg8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7IGFjdHVhbC1zdHJpbmctbGVuZ3RoPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyBvdXRwdXQtY2h=
 h
 cnMpPC9kaXY+PGRpdj4mbmJzcDsgOyBnZXQgdGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIHJldHV=
 y
 bmVkLCBhbmQgY29udmVydCB0byBzdHJpbmc8L2Rpdj48ZGl2PiZuYnNwOyAoZGVmaW5lIG4gKG1=
 h
 eCAwIChtaW4gbWF4LXN0cmluZy1sZW5ndGggKHVuYm94IGFjdHVhbC1zdHJpbmctbGVuZ3RoKSk=
 p
 KTwvZGl2PjxkaXY+Jm5ic3A7IChsaXN0LSZndDtzdHJpbmcgKGZvci9saXN0IChbaSAoaW4tcmF=
 u
 Z2UgbildKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJ=
 z
 cDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgKGRlZmluZSBpIChwdHItcmVmIG91dHB1dC1jaGFycyB=
 f
 VW5pQ2hhciBpKSk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IChpZiAoJmx0Oz0gJm5ic3A7I3hEODAwIGkgI3h=
 E
 RkZGKTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAiIjwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAoaW50ZWdlci0mZ3Q7Y2hhciBpKSkpKSk8L2Rpdj48L2Rpdj48ZGl2PmBgYDw=
 v
 ZGl2Pg=3D=3D" style=3D"min-height:0;width:0;max-height:0;max-width:0;overfl=
 ow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</div></div></div><div=
 ><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">On Thu, Sep=
  8, 2016 at 9:35 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr">&lt;<a href=
 =3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@soegaard.net</=
 a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0=
  0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">Pro=
 gress - so key-translate does get called.<br><br>The two last lines of key-=
 translate are:<br><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/list ([i (in=
 -range n)])=C2=A0</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;char (ptr-ref output-cha=
 rs _UniChar i)))))<br><br>Can you test what happens if you change it to:<br=
 ><br><div>=C2=A0 =C2=A0 (list-&gt;string (for/list ([i (in-range n)])=C2=A0=
 </div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(define i (ptr-ref output-chars _UniChar =
 i))</div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(if (&lt;=3D=C2=A0<span style=3D"colo=
 r:rgb(80,0,80);font-size:12.8px">=C2=A0</span><span style=3D"color:rgb(80,0=
 ,80);font-size:12.8px">#xD800 i #xDFFF)</span></div><div><span style=3D"col=
 or:rgb(80,0,80);font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0=
  =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 &quo=
 t;&quot;</span></div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0(integer-&gt;=
 char i)))))<br><br>?</div><br></div></div><div><div><div class=3D"gmail_ext=
 ra"><br><div class=3D"gmail_quote">2016-09-08 18:23 GMT+02:00 Radon Rosboro=
 ugh <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D=
 "_blank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail=
 _quote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:=
 1ex"><div dir=3D"ltr"><div><p style=3D"margin:0px 0px 1.2em!important">It l=
 ooks to me like the reason for this is that the <code style=3D"font-size:0.=
 85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px 0.15em;p=
 adding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234,234);bor=
 der-radius:3px;display:inline;background-color:rgb(248,248,248)">gui-lib</c=
 ode> package (loaded for anything graphical, I presume, including launching=
  DrRacket) fills out a hash table for keyboard mappings eagerly (on package=
  load). The following is from line 551 of <code style=3D"font-size:0.85em;f=
 ont-family:Consolas,Inconsolata,Courier,monospace;margin:0px 0.15em;padding=
 :0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234,234);border-ra=
 dius:3px;display:inline;background-color:rgb(248,248,248)">/Applications/Ra=
 cket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate/wx/cocoa/key-translate.<wbr>=
 rkt</code>:</p>
 <pre style=3D"font-size:0.85em;font-family:Consolas,Inconsolata,Courier,mon=
 ospace;font-size:1em;line-height:1.2em;margin:1.2em 0px"><code style=3D"fon=
 t-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0px=
  0.15em;padding:0px 0.3em;white-space:pre-wrap;border:1px solid rgb(234,234=
 ,234);border-radius:3px;display:inline;background-color:rgb(248,248,248);wh=
 ite-space:pre-wrap;overflow:auto;border-radius:3px;border:1px solid rgb(204=
 ,204,204);padding:0.5em 0.7em;display:block!important">;; fill in hash tabl=
 es
 (for* ([modsyms all-modifier-combinations]                            ; go =
 through all physical key
        [(kvc n) virtual-key-code-name-to-value<wbr>-ht])                   =
 ; and modifier combinations
   (define modks (modifier-symbol-list-&gt;integer modsyms))
   (define s (key-translate n #:modifier-key-state modks))             ; tra=
 nslate to a char
   (unless (string=3D? s &quot;&quot;)                                      =
        ; unless key is dead
     (define c (string-ref s 0))
     (hash-set-new! char-to-osx-keycode+modifiers-<wbr>ht c                 =
 ; store where char is from
                    (list kvc n modsyms modks))                        ; (si=
 mplest is kept)
     (cond=20
       [(null? modsyms)                                               ; also=
 , if it is a main char
        (hash-set! char-to-main-char-key-ht c c)                       ;   s=
 tore it as such
        (hash-set! osx-keycode-to-main-char-key-h<wbr>t n c)]               =
 ;  =20
       [else
        (define mck (hash-ref osx-keycode-to-main-char-key-h<wbr>t n #f))   =
 ; otherwise find=20
        (when mck (hash-set-new! char-to-main-char-key-ht c mck))])))  ;   a=
 nd store main char key
 </code></pre><div title=3D"MDH:SXQgbG9va3MgdG8gbWUgbGlrZSB0aGUgcmVhc29uIGZv=
 ciB0aGlzIGlzIHRoYXQgdGhlIGBndWkt
 bGliYCBwYWNrYWdlIChsb2FkZWQgZm9yIGFueXRoaW5nIGdyYXBoaWNhbCwgSSBwcmVzdW1lLCB=
 p
 bmNsdWRpbmcgbGF1bmNoaW5nIERyUmFja2V0KSBmaWxscyBvdXQgYSBoYXNoIHRhYmxlIGZvciB=
 r
 ZXlib2FyZCBtYXBwaW5ncyBlYWdlcmx5IChvbiBwYWNrYWdlIGxvYWQpLiBUaGUgZm9sbG93aW5=
 n
 IGlzIGZyb20gbGluZSA1NTEgb2YgYC9BcHBsaWNhdGlvbnMvUmFja2V0IHY2LjYvc2hhcmUvcGt=
 n
 cy9ndWktbGliL21yZWQvcHJpdmF0ZS93eC9jb2NvYS9rZXktdHJhbnNsYXRlLnJrdGA6PGRpdj4=
 8
 YnI+PC9kaXY+PGRpdj5gYGA8L2Rpdj48ZGl2PjxkaXY+OzsgZmlsbCBpbiBoYXNoIHRhYmxlczw=
 v
 ZGl2PjxkaXY+KGZvciogKFttb2RzeW1zIGFsbC1tb2RpZmllci1jb21iaW5hdGlvbnNdICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs7IGdvIHRocm91Z2ggYWxsIHBoeXN=
 p
 Y2FsIGtleTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7WyhrdmMgbikgdml=
 y
 dHVhbC1rZXktY29kZS1uYW1lLXRvLXZhbHVlLWh0XSkgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyBhbmQgbW9kaWZpZXIgY29=
 t
 YmluYXRpb25zPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBtb2RrcyAobW9kaWZpZXItc3ltYm9=
 s
 LWxpc3QtJmd0O2ludGVnZXIgbW9kc3ltcykpPC9kaXY+PGRpdj4mbmJzcDsgKGRlZmluZSBzICh=
 r
 ZXktdHJhbnNsYXRlIG4gIzptb2RpZmllci1rZXktc3RhdGUgbW9ka3MpKSAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHRyYW5zbGF0ZSB0byBhIGNoYXI8L2Rpdj4=
 8
 ZGl2PiZuYnNwOyAodW5sZXNzIChzdHJpbmc9PyBzICIiKSAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5=
 i
 c3A7ICZuYnNwOyAmbmJzcDsgOyB1bmxlc3Mga2V5IGlzIGRlYWQ8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgKGRlZmluZSBjIChzdHJpbmctcmVmIHMgMCkpPC9kaXY+PGRpdj4mbmJzcDsgJm5ic3A=
 7
 IChoYXNoLXNldC1uZXchIGNoYXItdG8tb3N4LWtleWNvZGUrbW9kaWZpZXJzLWh0IGMgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7IHN0b3J=
 l
 IHdoZXJlIGNoYXIgaXMgZnJvbTwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGxpc3Qga3ZjIG4gbW9=
 k
 c3ltcyBtb2RrcykpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7OyAoc2ltcGxlc3QgaXMga2V=
 w
 dCk8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgKGNvbmQmbmJzcDs8L2Rpdj48ZGl2PiZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7IFsobnVsbD8gbW9kc3ltcykgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A=
 7
 ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDs=
 g
 Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7ICZuYnNwOyA7IGFsc28sIGlmIGl0IGlzIGEgbWFpbiBjaGFyPC9kaXY+PGR=
 p
 dj4mbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsoaGFzaC1zZXQhIGNoYXItdG8tbWFpbi1jaGF=
 y
 LWtleS1odCBjIGMpICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyAmbmJzcDsgOyAmbmJzcDsgc3RvcmUgaXQgYXMgc3V=
 j
 aDwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7KGhhc2gtc2V0ISBvc3gta2V=
 5
 Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gYyldICZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnN=
 w
 OyAmbmJzcDsgJm5ic3A7ICZuYnNwOyA7ICZuYnNwOyZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZ=
 u
 YnNwOyAmbmJzcDsgW2Vsc2U8L2Rpdj48ZGl2PiZuYnNwOyAmbmJzcDsgJm5ic3A7ICZuYnNwOyh=
 k
 ZWZpbmUgbWNrIChoYXNoLXJlZiBvc3gta2V5Y29kZS10by1tYWluLWNoYXIta2V5LWh0IG4gI2Y=
 p
 KSAmbmJzcDsgOyBvdGhlcndpc2UgZmluZCZuYnNwOzwvZGl2PjxkaXY+Jm5ic3A7ICZuYnNwOyA=
 m
 bmJzcDsgJm5ic3A7KHdoZW4gbWNrIChoYXNoLXNldC1uZXchIGNoYXItdG8tbWFpbi1jaGFyLWt=
 l
 eS1odCBjIG1jaykpXSkpKSAmbmJzcDs7ICZuYnNwOyBhbmQgc3RvcmUgbWFpbiBjaGFyIGtleTw=
 v
 ZGl2PjwvZGl2PjxkaXY+YGBgPC9kaXY+" style=3D"min-height:0;width:0;max-height:=
 0;max-width:0;overflow:hidden;font-size:0em;padding:0;margin:0">=E2=80=8B</=
 div></div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmai=
 l_quote">On Thu, Sep 8, 2016 at 9:17 AM, Jens Axel S=C3=B8gaard <span dir=
 =3D"ltr">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jen=
 saxel@soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quot=
 e" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">=
 <div dir=3D"ltr"><div>That sounds as something that should work.</div>As fa=
 r as I know=C2=A0key-translate is only called when you actually press a key=
 .<br>So I am surprised that you see the error when DrRacket starts.<br><br>=
 I&#39;ll need to look up Ukelele.<span><font color=3D"#888888"><br><br>/Jen=
 s Axel<br><div><div><br></div><div><br></div></div></font></span></div><div=
 ><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 =
 18:11 GMT+02:00 Radon Rosborough <span dir=3D"ltr">&lt;<a href=3D"mailto:ra=
 don.neon@gmail.com" target=3D"_blank">radon.neon@gmail.com</a>&gt;</span>:<=
 br><blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex;border-left=
 :1px #ccc solid;padding-left:1ex"><div dir=3D"ltr">It&#39;s not intentional=
 ly. Perhaps they are an artifact created by Ukelele. Is there an easy way t=
 o determine which key is producing the surrogate code point(s)?<div><br></d=
 iv><div>The first thing I think of is the dead keys used for creating accen=
 ts in OS X, but these are also present in the default keyboard layout. The =
 only thing I have done with them is move the Alt+E dead key to Alt+Shift+`.=
 </div></div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_qu=
 ote">On Thu, Sep 8, 2016 at 9:03 AM, Jens Axel S=C3=B8gaard <span dir=3D"lt=
 r">&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@=
 soegaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" sty=
 le=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div d=
 ir=3D"ltr"><span style=3D"font-size:12.8px">Here is what I have so far:</sp=
 an><div><span style=3D"font-size:12.8px"><br></span></div><div>1) integer-&=
 gt;char is being called with an input that aren&#39;t accepted</div><div>2)=
  the caller is=C2=A0<span style=3D"color:rgb(51,51,51);font-family:consolas=
 ,&quot;liberation mono&quot;,menlo,courier,monospace;font-size:12px;line-he=
 ight:20px;white-space:pre-wrap">key-translate </span>a low level function w=
 hose job</div><div>=C2=A0 =C2=A0 is to translate (physical) keycodes into c=
 haracters using=C2=A0</div><div>=C2=A0 =C2=A0 a keyboard layout.=C2=A0</div=
 ><div>3) it is a bug in key-translate that integer-&gt;char is called with<=
 /div><div>=C2=A0 =C2=A0 an integer that doesn&#39;t correspond to a charact=
 er</div><div><br></div><div>4) From=C2=A0</div><div><span><span style=3D"fo=
 nt-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 integer-&gt;char: contra=
 ct violation</span><br style=3D"font-size:12.8px"><span style=3D"font-size:=
 12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 expected: (and/c (integer-in 0 #=
 x10FFFF) (not/c (integer-in #xD800 #xDFFF)))</span><br style=3D"font-size:1=
 2.8px"><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =
 given: 55357<br></span></span>=C2=A0 =C2=A0 we learn that the operating sys=
 tem translated a keycode to the codepoint=C2=A0<span style=3D"font-size:12.=
 8px">55357.</span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0=
  That code point lies in the range D800 to DFFF which are not accepted by</=
 span></div><div><span style=3D"font-size:12.8px">=C2=A0 =C2=A0 integer-&gt;=
 char</span></div><div><span style=3D"font-size:12.8px">5) That range is cal=
 led &quot;High Surrogates&quot;=C2=A0</span></div><div><span style=3D"font-=
 size:12.8px">=C2=A0 =C2=A0 From=C2=A0</span><span style=3D"font-size:12.8px=
 "><a href=3D"http://www.alanwood.net/unicode/high_surrogates.html" target=
 =3D"_blank">http://www.alanwood.net/u<wbr>nicode/high_surrogates.html</a><b=
 r></span><span style=3D"font-size:12.8px"><br></span><span style=3D"color:r=
 gb(0,0,0);font-family:times;font-size:16px;line-height:19.2px;background-co=
 lor:rgb(255,255,242)">Surrogate code points are intended to allow mapping o=
 f additional character planes into the 16-bit Unicode system, thus allowing=
  more than 65,536 characters to be represented. The individual surrogate co=
 de points do not represent characters; they are intended to be used in pair=
 s, a high code point followed by a low code point, to stand in for a charac=
 ter in one of the supplementary planes. Their use is restricted to UTF-16. =
 They can be used for characters in=C2=A0</span><a href=3D"http://www.alanwo=
 od.net/unicode/linear_b_syllabary.html" style=3D"color:rgb(128,0,128);font-=
 family:times;font-size:16px;line-height:19.2px;background-color:rgb(255,255=
 ,242)" target=3D"_blank">Linear B Syllabary</a><span style=3D"color:rgb(0,0=
 ,0);font-family:times;font-size:16px;line-height:19.2px;background-color:rg=
 b(255,255,242)">=C2=A0and higher-numbered ranges.<br></span></div><div><spa=
 n style=3D"font-size:12.8px"><br></span></div><div><br></div><div>Is it int=
 entionally that your layout produces such code points?</div><span><font col=
 or=3D"#888888"><div><br></div><div>/Jens Axel</div><div><br></div><div><br>=
 </div></font></span></div><div><div><div class=3D"gmail_extra"><br><div cla=
 ss=3D"gmail_quote">2016-09-08 17:50 GMT+02:00 Radon Rosborough <span dir=3D=
 "ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_blank">radon.n=
 eon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_quote" style=3D=
 "margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=3D=
 "ltr">Before. If I switch after I launch DrRacket, it appears to work OK, a=
 lthough I haven&#39;t tried anything substantial to make sure everything wo=
 rks.</div><div><div><div class=3D"gmail_extra"><br><div class=3D"gmail_quot=
 e">On Thu, Sep 8, 2016 at 8:43 AM, Jens Axel S=C3=B8gaard <span dir=3D"ltr"=
 >&lt;<a href=3D"mailto:jensaxel@soegaard.net" target=3D"_blank">jensaxel@so=
 egaard.net</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=
 =3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir=
 =3D"ltr">Did you switch to your keyboard layout before or after starting Dr=
 Racket?<div><br></div><div>/Jens Axel</div><div><br></div></div><div class=
 =3D"gmail_extra"><br><div class=3D"gmail_quote">2016-09-08 17:32 GMT+02:00 =
  <span dir=3D"ltr">&lt;<a href=3D"mailto:radon.neon@gmail.com" target=3D"_b=
 lank">radon.neon@gmail.com</a>&gt;</span>:<br><blockquote class=3D"gmail_qu=
 ote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex=
 ">A new problem report is waiting at<br>
 =C2=A0 <a href=3D"http://bugs.racket-lang.org/query/?cmd=3Dview&amp;pr=3D15=
 347" rel=3D"noreferrer" target=3D"_blank">http://bugs.racket-lang.org/qu<wb=
 r>ery/?cmd=3Dview&amp;pr=3D15347</a><br>
 <br>
 Reported by Radon Rosborough for release: 6.6<br>
 <br>
 *** Description:<br>
 I use Ukelele (<a href=3D"http://scripts.sil.org/ukelele" rel=3D"noreferrer=
 " target=3D"_blank">scripts.sil.org/ukelele</a>) to manage a custom OSX key=
 board layout. If I am using my custom keyboard layout (but not when using t=
 he default keyboard layout), then when:<br>
 <br>
 - launching the &#39;drracket&#39; executable,<br>
 - opening the DrRacket application, or<br>
 - using geiser in Emacs, compiling a file with &#39;#lang slideshow&#39; in=
  it,<br>
 <br>
 Racket crashes immediately with the following error:<br>
 <br>
 integer-&gt;char: contract violation<br>
 =C2=A0 expected: (and/c (integer-in 0 #x10FFFF) (not/c (integer-in #xD800 #=
 xDFFF)))<br>
 =C2=A0 given: 55357<br>
 =C2=A0 context...:<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:495:16: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt:552:0: for-loop<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/key-translate.<wbr>rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/window.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/item.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/button.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/cocoa/platform.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /wx/platform.rkt: [running body]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /kernel.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/p<wbr>rivate=
 /mred.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>red.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/mred/m<wbr>ain.rk=
 t: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/gui-lib/racket<wbr>/gui/b=
 ase.rkt: [traversing imports]<br>
 =C2=A0 =C2=A0/Applications/Racket v6.6/share/pkgs/drracket/drrac<wbr>ket/dr=
 racket.rkt: [traversing imports]<br>
 <br>
 *** How to repeat:<br>
 I am using OS X El Capitan 10.11.6 and Racket 6.6, but I can also reproduce=
  the problem on a virtual machine with a fresh install of El Capitan 10.11.=
 <br>
 <br>
 - Download my custom keyboard layout: <a href=3D"https://drive.google.com/o=
 pen?id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0U" rel=3D"noreferrer" target=3D"_blank"=
 >https://drive.google.com/open?<wbr>id=3D0B4SqHuaCqyQmVGdNWVk5Q1FvV0<wbr>U<=
 /a><br>
 - Place &quot;My Keyboard Layout.bundle&quot; in &quot;~/Library/Keyboard L=
 ayouts&quot;.<br>
 - In System Preferences &gt; Keyboard &gt; Input Sources, add &quot;My Keyb=
 oard Layout&quot; as an input source.<br>
 - Make sure the &quot;Show Input menu in menu bar&quot; checkbox is checked=
 .<br>
 - In the Input menu in the menu bar, select &quot;My Keyboard Layout&quot;.=
 <br>
 - Launch DrRacket. It should crash (and provide the above error message if =
 it was launched from the command line).<br>
 <br>
 *** Environment:<br>
 macosx &quot;Darwin <a href=3D"http://WL-222-71.WPA.Claremont.Edu" rel=3D"n=
 oreferrer" target=3D"_blank">WL-222-71.WPA.Claremont.Edu</a> 15.6.0 Darwin =
 Kernel Version 15.6.0: Mon Aug 29 20:21:34 PDT 2016; root:xnu-3248.60.11~1/=
 RELEASE_<wbr>X86_64 x86_64&quot; (x86_64-macosx/3m) (get-display-depth) =3D=
  32<br>
 Human Language: english<br>
 (current-memory-use) 252260656<br>
 raco pkg (show):<br>
 Installation-wide:<br>
 =C2=A0Package=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Checksum=C2=A0 =C2=
 =A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0Source<br>
 =C2=A0main-distribution=C2=A0 e24e5af07557ac0f...=C2=A0 catalog...tribution=
 <br>
 =C2=A0racket-lib=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A021b7fee99c95a8d7...=C2=A0=
  catalog racket-lib<br>
 =C2=A0[189 auto-installed packages not shown]<br>
 User-specific for installation &quot;6.6&quot;:<br>
 =C2=A0[none]<br>
 <br>
 <br>
 <br>
 Collections:<br>
 (&quot;/Users/raxod502/Library/Rack<wbr>et/6.6/collects&quot;<br>
 =C2=A0(non-existent-path))<br>
 (&quot;/Applications/Racket v6.6/collects&quot;<br>
 =C2=A0(&quot;acks&quot; &quot;compiler&quot; &quot;data&quot; &quot;db&quot=
 ; &quot;dynext&quot; &quot;ffi&quot; &quot;file&quot; &quot;info&quot; &quo=
 t;info-domain&quot; &quot;json&quot; &quot;launcher&quot; &quot;net&quot; &=
 quot;openssl&quot; &quot;pkg&quot; &quot;planet&quot; &quot;racket&quot; &q=
 uot;raco&quot; &quot;reader&quot; &quot;realm&quot; &quot;s-exp&quot; &quot=
 ;setup&quot; &quot;syntax&quot; &quot;version&quot; &quot;xml&quot;))<br>
 <br>
 Recent Internal Errors:<br>
 Computer Language: ((&quot;Initial language&quot; &quot;No language chosen&=
 quot;) #(#t print mixed-fraction-e #f #t debug))<br>
 <br><span><font color=3D"#888888">
 </font></span></blockquote></div><span><font color=3D"#888888"><br><br clea=
 r=3D"all"><div><br></div>-- <br><div data-smartmail=3D"gmail_signature">-- =
 <br>Jens Axel S=C3=B8gaard<br><br></div>
 </font></span></div>
 </blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div>
 </div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
 <div data-smartmail=3D"gmail_signature">-- <br>Jens Axel S=C3=B8gaard<br><b=
 r></div>
 </div>
 </div></div></blockquote></div><br></div></div>
 
 --001a114117e2db1a7f053c148a94--
