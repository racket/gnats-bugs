From bugs+caf_=bugs=bugs.plt-scheme.org@plt-scheme.org Fri Sep 23 18:52:45 2011
Received: from mail-pz0-f48.google.com (mail-pz0-f48.google.com [209.85.210.48])
	by champlain.ccs.neu.edu (8.14.4/8.14.4) with ESMTP id p8NMqf78011224
	for <bugs@bugs.plt-scheme.org>; Fri, 23 Sep 2011 18:52:42 -0400
Message-Id: <201109232252.p8NMqc4L011218@champlain.ccs.neu.edu>
Date: Fri, 23 Sep 2011 18:52:38 -0400
From: neil.toronto@gmail.com
To: bugs@racket-lang.org
Subject: Switching tabs in DrRacket leaks memory

>Number:         12228
>Category:       drscheme
>Synopsis:       Switching tabs in DrRacket leaks memory
>Class:          sw-bug
>Responsible:    mflatt
>Severity:       serious
>Priority:       medium
>State:          closed
>Confidential:   no
>Arrival-Date:   Fri Sep 23 18:56:01 -0400 2011
>Closed-Date:    Sun Oct 09 11:02:46 -0400 2011
>Last-Modified:  Thu Jan 26 11:28:01 -0500 2012
>Originator:     Neil Toronto
>Organization:
plt
>Submitter-Id:   unknown
>Release:        5.1.3
>Environment:
unix "Linux schroder 2.6.38-11-generic #48-Ubuntu SMP Fri Jul 29 19:02:55 UTC 2011 x86_64 x86_64 x86_64 GNU/Linux" (x86_64-linux/3m) (get-display-depth) = 32
Human Language: english
(current-memory-use) 280702544

Collections:
("/home/neil/.racket/5.1.3/collects"
 (non-existent-path))
("/usr/racket/collects"
 ("wxme" "texpict" "compiler" "typed" "games" "algol60" "browser" "file" "readline" "dynext" "scribblings" "mzcom" "trace" "profile" "data" "parser-tools" "tex2page" "scriblib" "swindle" "schemeunit" "r6rs" "mzlib" "mysterx" "mrlib" "scheme" "combinator-parser" "html" "test-engine" "version" "make" "ffi" "mzscheme" "picturing-programs" "hierlist" "teachpack" "at-exp" "lazy" "scribble" "openssl" "defaults" "racket" "2htdp" "drscheme" "help" "eopl" "racklog" "drracket" "icons" "errortrace" "preprocessor" "rackunit" "rnrs" "string-constants" "slatex" "graphics" "redex" "reader" "plai" "config" "stepper" "frtime" "unstable" "r5rs" "planet" "s-exp" "embedded-gui" "info-domain" "syntax" "launcher" "typed-scheme" "syntax-color" "srfi" "test-box-recovery" "xml" "plot" "datalog" "sgl" "htdp" "setup" "lang" "raco" "gui-debugger" "framework" "web-server" "deinprogramm" "slideshow" "macro-debugger" "net" "mred"))

Computer Language: (("Determine language from source") (#(#t print mixed-fraction-e #f #t debug) (default) #("-n" "--keep-titlebar") "#lang racket\n" #t #t))
>Description:
I have a "test case" (my plot library) in which I can get DrRacket to consume 2GB in about an hour just by editing and running code normally. The reproduction steps below cause a slower leak.
>How-To-Repeat:
1. Paste this program into an editor ("Tab #1"):

#lang racket

(time (collect-garbage)
      (collect-garbage))
(display (format "Memory used: ~aM~n" (round (/ (current-memory-use) (expt 1024 2)))))


2. Open a new tab ("Tab #2")

3. Switch to Tab #1; run the program

4. Many times: Switch to Tab #2, then back to Tab #1

6. Run the program


The time taken to collect garbage and the memory usage should both increase. The memory used seems to be unrecoverable (i.e. closing tabs and/or collecting garbage doesn't reclaim it).
>Fix:
>Audit-Trail:
From: Robby Findler <robby@eecs.northwestern.edu>
To: neil.toronto@gmail.com, bugs@racket-lang.org
Cc: nobody@racket-lang.org, bug-notification@racket-lang.org
Subject: Re: [racket-bug] all/12228: Switching tabs in DrRacket leaks memory
Date: Sun, 25 Sep 2011 17:34:31 -0500

 On Fri, Sep 23, 2011 at 5:56 PM,  <neil.toronto@gmail.com> wrote:
 > A new problem report is waiting at
 >  http://bugs.racket-lang.org/query/?cmd=view&pr=12228
 
 I tried the experiment suggested in the PR but instead of running the
 program to determine how much memory there (which requires a bunch of
 allocation to set up the user space and thus confuses the experiment)
 I just clicked on the memory use thing in the corner of drracket's
 window (submitting things to the REPL would also be better than
 hitting "Run"). I too saw what seemed to be a very small increase. So
 I tried to see what dump-memory-stats would say. The below is the
 before and after switching tabs many times (maybe 50 or so) and then
 clicking collect garbage many times to try to get to a fixed point.
 
 These dumps suggest that my reading of the memory use was actually
 wrong, tho, and there is no leak. Unless I'm reading them wrong?
 
 It would be good if someone who is more familiar with these dumps
 takes a second look.
 
 Begin Dump
 Begin Racket3m
     <application-code>:      58985    2591760
   <unary-application-c:      67116    1073856
   <binary-application-:      57937    1390488
        <sequence-code>:      14954     461600
          <branch-code>:      28196     676704
       <procedure-code>:      48865    2345520
       <let-value-code>:       4858     116592
        <let-void-code>:       2241      35856
          <letrec-code>:         71       1704
         <let-one-code>:      38733     619728
   <with-continuation-m:        150       3600
   <define-values-code>:      27018     677760
            <set!-code>:        116       2784
          <boxenv-code>:        772      12352
          <begin0-code>:       2089      63840
   <splicing-begin-code:         24        840
          <varref-code>:       3264      52224
    <apply-values-code>:        171       2736
     <case-lambda-code>:       2063      68272
          <module-code>:       2224     249088
   <global-variable-cod:      77110    1850640
   <module-variable-cod:       4924     157568
            <primitive>:      24133     965312
    <primitive-closure>:        926      29632
            <procedure>:       2304      36864
            <procedure>:          4        128
               <struct>:      14233     375544
            <procedure>:      94316    2149600
            <chaperone>:       2627      63048
            <chaperone>:         16        384
               <struct>:     120315    3292608
       <bignum-integer>:         92       1808
    <fractional-number>:         59        944
       <complex-number>:          1         16
               <string>:      93092    1489472
          <byte-string>:       4648      74368
         <windows-path>:       5736      91776
                 <pair>:     929237   14867792
         <mutable-pair>:        210       3360
               <vector>:     220605   10594792
            <inspector>:       2813      45008
           <input-port>:       1897     349048
          <output-port>:        960     115200
                <macro>:       5739      91824
                  <box>:      17938     287008
               <thread>:         29      16240
            <semaphore>:        474      11376
                 <hash>:       8535     341400
                 <hash>:       3379      81096
             <cpointer>:       1613      25864
       <runtime-prefix>:       6067     853768
             <weak-box>:      14530     464960
            <ephemeron>:       1313      31512
          <struct-type>:       6431     495664
    <module-path-index>:      39372    1259904
     <set!-transformer>:        439       7024
            <namespace>:      12700    1727200
     <parameterization>:         10        160
               <syntax>:      19350     619200
        <will-executor>:          1         24
            <custodian>:         10        800
               <regexp>:        184      26736
    <hash-table-bucket>:      15575     249200
                 <hash>:      24859     994360
           <wrap-chunk>:       2879     129224
      <struct-property>:        139       3336
   <chaperone-property>:          7        168
         <rename-table>:       2223     106704
            unknown,110:       4825     193000
       <resolve-prefix>:       6845     273800
       <security-guard>:          1         24
   <rename-transformer>:          9        144
              <evt-set>:         54       1296
                  <evt>:          5         80
                  <evt>:         75       1200
       <semaphore-peek>:         28        448
              <channel>:         76       1824
          <channel-put>:          2         32
      <thread-dead-evt>:          2         32
      <module-registry>:          6         96
           <thread-set>:          3         96
     <string-converter>:          6        144
          <thread-cell>:        636      10176
       <channel-syncer>:         83       3320
            <readtable>:          2         48
   <variable-reference>:         27        432
             <raw-pair>:      38891     622256
            unknown,152:         37       2072
   <continuation-prompt:         17        272
        <custodian-box>:          2         32
            unknown,157:       1908      30528
            unknown,158:       3437     192472
               <logger>:          4        160
         <log-receiver>:          4         96
            unknown,164:        589       9424
                <place>:          1         32
            unknown,179:          3    1183816
            unknown,190:          1         88
            unknown,191:          7        448
            unknown,193:          2         48
            unknown,194:          9        504
            unknown,198:        947      45456
            unknown,202:          2         48
            unknown,205:        943      45264
            unknown,211:        453      10872
            unknown,212:         20        480
            unknown,213:      16904     405696
            unknown,216:        737      17688
            unknown,217:       2445      78240
            unknown,222:         29        464
            unknown,223:        287       9184
            unknown,225:         26       1456
            unknown,227:          8        448
            unknown,228:         13        728
            unknown,234:          2        688
            unknown,237:      42681    1707240
            unknown,238:       5061     242928
            unknown,240:       2224      71168
            unknown,241:        943      60352
            unknown,243:        582      13968
            unknown,244:         30     123120
            unknown,247:      10542     337344
            unknown,249:       1801      57632
              <ffi-lib>:         27        648
              <ffi-obj>:        435      10440
                <ctype>:        333       7992
         <ffi-callback>:       1185      37920
 End Racket3m
 Generation 0: ??? of 290414 bytes used
 Generation 1 [tagged]: 3a40abc bytes used in 3a5 pages
 Generation 1 [atomic]: 1e761a4 bytes used in 1fd pages
 Generation 1 [array]: a4b4c8 bytes used in a6 pages
 Generation 1 [tagged array]: 0 bytes used in 0 pages
 Generation 1 [xtagged]: 0 bytes used in 0 pages
 Generation 1 [big]: b23eb8 bytes used in 37 pages
 Generation 1 [medium]: 42 [1/108] 1e3c [1/408] 783c [3/1008]
 
 Current memory use: a109e4c
 Peak memory use after a collection: 792f124
 Allocated (+reserved) page sizes: 9360000 (+0)
 # of major collections: 27
 # of minor collections: 23
 # of installed finalizers: 3e51
 # of traced ephemerons: 521
 # of immobile boxes: 520
 End Dump
 
 Begin Dump
 Begin Racket3m
     <application-code>:      59045    2594112
   <unary-application-c:      67398    1078368
   <binary-application-:      58074    1393776
        <sequence-code>:      15034     463640
          <branch-code>:      28318     679632
       <procedure-code>:      48868    2345664
       <let-value-code>:       4859     116616
        <let-void-code>:       2242      35872
          <letrec-code>:         71       1704
         <let-one-code>:      38851     621616
   <with-continuation-m:        150       3600
   <define-values-code>:      27018     677760
            <set!-code>:        116       2784
          <boxenv-code>:        772      12352
          <begin0-code>:       2090      63864
   <splicing-begin-code:         24        840
          <varref-code>:       3264      52224
    <apply-values-code>:        171       2736
     <case-lambda-code>:       2063      68272
          <module-code>:       2224     249088
   <global-variable-cod:      77110    1850640
   <module-variable-cod:       4924     157568
            <primitive>:      24139     965552
    <primitive-closure>:        926      29632
            <procedure>:       2304      36864
            <procedure>:          4        128
               <struct>:      14233     375544
            <procedure>:      94567    2156616
            <chaperone>:       2627      63048
            <chaperone>:         16        384
               <struct>:     120346    3293872
       <bignum-integer>:         92       1808
    <fractional-number>:         59        944
       <complex-number>:          1         16
               <string>:      93182    1490912
          <byte-string>:       4648      74368
         <windows-path>:       5736      91776
                 <pair>:     929329   14869264
         <mutable-pair>:        209       3344
               <vector>:     220675   10596144
            <inspector>:       2813      45008
           <input-port>:       1897     349048
          <output-port>:        960     115200
                <macro>:       5739      91824
                  <box>:      17976     287616
               <thread>:         29      16240
            <semaphore>:        473      11352
                 <hash>:       8538     341520
                 <hash>:       3379      81096
             <cpointer>:       1610      25816
       <runtime-prefix>:       6067     853768
             <weak-box>:      14505     464160
            <ephemeron>:       1313      31512
          <struct-type>:       6432     495736
    <module-path-index>:      39372    1259904
     <set!-transformer>:        439       7024
            <namespace>:      12700    1727200
     <parameterization>:         10        160
               <syntax>:      19350     619200
        <will-executor>:          1         24
            <custodian>:         10        800
               <regexp>:        184      26736
    <hash-table-bucket>:      14944     239104
                 <hash>:      24859     994360
           <wrap-chunk>:       2879     129224
      <struct-property>:        139       3336
   <chaperone-property>:          7        168
         <rename-table>:       2223     106704
            unknown,110:       4825     193000
       <resolve-prefix>:       6845     273800
       <security-guard>:          1         24
   <rename-transformer>:          9        144
              <evt-set>:         54       1296
                  <evt>:          5         80
                  <evt>:         75       1200
       <semaphore-peek>:         28        448
              <channel>:         76       1824
          <channel-put>:          2         32
      <thread-dead-evt>:          2         32
      <module-registry>:          6         96
           <thread-set>:          3         96
     <string-converter>:          6        144
          <thread-cell>:        636      10176
       <channel-syncer>:         83       3320
            <readtable>:          2         48
   <variable-reference>:         27        432
             <raw-pair>:      38877     622032
            unknown,152:         37       2072
   <continuation-prompt:         17        272
        <custodian-box>:          2         32
            unknown,157:       1908      30528
            unknown,158:       3437     192472
               <logger>:          4        160
         <log-receiver>:          4         96
            unknown,164:        589       9424
                <place>:          1         32
            unknown,179:          3    1183816
            unknown,190:          1         88
            unknown,191:          7        448
            unknown,193:          2         48
            unknown,194:          9        504
            unknown,198:        947      45456
            unknown,202:          2         48
            unknown,205:        943      45264
            unknown,211:        453      10872
            unknown,212:         24        576
            unknown,213:      16908     405792
            unknown,216:        734      17616
            unknown,217:       2567      82144
            unknown,222:         29        464
            unknown,223:        287       9184
            unknown,225:         26       1456
            unknown,227:          8        448
            unknown,228:         13        728
            unknown,234:          2        688
            unknown,237:      42684    1707360
            unknown,238:       5061     242928
            unknown,240:       2224      71168
            unknown,241:        943      60352
            unknown,243:        582      13968
            unknown,244:         30     123120
            unknown,247:      10542     337344
            unknown,249:       1801      57632
              <ffi-lib>:         27        648
              <ffi-obj>:        435      10440
                <ctype>:        333       7992
         <ffi-callback>:       1310      41920
 End Racket3m
 Generation 0: ??? of 1b3af4 bytes used
 Generation 1 [tagged]: 3a5339c bytes used in 3a7 pages
 Generation 1 [atomic]: 1e84c48 bytes used in 1fc pages
 Generation 1 [array]: a4c800 bytes used in a6 pages
 Generation 1 [tagged array]: 0 bytes used in 0 pages
 Generation 1 [xtagged]: 0 bytes used in 0 pages
 Generation 1 [big]: b23eb8 bytes used in 37 pages
 Generation 1 [medium]: 42 [1/108] 1e3c [1/408] 783c [3/1008]
 
 Current memory use: a04fbe8
 Peak memory use after a collection: 792f124
 Allocated (+reserved) page sizes: 9240000 (+0)
 # of major collections: 4f
 # of minor collections: 24
 # of installed finalizers: 3ef7
 # of traced ephemerons: 521
 # of immobile boxes: 5b8
 End Dump
 

From: Neil Toronto <neil.toronto@gmail.com>
To: Robby Findler <robby@eecs.northwestern.edu>
Cc: bugs@racket-lang.org, nobody@racket-lang.org,
        bug-notification@racket-lang.org
Subject: Re: [racket-bug] all/12228: Switching tabs in DrRacket leaks memory
Date: Thu, 06 Oct 2011 10:25:49 -0600

 On 09/25/2011 04:34 PM, Robby Findler wrote:
 > On Fri, Sep 23, 2011 at 5:56 PM,<neil.toronto@gmail.com>  wrote:
 >> A new problem report is waiting at
 >>   http://bugs.racket-lang.org/query/?cmd=view&pr=12228
 >
 > I tried the experiment suggested in the PR but instead of running the
 > program to determine how much memory there (which requires a bunch of
 > allocation to set up the user space and thus confuses the experiment)
 > I just clicked on the memory use thing in the corner of drracket's
 > window (submitting things to the REPL would also be better than
 > hitting "Run"). I too saw what seemed to be a very small increase. So
 > I tried to see what dump-memory-stats would say. The below is the
 > before and after switching tabs many times (maybe 50 or so) and then
 > clicking collect garbage many times to try to get to a fixed point.
 >
 > These dumps suggest that my reading of the memory use was actually
 > wrong, tho, and there is no leak. Unless I'm reading them wrong?
 >
 > It would be good if someone who is more familiar with these dumps
 > takes a second look.
 
 Were you using Ctrl-Tab to switch? I just collected some data that 
 suggests that *clicking on the tabs* causes the memory leak. It doesn't 
 even seem to require switching tabs.
 
 I've collected data for switching tabs with the keyboard, switching tabs 
 with the mouse, and NOT switching tabs, but just alternating between 
 clicking the open tab and clicking in the open editor.
 
 I've only kept data from dump-memory-stats that seemed to be increasing 
 appreciably.
 
 Don't look for increases in the first test. It's sort of like a control.
 
 For the other two, the most notable increases are in the memory use 
 indicator, # of installed finalizers, and # of immobile boxes.
 
 Last thing: because the memory leak apparently has to do with GUI event 
 handling or drawing, it might be platform-specific.
 
 =====================================================================
 Test: 10 tab switches using Ctrl-Tab
 Summary: No apparent memory leak (or too small to detect)
 
 Action: Start DrRacket, open a new tab
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL
 
 Memory use indicator: 178.37 MB
 
 Generation 1 [tagged]: 110940080 bytes used in 6787 pages
 Generation 1 [atomic]: 28657800 bytes used in 1783 pages
 Generation 1 [array]: 21144352 bytes used in 1373 pages
 Current memory use: 221253168
 Allocated (+reserved) page sizes: 233668608 (+52822016)
 # of installed finalizers: 15331
 # of immobile boxes: 731
 
 ---------------------------------------------------------------------
 
 Action: Click on open editor; 10 tab switches with Ctrl-Tab
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 
 Memory use indicator: 179.10 MB
 
 Generation 1 [tagged]: 111239592 bytes used in 6801 pages
 Generation 1 [atomic]: 28819784 bytes used in 1785 pages
 Generation 1 [array]: 21378624 bytes used in 1371 pages
 Current memory use: 202874200
 Allocated (+reserved) page sizes: 228032512 (+23412736)
 # of installed finalizers: 16044
 # of immobile boxes: 1625
 
 ---------------------------------------------------------------------
 
 Action: Click on open editor; 10 tab switchs with Ctrl-Tab
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 
 Memory use indicator: 179.84 MB
 
 Generation 1 [tagged]: 111728920 bytes used in 6831 pages
 Generation 1 [atomic]: 28995048 bytes used in 1778 pages
 Generation 1 [array]: 21474920 bytes used in 1367 pages
 Current memory use: 201494240
 Allocated (+reserved) page sizes: 227835904 (+38600704)
 # of installed finalizers: 17744
 # of immobile boxes: 3316
 
 =====================================================================
 Test: Alternate between clicking two tabs
 Summary: Memory leak
 
 Action: Start DrRacket, open a new tab
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL
 
 Memory use indicator: 178.25 MB
 
 Generation 1 [tagged]: 110601136 bytes used in 6764 pages
 Generation 1 [atomic]: 28726736 bytes used in 1779 pages
 Generation 1 [array]: 21253288 bytes used in 1393 pages
 Current memory use: 199583272
 Allocated (+reserved) page sizes: 228950016 (+92880896)
 # of installed finalizers: 15273
 # of immobile boxes: 735
 
 ---------------------------------------------------------------------
 
 Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 
 Memory use indicator: 191.71 MB
 
 Generation 1 [tagged]: 120218376 bytes used in 7350 pages
 Generation 1 [atomic]: 31242928 bytes used in 1916 pages
 Generation 1 [array]: 22654880 bytes used in 1401 pages
 Current memory use: 215291456
 Allocated (+reserved) page sizes: 240091136 (+27623424)
 # of installed finalizers: 41002
 # of immobile boxes: 26616
 
 ---------------------------------------------------------------------
 
 Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 
 Memory use indicator: 197.54 MB
 
 Generation 1 [tagged]: 124545144 bytes used in 7614 pages
 Generation 1 [atomic]: 32439992 bytes used in 1986 pages
 Generation 1 [array]: 23248928 bytes used in 1430 pages
 Current memory use: 219416184
 Allocated (+reserved) page sizes: 245710848 (+46219264)
 # of installed finalizers: 53176
 # of immobile boxes: 38752
 
 =====================================================================
 Test: Alternate between clicking open tab and clicking open editor
 Summary: Memory leak
 
 Action: Start DrRacket, open a new tab
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL
 
 Memory use indicator: 176.88 MB
 
 Generation 1 [tagged]: 111002032 bytes used in 6788 pages
 Generation 1 [atomic]: 28476736 bytes used in 1758 pages
 Generation 1 [array]: 21242264 bytes used in 1380 pages
 Current memory use: 217782744
 Allocated (+reserved) page sizes: 233308160 (+38617088)
 # of installed finalizers: 15048
 # of immobile boxes: 533
 
 ---------------------------------------------------------------------
 
 Action: Alternate clicking open tab and clicking open editor (5x)
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 
 Memory use indicator: 182.99 MB
 
 Generation 1 [tagged]: 114015808 bytes used in 6973 pages
 Generation 1 [atomic]: 29528360 bytes used in 1823 pages
 Generation 1 [array]: 21819376 bytes used in 1414 pages
 Current memory use: 205290384
 Allocated (+reserved) page sizes: 232144896 (+23609344)
 # of installed finalizers: 22727
 # of immobile boxes: 8393
 
 ---------------------------------------------------------------------
 
 Action: Alternate clicking open tab and clicking open editor (5x)
 Action: Click memory use indicator 3 times
 Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 
 Memory use indicator: 185.85 MB
 
 Generation 1 [tagged]: 115891320 bytes used in 7088 pages
 Generation 1 [atomic]: 30262488 bytes used in 1858 pages
 Generation 1 [array]: 22081528 bytes used in 1423 pages
 Current memory use: 207030072
 Allocated (+reserved) page sizes: 234651648 (+14794752)
 # of installed finalizers: 30844
 # of immobile boxes: 16489
 
 =====================================================================
 
 Neil T
From: Robby Findler <robby@eecs.northwestern.edu>
To: Neil Toronto <neil.toronto@gmail.com>
Cc: bugs@racket-lang.org, nobody@racket-lang.org,
        bug-notification@racket-lang.org
Subject: Re: [racket-bug] all/12228: Switching tabs in DrRacket leaks memory
Date: Sat, 8 Oct 2011 19:43:17 -0500

 Thanks! That's great. I see it too.
 
 It is kind of mysterious, tho, since tab-panel% itself doesn't seem to
 leak (program below) and yet the callback for clicking in DrRacket
 calls the exact same method that the callback for the menu calls (the
 change-to-nth-tab method).
 
 Well, there's still more threads to pull on here, but I wanted to at
 least ack this helpful exercise you've done.
 
 Thanks,
 Robby
 
 #lang racket/gui
 (define f (new frame% [label ""] [width 500] [height 100]))
 (define eds
   (list (new text%)
         (new text%)
         (new text%)))
 (for ([x (in-list eds)]
       [i (in-naturals 1)])
   (send x insert (format "~a" i)))
 (define tabs-panel
   (new tab-panel%
        [choices (map (λ (t) (send t get-text)) eds)]
        [parent f]
        [style '(no-border)]
        [callback
         (λ (x y)
           (let ([sel (send tabs-panel get-selection)])
             (when sel
               (send ec set-editor (list-ref eds sel)))))]))
 (define ec (new editor-canvas% [parent f] [editor (car eds)]))
 (send f show #t)
 
 
 On Thu, Oct 6, 2011 at 11:25 AM, Neil Toronto <neil.toronto@gmail.com> wrote:
 > On 09/25/2011 04:34 PM, Robby Findler wrote:
 >>
 >> On Fri, Sep 23, 2011 at 5:56 PM,<neil.toronto@gmail.com>  wrote:
 >>>
 >>> A new problem report is waiting at
 >>>  http://bugs.racket-lang.org/query/?cmd=view&pr=12228
 >>
 >> I tried the experiment suggested in the PR but instead of running the
 >> program to determine how much memory there (which requires a bunch of
 >> allocation to set up the user space and thus confuses the experiment)
 >> I just clicked on the memory use thing in the corner of drracket's
 >> window (submitting things to the REPL would also be better than
 >> hitting "Run"). I too saw what seemed to be a very small increase. So
 >> I tried to see what dump-memory-stats would say. The below is the
 >> before and after switching tabs many times (maybe 50 or so) and then
 >> clicking collect garbage many times to try to get to a fixed point.
 >>
 >> These dumps suggest that my reading of the memory use was actually
 >> wrong, tho, and there is no leak. Unless I'm reading them wrong?
 >>
 >> It would be good if someone who is more familiar with these dumps
 >> takes a second look.
 >
 > Were you using Ctrl-Tab to switch? I just collected some data that suggests
 > that *clicking on the tabs* causes the memory leak. It doesn't even seem to
 > require switching tabs.
 >
 > I've collected data for switching tabs with the keyboard, switching tabs
 > with the mouse, and NOT switching tabs, but just alternating between
 > clicking the open tab and clicking in the open editor.
 >
 > I've only kept data from dump-memory-stats that seemed to be increasing
 > appreciably.
 >
 > Don't look for increases in the first test. It's sort of like a control.
 >
 > For the other two, the most notable increases are in the memory use
 > indicator, # of installed finalizers, and # of immobile boxes.
 >
 > Last thing: because the memory leak apparently has to do with GUI event
 > handling or drawing, it might be platform-specific.
 >
 > =====================================================================
 > Test: 10 tab switches using Ctrl-Tab
 > Summary: No apparent memory leak (or too small to detect)
 >
 > Action: Start DrRacket, open a new tab
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL
 >
 > Memory use indicator: 178.37 MB
 >
 > Generation 1 [tagged]: 110940080 bytes used in 6787 pages
 > Generation 1 [atomic]: 28657800 bytes used in 1783 pages
 > Generation 1 [array]: 21144352 bytes used in 1373 pages
 > Current memory use: 221253168
 > Allocated (+reserved) page sizes: 233668608 (+52822016)
 > # of installed finalizers: 15331
 > # of immobile boxes: 731
 >
 > ---------------------------------------------------------------------
 >
 > Action: Click on open editor; 10 tab switches with Ctrl-Tab
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >
 > Memory use indicator: 179.10 MB
 >
 > Generation 1 [tagged]: 111239592 bytes used in 6801 pages
 > Generation 1 [atomic]: 28819784 bytes used in 1785 pages
 > Generation 1 [array]: 21378624 bytes used in 1371 pages
 > Current memory use: 202874200
 > Allocated (+reserved) page sizes: 228032512 (+23412736)
 > # of installed finalizers: 16044
 > # of immobile boxes: 1625
 >
 > ---------------------------------------------------------------------
 >
 > Action: Click on open editor; 10 tab switchs with Ctrl-Tab
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >
 > Memory use indicator: 179.84 MB
 >
 > Generation 1 [tagged]: 111728920 bytes used in 6831 pages
 > Generation 1 [atomic]: 28995048 bytes used in 1778 pages
 > Generation 1 [array]: 21474920 bytes used in 1367 pages
 > Current memory use: 201494240
 > Allocated (+reserved) page sizes: 227835904 (+38600704)
 > # of installed finalizers: 17744
 > # of immobile boxes: 3316
 >
 > =====================================================================
 > Test: Alternate between clicking two tabs
 > Summary: Memory leak
 >
 > Action: Start DrRacket, open a new tab
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL
 >
 > Memory use indicator: 178.25 MB
 >
 > Generation 1 [tagged]: 110601136 bytes used in 6764 pages
 > Generation 1 [atomic]: 28726736 bytes used in 1779 pages
 > Generation 1 [array]: 21253288 bytes used in 1393 pages
 > Current memory use: 199583272
 > Allocated (+reserved) page sizes: 228950016 (+92880896)
 > # of installed finalizers: 15273
 > # of immobile boxes: 735
 >
 > ---------------------------------------------------------------------
 >
 > Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >
 > Memory use indicator: 191.71 MB
 >
 > Generation 1 [tagged]: 120218376 bytes used in 7350 pages
 > Generation 1 [atomic]: 31242928 bytes used in 1916 pages
 > Generation 1 [array]: 22654880 bytes used in 1401 pages
 > Current memory use: 215291456
 > Allocated (+reserved) page sizes: 240091136 (+27623424)
 > # of installed finalizers: 41002
 > # of immobile boxes: 26616
 >
 > ---------------------------------------------------------------------
 >
 > Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >
 > Memory use indicator: 197.54 MB
 >
 > Generation 1 [tagged]: 124545144 bytes used in 7614 pages
 > Generation 1 [atomic]: 32439992 bytes used in 1986 pages
 > Generation 1 [array]: 23248928 bytes used in 1430 pages
 > Current memory use: 219416184
 > Allocated (+reserved) page sizes: 245710848 (+46219264)
 > # of installed finalizers: 53176
 > # of immobile boxes: 38752
 >
 > =====================================================================
 > Test: Alternate between clicking open tab and clicking open editor
 > Summary: Memory leak
 >
 > Action: Start DrRacket, open a new tab
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL
 >
 > Memory use indicator: 176.88 MB
 >
 > Generation 1 [tagged]: 111002032 bytes used in 6788 pages
 > Generation 1 [atomic]: 28476736 bytes used in 1758 pages
 > Generation 1 [array]: 21242264 bytes used in 1380 pages
 > Current memory use: 217782744
 > Allocated (+reserved) page sizes: 233308160 (+38617088)
 > # of installed finalizers: 15048
 > # of immobile boxes: 533
 >
 > ---------------------------------------------------------------------
 >
 > Action: Alternate clicking open tab and clicking open editor (5x)
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >
 > Memory use indicator: 182.99 MB
 >
 > Generation 1 [tagged]: 114015808 bytes used in 6973 pages
 > Generation 1 [atomic]: 29528360 bytes used in 1823 pages
 > Generation 1 [array]: 21819376 bytes used in 1414 pages
 > Current memory use: 205290384
 > Allocated (+reserved) page sizes: 232144896 (+23609344)
 > # of installed finalizers: 22727
 > # of immobile boxes: 8393
 >
 > ---------------------------------------------------------------------
 >
 > Action: Alternate clicking open tab and clicking open editor (5x)
 > Action: Click memory use indicator 3 times
 > Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >
 > Memory use indicator: 185.85 MB
 >
 > Generation 1 [tagged]: 115891320 bytes used in 7088 pages
 > Generation 1 [atomic]: 30262488 bytes used in 1858 pages
 > Generation 1 [array]: 22081528 bytes used in 1423 pages
 > Current memory use: 207030072
 > Allocated (+reserved) page sizes: 234651648 (+14794752)
 > # of installed finalizers: 30844
 > # of immobile boxes: 16489
 >
 > =====================================================================
 >
 > Neil T
 >
 
From: Robby Findler <robby@eecs.northwestern.edu>
To: Neil Toronto <neil.toronto@gmail.com>
Cc: bugs@racket-lang.org, nobody@racket-lang.org,
        bug-notification@racket-lang.org
Subject: Re: [racket-bug] all/12228: Switching tabs in DrRacket leaks memory
Date: Sun, 9 Oct 2011 08:22:17 -0500

 One more bit: I can see this happening under mac os x (and Neil is
 apparently using linux).
 
 Robby
From: Robby Findler <robby@eecs.northwestern.edu>
To: Neil Toronto <neil.toronto@gmail.com>
Cc: bugs@racket-lang.org, nobody@racket-lang.org,
        bug-notification@racket-lang.org
Subject: Re: [racket-bug] all/12228: Switching tabs in DrRacket leaks memory
Date: Sun, 9 Oct 2011 08:26:38 -0500

 And under windows, I do NOT see this happening. Maybe that's a clue
 (or maybe that's already obvious to someone who knows what is going on
 at that level).
 
 Robby
 
 On Sun, Oct 9, 2011 at 8:22 AM, Robby Findler
 <robby@eecs.northwestern.edu> wrote:
 > One more bit: I can see this happening under mac os x (and Neil is
 > apparently using linux).
 >
 > Robby
 >
Responsible changed from "robby" to "mflatt" by mflatt@racket-lang.org at Sun, 09 Oct 2011 11:02:46 -0400
Reason>>> A commit by mflatt@racket-lang.org has resolved this report
  http://git.racket-lang.org/plt/commit/8bd81f4806
State changed from "open" to "closed" by mflatt@racket-lang.org at Sun, 09 Oct 2011 11:02:46 -0400
Reason>>> A commit by mflatt@racket-lang.org has resolved this report
  http://git.racket-lang.org/plt/commit/8bd81f4806
From: Neil Toronto <neil.toronto@gmail.com>
To: Robby Findler <robby@eecs.northwestern.edu>
Cc: bugs@racket-lang.org, nobody@racket-lang.org,
        bug-notification@racket-lang.org
Subject: Re: [racket-bug] all/12228: Switching tabs in DrRacket leaks memory
Date: Thu, 26 Jan 2012 08:17:30 -0700

 I re-tested this on a whim this morning, and couldn't duplicate it on 
 5.2 or the current master. Looks like it was fixed somehow. Robby, can 
 you verify that on the machine you've duplicated it on so we can close this?
 
 Neil ⊥
 
 On 10/08/2011 06:43 PM, Robby Findler wrote:
 > Thanks! That's great. I see it too.
 >
 > It is kind of mysterious, tho, since tab-panel% itself doesn't seem to
 > leak (program below) and yet the callback for clicking in DrRacket
 > calls the exact same method that the callback for the menu calls (the
 > change-to-nth-tab method).
 >
 > Well, there's still more threads to pull on here, but I wanted to at
 > least ack this helpful exercise you've done.
 >
 > Thanks,
 > Robby
 >
 > #lang racket/gui
 > (define f (new frame% [label ""] [width 500] [height 100]))
 > (define eds
 >    (list (new text%)
 >          (new text%)
 >          (new text%)))
 > (for ([x (in-list eds)]
 >        [i (in-naturals 1)])
 >    (send x insert (format "~a" i)))
 > (define tabs-panel
 >    (new tab-panel%
 >         [choices (map (λ (t) (send t get-text)) eds)]
 >         [parent f]
 >         [style '(no-border)]
 >         [callback
 >          (λ (x y)
 >            (let ([sel (send tabs-panel get-selection)])
 >              (when sel
 >                (send ec set-editor (list-ref eds sel)))))]))
 > (define ec (new editor-canvas% [parent f] [editor (car eds)]))
 > (send f show #t)
 >
 >
 > On Thu, Oct 6, 2011 at 11:25 AM, Neil Toronto<neil.toronto@gmail.com>  wrote:
 >> On 09/25/2011 04:34 PM, Robby Findler wrote:
 >>>
 >>> On Fri, Sep 23, 2011 at 5:56 PM,<neil.toronto@gmail.com>    wrote:
 >>>>
 >>>> A new problem report is waiting at
 >>>>   http://bugs.racket-lang.org/query/?cmd=view&pr=12228
 >>>
 >>> I tried the experiment suggested in the PR but instead of running the
 >>> program to determine how much memory there (which requires a bunch of
 >>> allocation to set up the user space and thus confuses the experiment)
 >>> I just clicked on the memory use thing in the corner of drracket's
 >>> window (submitting things to the REPL would also be better than
 >>> hitting "Run"). I too saw what seemed to be a very small increase. So
 >>> I tried to see what dump-memory-stats would say. The below is the
 >>> before and after switching tabs many times (maybe 50 or so) and then
 >>> clicking collect garbage many times to try to get to a fixed point.
 >>>
 >>> These dumps suggest that my reading of the memory use was actually
 >>> wrong, tho, and there is no leak. Unless I'm reading them wrong?
 >>>
 >>> It would be good if someone who is more familiar with these dumps
 >>> takes a second look.
 >>
 >> Were you using Ctrl-Tab to switch? I just collected some data that suggests
 >> that *clicking on the tabs* causes the memory leak. It doesn't even seem to
 >> require switching tabs.
 >>
 >> I've collected data for switching tabs with the keyboard, switching tabs
 >> with the mouse, and NOT switching tabs, but just alternating between
 >> clicking the open tab and clicking in the open editor.
 >>
 >> I've only kept data from dump-memory-stats that seemed to be increasing
 >> appreciably.
 >>
 >> Don't look for increases in the first test. It's sort of like a control.
 >>
 >> For the other two, the most notable increases are in the memory use
 >> indicator, # of installed finalizers, and # of immobile boxes.
 >>
 >> Last thing: because the memory leak apparently has to do with GUI event
 >> handling or drawing, it might be platform-specific.
 >>
 >> =====================================================================
 >> Test: 10 tab switches using Ctrl-Tab
 >> Summary: No apparent memory leak (or too small to detect)
 >>
 >> Action: Start DrRacket, open a new tab
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL
 >>
 >> Memory use indicator: 178.37 MB
 >>
 >> Generation 1 [tagged]: 110940080 bytes used in 6787 pages
 >> Generation 1 [atomic]: 28657800 bytes used in 1783 pages
 >> Generation 1 [array]: 21144352 bytes used in 1373 pages
 >> Current memory use: 221253168
 >> Allocated (+reserved) page sizes: 233668608 (+52822016)
 >> # of installed finalizers: 15331
 >> # of immobile boxes: 731
 >>
 >> ---------------------------------------------------------------------
 >>
 >> Action: Click on open editor; 10 tab switches with Ctrl-Tab
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>
 >> Memory use indicator: 179.10 MB
 >>
 >> Generation 1 [tagged]: 111239592 bytes used in 6801 pages
 >> Generation 1 [atomic]: 28819784 bytes used in 1785 pages
 >> Generation 1 [array]: 21378624 bytes used in 1371 pages
 >> Current memory use: 202874200
 >> Allocated (+reserved) page sizes: 228032512 (+23412736)
 >> # of installed finalizers: 16044
 >> # of immobile boxes: 1625
 >>
 >> ---------------------------------------------------------------------
 >>
 >> Action: Click on open editor; 10 tab switchs with Ctrl-Tab
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>
 >> Memory use indicator: 179.84 MB
 >>
 >> Generation 1 [tagged]: 111728920 bytes used in 6831 pages
 >> Generation 1 [atomic]: 28995048 bytes used in 1778 pages
 >> Generation 1 [array]: 21474920 bytes used in 1367 pages
 >> Current memory use: 201494240
 >> Allocated (+reserved) page sizes: 227835904 (+38600704)
 >> # of installed finalizers: 17744
 >> # of immobile boxes: 3316
 >>
 >> =====================================================================
 >> Test: Alternate between clicking two tabs
 >> Summary: Memory leak
 >>
 >> Action: Start DrRacket, open a new tab
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL
 >>
 >> Memory use indicator: 178.25 MB
 >>
 >> Generation 1 [tagged]: 110601136 bytes used in 6764 pages
 >> Generation 1 [atomic]: 28726736 bytes used in 1779 pages
 >> Generation 1 [array]: 21253288 bytes used in 1393 pages
 >> Current memory use: 199583272
 >> Allocated (+reserved) page sizes: 228950016 (+92880896)
 >> # of installed finalizers: 15273
 >> # of immobile boxes: 735
 >>
 >> ---------------------------------------------------------------------
 >>
 >> Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>
 >> Memory use indicator: 191.71 MB
 >>
 >> Generation 1 [tagged]: 120218376 bytes used in 7350 pages
 >> Generation 1 [atomic]: 31242928 bytes used in 1916 pages
 >> Generation 1 [array]: 22654880 bytes used in 1401 pages
 >> Current memory use: 215291456
 >> Allocated (+reserved) page sizes: 240091136 (+27623424)
 >> # of installed finalizers: 41002
 >> # of immobile boxes: 26616
 >>
 >> ---------------------------------------------------------------------
 >>
 >> Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>
 >> Memory use indicator: 197.54 MB
 >>
 >> Generation 1 [tagged]: 124545144 bytes used in 7614 pages
 >> Generation 1 [atomic]: 32439992 bytes used in 1986 pages
 >> Generation 1 [array]: 23248928 bytes used in 1430 pages
 >> Current memory use: 219416184
 >> Allocated (+reserved) page sizes: 245710848 (+46219264)
 >> # of installed finalizers: 53176
 >> # of immobile boxes: 38752
 >>
 >> =====================================================================
 >> Test: Alternate between clicking open tab and clicking open editor
 >> Summary: Memory leak
 >>
 >> Action: Start DrRacket, open a new tab
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL
 >>
 >> Memory use indicator: 176.88 MB
 >>
 >> Generation 1 [tagged]: 111002032 bytes used in 6788 pages
 >> Generation 1 [atomic]: 28476736 bytes used in 1758 pages
 >> Generation 1 [array]: 21242264 bytes used in 1380 pages
 >> Current memory use: 217782744
 >> Allocated (+reserved) page sizes: 233308160 (+38617088)
 >> # of installed finalizers: 15048
 >> # of immobile boxes: 533
 >>
 >> ---------------------------------------------------------------------
 >>
 >> Action: Alternate clicking open tab and clicking open editor (5x)
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>
 >> Memory use indicator: 182.99 MB
 >>
 >> Generation 1 [tagged]: 114015808 bytes used in 6973 pages
 >> Generation 1 [atomic]: 29528360 bytes used in 1823 pages
 >> Generation 1 [array]: 21819376 bytes used in 1414 pages
 >> Current memory use: 205290384
 >> Allocated (+reserved) page sizes: 232144896 (+23609344)
 >> # of installed finalizers: 22727
 >> # of immobile boxes: 8393
 >>
 >> ---------------------------------------------------------------------
 >>
 >> Action: Alternate clicking open tab and clicking open editor (5x)
 >> Action: Click memory use indicator 3 times
 >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>
 >> Memory use indicator: 185.85 MB
 >>
 >> Generation 1 [tagged]: 115891320 bytes used in 7088 pages
 >> Generation 1 [atomic]: 30262488 bytes used in 1858 pages
 >> Generation 1 [array]: 22081528 bytes used in 1423 pages
 >> Current memory use: 207030072
 >> Allocated (+reserved) page sizes: 234651648 (+14794752)
 >> # of installed finalizers: 30844
 >> # of immobile boxes: 16489
 >>
 >> =====================================================================
 >>
 >> Neil T
 >>
 
From: Matthew Flatt <mflatt@cs.utah.edu>
To: Neil Toronto <neil.toronto@gmail.com>
Cc: Robby Findler <robby@eecs.northwestern.edu>, bugs@racket-lang.org,
        nobody@racket-lang.org, bug-notification@racket-lang.org
Subject: Re: [racket-bug] all/12228: Switching tabs in DrRacket leaks memory
Date: Thu, 26 Jan 2012 10:58:29 -0500

 If I remember correctly, investigation of this problem led to the
 repair in commit 8bd81f48062ef.
 
 At Thu, 26 Jan 2012 08:17:30 -0700, Neil Toronto wrote:
 > I re-tested this on a whim this morning, and couldn't duplicate it on 
 > 5.2 or the current master. Looks like it was fixed somehow. Robby, can 
 > you verify that on the machine you've duplicated it on so we can close this?
 > 
 > Neil ⊥
 > 
 > On 10/08/2011 06:43 PM, Robby Findler wrote:
 > > Thanks! That's great. I see it too.
 > >
 > > It is kind of mysterious, tho, since tab-panel% itself doesn't seem to
 > > leak (program below) and yet the callback for clicking in DrRacket
 > > calls the exact same method that the callback for the menu calls (the
 > > change-to-nth-tab method).
 > >
 > > Well, there's still more threads to pull on here, but I wanted to at
 > > least ack this helpful exercise you've done.
 > >
 > > Thanks,
 > > Robby
 > >
 > > #lang racket/gui
 > > (define f (new frame% [label ""] [width 500] [height 100]))
 > > (define eds
 > >    (list (new text%)
 > >          (new text%)
 > >          (new text%)))
 > > (for ([x (in-list eds)]
 > >        [i (in-naturals 1)])
 > >    (send x insert (format "~a" i)))
 > > (define tabs-panel
 > >    (new tab-panel%
 > >         [choices (map (λ (t) (send t get-text)) eds)]
 > >         [parent f]
 > >         [style '(no-border)]
 > >         [callback
 > >          (λ (x y)
 > >            (let ([sel (send tabs-panel get-selection)])
 > >              (when sel
 > >                (send ec set-editor (list-ref eds sel)))))]))
 > > (define ec (new editor-canvas% [parent f] [editor (car eds)]))
 > > (send f show #t)
 > >
 > >
 > > On Thu, Oct 6, 2011 at 11:25 AM, Neil Toronto<neil.toronto@gmail.com>  wrote:
 > >> On 09/25/2011 04:34 PM, Robby Findler wrote:
 > >>>
 > >>> On Fri, Sep 23, 2011 at 5:56 PM,<neil.toronto@gmail.com>    wrote:
 > >>>>
 > >>>> A new problem report is waiting at
 > >>>>   http://bugs.racket-lang.org/query/?cmd=view&pr=12228
 > >>>
 > >>> I tried the experiment suggested in the PR but instead of running the
 > >>> program to determine how much memory there (which requires a bunch of
 > >>> allocation to set up the user space and thus confuses the experiment)
 > >>> I just clicked on the memory use thing in the corner of drracket's
 > >>> window (submitting things to the REPL would also be better than
 > >>> hitting "Run"). I too saw what seemed to be a very small increase. So
 > >>> I tried to see what dump-memory-stats would say. The below is the
 > >>> before and after switching tabs many times (maybe 50 or so) and then
 > >>> clicking collect garbage many times to try to get to a fixed point.
 > >>>
 > >>> These dumps suggest that my reading of the memory use was actually
 > >>> wrong, tho, and there is no leak. Unless I'm reading them wrong?
 > >>>
 > >>> It would be good if someone who is more familiar with these dumps
 > >>> takes a second look.
 > >>
 > >> Were you using Ctrl-Tab to switch? I just collected some data that suggests
 > >> that *clicking on the tabs* causes the memory leak. It doesn't even seem to
 > >> require switching tabs.
 > >>
 > >> I've collected data for switching tabs with the keyboard, switching tabs
 > >> with the mouse, and NOT switching tabs, but just alternating between
 > >> clicking the open tab and clicking in the open editor.
 > >>
 > >> I've only kept data from dump-memory-stats that seemed to be increasing
 > >> appreciably.
 > >>
 > >> Don't look for increases in the first test. It's sort of like a control.
 > >>
 > >> For the other two, the most notable increases are in the memory use
 > >> indicator, # of installed finalizers, and # of immobile boxes.
 > >>
 > >> Last thing: because the memory leak apparently has to do with GUI event
 > >> handling or drawing, it might be platform-specific.
 > >>
 > >> =====================================================================
 > >> Test: 10 tab switches using Ctrl-Tab
 > >> Summary: No apparent memory leak (or too small to detect)
 > >>
 > >> Action: Start DrRacket, open a new tab
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL
 > >>
 > >> Memory use indicator: 178.37 MB
 > >>
 > >> Generation 1 [tagged]: 110940080 bytes used in 6787 pages
 > >> Generation 1 [atomic]: 28657800 bytes used in 1783 pages
 > >> Generation 1 [array]: 21144352 bytes used in 1373 pages
 > >> Current memory use: 221253168
 > >> Allocated (+reserved) page sizes: 233668608 (+52822016)
 > >> # of installed finalizers: 15331
 > >> # of immobile boxes: 731
 > >>
 > >> ---------------------------------------------------------------------
 > >>
 > >> Action: Click on open editor; 10 tab switches with Ctrl-Tab
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 > >>
 > >> Memory use indicator: 179.10 MB
 > >>
 > >> Generation 1 [tagged]: 111239592 bytes used in 6801 pages
 > >> Generation 1 [atomic]: 28819784 bytes used in 1785 pages
 > >> Generation 1 [array]: 21378624 bytes used in 1371 pages
 > >> Current memory use: 202874200
 > >> Allocated (+reserved) page sizes: 228032512 (+23412736)
 > >> # of installed finalizers: 16044
 > >> # of immobile boxes: 1625
 > >>
 > >> ---------------------------------------------------------------------
 > >>
 > >> Action: Click on open editor; 10 tab switchs with Ctrl-Tab
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 > >>
 > >> Memory use indicator: 179.84 MB
 > >>
 > >> Generation 1 [tagged]: 111728920 bytes used in 6831 pages
 > >> Generation 1 [atomic]: 28995048 bytes used in 1778 pages
 > >> Generation 1 [array]: 21474920 bytes used in 1367 pages
 > >> Current memory use: 201494240
 > >> Allocated (+reserved) page sizes: 227835904 (+38600704)
 > >> # of installed finalizers: 17744
 > >> # of immobile boxes: 3316
 > >>
 > >> =====================================================================
 > >> Test: Alternate between clicking two tabs
 > >> Summary: Memory leak
 > >>
 > >> Action: Start DrRacket, open a new tab
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL
 > >>
 > >> Memory use indicator: 178.25 MB
 > >>
 > >> Generation 1 [tagged]: 110601136 bytes used in 6764 pages
 > >> Generation 1 [atomic]: 28726736 bytes used in 1779 pages
 > >> Generation 1 [array]: 21253288 bytes used in 1393 pages
 > >> Current memory use: 199583272
 > >> Allocated (+reserved) page sizes: 228950016 (+92880896)
 > >> # of installed finalizers: 15273
 > >> # of immobile boxes: 735
 > >>
 > >> ---------------------------------------------------------------------
 > >>
 > >> Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 > >>
 > >> Memory use indicator: 191.71 MB
 > >>
 > >> Generation 1 [tagged]: 120218376 bytes used in 7350 pages
 > >> Generation 1 [atomic]: 31242928 bytes used in 1916 pages
 > >> Generation 1 [array]: 22654880 bytes used in 1401 pages
 > >> Current memory use: 215291456
 > >> Allocated (+reserved) page sizes: 240091136 (+27623424)
 > >> # of installed finalizers: 41002
 > >> # of immobile boxes: 26616
 > >>
 > >> ---------------------------------------------------------------------
 > >>
 > >> Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 > >>
 > >> Memory use indicator: 197.54 MB
 > >>
 > >> Generation 1 [tagged]: 124545144 bytes used in 7614 pages
 > >> Generation 1 [atomic]: 32439992 bytes used in 1986 pages
 > >> Generation 1 [array]: 23248928 bytes used in 1430 pages
 > >> Current memory use: 219416184
 > >> Allocated (+reserved) page sizes: 245710848 (+46219264)
 > >> # of installed finalizers: 53176
 > >> # of immobile boxes: 38752
 > >>
 > >> =====================================================================
 > >> Test: Alternate between clicking open tab and clicking open editor
 > >> Summary: Memory leak
 > >>
 > >> Action: Start DrRacket, open a new tab
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL
 > >>
 > >> Memory use indicator: 176.88 MB
 > >>
 > >> Generation 1 [tagged]: 111002032 bytes used in 6788 pages
 > >> Generation 1 [atomic]: 28476736 bytes used in 1758 pages
 > >> Generation 1 [array]: 21242264 bytes used in 1380 pages
 > >> Current memory use: 217782744
 > >> Allocated (+reserved) page sizes: 233308160 (+38617088)
 > >> # of installed finalizers: 15048
 > >> # of immobile boxes: 533
 > >>
 > >> ---------------------------------------------------------------------
 > >>
 > >> Action: Alternate clicking open tab and clicking open editor (5x)
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 > >>
 > >> Memory use indicator: 182.99 MB
 > >>
 > >> Generation 1 [tagged]: 114015808 bytes used in 6973 pages
 > >> Generation 1 [atomic]: 29528360 bytes used in 1823 pages
 > >> Generation 1 [array]: 21819376 bytes used in 1414 pages
 > >> Current memory use: 205290384
 > >> Allocated (+reserved) page sizes: 232144896 (+23609344)
 > >> # of installed finalizers: 22727
 > >> # of immobile boxes: 8393
 > >>
 > >> ---------------------------------------------------------------------
 > >>
 > >> Action: Alternate clicking open tab and clicking open editor (5x)
 > >> Action: Click memory use indicator 3 times
 > >> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 > >>
 > >> Memory use indicator: 185.85 MB
 > >>
 > >> Generation 1 [tagged]: 115891320 bytes used in 7088 pages
 > >> Generation 1 [atomic]: 30262488 bytes used in 1858 pages
 > >> Generation 1 [array]: 22081528 bytes used in 1423 pages
 > >> Current memory use: 207030072
 > >> Allocated (+reserved) page sizes: 234651648 (+14794752)
 > >> # of installed finalizers: 30844
 > >> # of immobile boxes: 16489
 > >>
 > >> =====================================================================
 > >>
 > >> Neil T
 > >>
 
From: Neil Toronto <neil.toronto@gmail.com>
To: Matthew Flatt <mflatt@cs.utah.edu>
Cc: Robby Findler <robby@eecs.northwestern.edu>, bugs@racket-lang.org,
        nobody@racket-lang.org, bug-notification@racket-lang.org
Subject: Re: [racket-bug] all/12228: Switching tabs in DrRacket leaks memory
Date: Thu, 26 Jan 2012 09:25:15 -0700

 Somehow I didn't see the close message. Huh. Well, anyway, I think I've 
 verified that it worked. :) Thanks, Matthew.
 
 Neil ⊥
 
 On 01/26/2012 08:58 AM, Matthew Flatt wrote:
 > If I remember correctly, investigation of this problem led to the
 > repair in commit 8bd81f48062ef.
 >
 > At Thu, 26 Jan 2012 08:17:30 -0700, Neil Toronto wrote:
 >> I re-tested this on a whim this morning, and couldn't duplicate it on
 >> 5.2 or the current master. Looks like it was fixed somehow. Robby, can
 >> you verify that on the machine you've duplicated it on so we can close this?
 >>
 >> Neil ⊥
 >>
 >> On 10/08/2011 06:43 PM, Robby Findler wrote:
 >>> Thanks! That's great. I see it too.
 >>>
 >>> It is kind of mysterious, tho, since tab-panel% itself doesn't seem to
 >>> leak (program below) and yet the callback for clicking in DrRacket
 >>> calls the exact same method that the callback for the menu calls (the
 >>> change-to-nth-tab method).
 >>>
 >>> Well, there's still more threads to pull on here, but I wanted to at
 >>> least ack this helpful exercise you've done.
 >>>
 >>> Thanks,
 >>> Robby
 >>>
 >>> #lang racket/gui
 >>> (define f (new frame% [label ""] [width 500] [height 100]))
 >>> (define eds
 >>>     (list (new text%)
 >>>           (new text%)
 >>>           (new text%)))
 >>> (for ([x (in-list eds)]
 >>>         [i (in-naturals 1)])
 >>>     (send x insert (format "~a" i)))
 >>> (define tabs-panel
 >>>     (new tab-panel%
 >>>          [choices (map (λ (t) (send t get-text)) eds)]
 >>>          [parent f]
 >>>          [style '(no-border)]
 >>>          [callback
 >>>           (λ (x y)
 >>>             (let ([sel (send tabs-panel get-selection)])
 >>>               (when sel
 >>>                 (send ec set-editor (list-ref eds sel)))))]))
 >>> (define ec (new editor-canvas% [parent f] [editor (car eds)]))
 >>> (send f show #t)
 >>>
 >>>
 >>> On Thu, Oct 6, 2011 at 11:25 AM, Neil Toronto<neil.toronto@gmail.com>   wrote:
 >>>> On 09/25/2011 04:34 PM, Robby Findler wrote:
 >>>>>
 >>>>> On Fri, Sep 23, 2011 at 5:56 PM,<neil.toronto@gmail.com>     wrote:
 >>>>>>
 >>>>>> A new problem report is waiting at
 >>>>>>    http://bugs.racket-lang.org/query/?cmd=view&pr=12228
 >>>>>
 >>>>> I tried the experiment suggested in the PR but instead of running the
 >>>>> program to determine how much memory there (which requires a bunch of
 >>>>> allocation to set up the user space and thus confuses the experiment)
 >>>>> I just clicked on the memory use thing in the corner of drracket's
 >>>>> window (submitting things to the REPL would also be better than
 >>>>> hitting "Run"). I too saw what seemed to be a very small increase. So
 >>>>> I tried to see what dump-memory-stats would say. The below is the
 >>>>> before and after switching tabs many times (maybe 50 or so) and then
 >>>>> clicking collect garbage many times to try to get to a fixed point.
 >>>>>
 >>>>> These dumps suggest that my reading of the memory use was actually
 >>>>> wrong, tho, and there is no leak. Unless I'm reading them wrong?
 >>>>>
 >>>>> It would be good if someone who is more familiar with these dumps
 >>>>> takes a second look.
 >>>>
 >>>> Were you using Ctrl-Tab to switch? I just collected some data that suggests
 >>>> that *clicking on the tabs* causes the memory leak. It doesn't even seem to
 >>>> require switching tabs.
 >>>>
 >>>> I've collected data for switching tabs with the keyboard, switching tabs
 >>>> with the mouse, and NOT switching tabs, but just alternating between
 >>>> clicking the open tab and clicking in the open editor.
 >>>>
 >>>> I've only kept data from dump-memory-stats that seemed to be increasing
 >>>> appreciably.
 >>>>
 >>>> Don't look for increases in the first test. It's sort of like a control.
 >>>>
 >>>> For the other two, the most notable increases are in the memory use
 >>>> indicator, # of installed finalizers, and # of immobile boxes.
 >>>>
 >>>> Last thing: because the memory leak apparently has to do with GUI event
 >>>> handling or drawing, it might be platform-specific.
 >>>>
 >>>> =====================================================================
 >>>> Test: 10 tab switches using Ctrl-Tab
 >>>> Summary: No apparent memory leak (or too small to detect)
 >>>>
 >>>> Action: Start DrRacket, open a new tab
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL
 >>>>
 >>>> Memory use indicator: 178.37 MB
 >>>>
 >>>> Generation 1 [tagged]: 110940080 bytes used in 6787 pages
 >>>> Generation 1 [atomic]: 28657800 bytes used in 1783 pages
 >>>> Generation 1 [array]: 21144352 bytes used in 1373 pages
 >>>> Current memory use: 221253168
 >>>> Allocated (+reserved) page sizes: 233668608 (+52822016)
 >>>> # of installed finalizers: 15331
 >>>> # of immobile boxes: 731
 >>>>
 >>>> ---------------------------------------------------------------------
 >>>>
 >>>> Action: Click on open editor; 10 tab switches with Ctrl-Tab
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>>>
 >>>> Memory use indicator: 179.10 MB
 >>>>
 >>>> Generation 1 [tagged]: 111239592 bytes used in 6801 pages
 >>>> Generation 1 [atomic]: 28819784 bytes used in 1785 pages
 >>>> Generation 1 [array]: 21378624 bytes used in 1371 pages
 >>>> Current memory use: 202874200
 >>>> Allocated (+reserved) page sizes: 228032512 (+23412736)
 >>>> # of installed finalizers: 16044
 >>>> # of immobile boxes: 1625
 >>>>
 >>>> ---------------------------------------------------------------------
 >>>>
 >>>> Action: Click on open editor; 10 tab switchs with Ctrl-Tab
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>>>
 >>>> Memory use indicator: 179.84 MB
 >>>>
 >>>> Generation 1 [tagged]: 111728920 bytes used in 6831 pages
 >>>> Generation 1 [atomic]: 28995048 bytes used in 1778 pages
 >>>> Generation 1 [array]: 21474920 bytes used in 1367 pages
 >>>> Current memory use: 201494240
 >>>> Allocated (+reserved) page sizes: 227835904 (+38600704)
 >>>> # of installed finalizers: 17744
 >>>> # of immobile boxes: 3316
 >>>>
 >>>> =====================================================================
 >>>> Test: Alternate between clicking two tabs
 >>>> Summary: Memory leak
 >>>>
 >>>> Action: Start DrRacket, open a new tab
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL
 >>>>
 >>>> Memory use indicator: 178.25 MB
 >>>>
 >>>> Generation 1 [tagged]: 110601136 bytes used in 6764 pages
 >>>> Generation 1 [atomic]: 28726736 bytes used in 1779 pages
 >>>> Generation 1 [array]: 21253288 bytes used in 1393 pages
 >>>> Current memory use: 199583272
 >>>> Allocated (+reserved) page sizes: 228950016 (+92880896)
 >>>> # of installed finalizers: 15273
 >>>> # of immobile boxes: 735
 >>>>
 >>>> ---------------------------------------------------------------------
 >>>>
 >>>> Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>>>
 >>>> Memory use indicator: 191.71 MB
 >>>>
 >>>> Generation 1 [tagged]: 120218376 bytes used in 7350 pages
 >>>> Generation 1 [atomic]: 31242928 bytes used in 1916 pages
 >>>> Generation 1 [array]: 22654880 bytes used in 1401 pages
 >>>> Current memory use: 215291456
 >>>> Allocated (+reserved) page sizes: 240091136 (+27623424)
 >>>> # of installed finalizers: 41002
 >>>> # of immobile boxes: 26616
 >>>>
 >>>> ---------------------------------------------------------------------
 >>>>
 >>>> Action: Alternate clicking "Untitled" tab, "Untitled 2" tab (5x)
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>>>
 >>>> Memory use indicator: 197.54 MB
 >>>>
 >>>> Generation 1 [tagged]: 124545144 bytes used in 7614 pages
 >>>> Generation 1 [atomic]: 32439992 bytes used in 1986 pages
 >>>> Generation 1 [array]: 23248928 bytes used in 1430 pages
 >>>> Current memory use: 219416184
 >>>> Allocated (+reserved) page sizes: 245710848 (+46219264)
 >>>> # of installed finalizers: 53176
 >>>> # of immobile boxes: 38752
 >>>>
 >>>> =====================================================================
 >>>> Test: Alternate between clicking open tab and clicking open editor
 >>>> Summary: Memory leak
 >>>>
 >>>> Action: Start DrRacket, open a new tab
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL
 >>>>
 >>>> Memory use indicator: 176.88 MB
 >>>>
 >>>> Generation 1 [tagged]: 111002032 bytes used in 6788 pages
 >>>> Generation 1 [atomic]: 28476736 bytes used in 1758 pages
 >>>> Generation 1 [array]: 21242264 bytes used in 1380 pages
 >>>> Current memory use: 217782744
 >>>> Allocated (+reserved) page sizes: 233308160 (+38617088)
 >>>> # of installed finalizers: 15048
 >>>> # of immobile boxes: 533
 >>>>
 >>>> ---------------------------------------------------------------------
 >>>>
 >>>> Action: Alternate clicking open tab and clicking open editor (5x)
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>>>
 >>>> Memory use indicator: 182.99 MB
 >>>>
 >>>> Generation 1 [tagged]: 114015808 bytes used in 6973 pages
 >>>> Generation 1 [atomic]: 29528360 bytes used in 1823 pages
 >>>> Generation 1 [array]: 21819376 bytes used in 1414 pages
 >>>> Current memory use: 205290384
 >>>> Allocated (+reserved) page sizes: 232144896 (+23609344)
 >>>> # of installed finalizers: 22727
 >>>> # of immobile boxes: 8393
 >>>>
 >>>> ---------------------------------------------------------------------
 >>>>
 >>>> Action: Alternate clicking open tab and clicking open editor (5x)
 >>>> Action: Click memory use indicator 3 times
 >>>> Action: (dump-memory-stats) in REPL (Ctrl-Up, Enter)
 >>>>
 >>>> Memory use indicator: 185.85 MB
 >>>>
 >>>> Generation 1 [tagged]: 115891320 bytes used in 7088 pages
 >>>> Generation 1 [atomic]: 30262488 bytes used in 1858 pages
 >>>> Generation 1 [array]: 22081528 bytes used in 1423 pages
 >>>> Current memory use: 207030072
 >>>> Allocated (+reserved) page sizes: 234651648 (+14794752)
 >>>> # of installed finalizers: 30844
 >>>> # of immobile boxes: 16489
 >>>>
 >>>> =====================================================================
 >>>>
 >>>> Neil T
 >>>>
 
