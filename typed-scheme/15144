From bugs+caf_=bugs=bugs.plt-scheme.org@plt-scheme.org Fri Sep  4 04:31:55 2015
Received: from mail-io0-f171.google.com (mail-io0-f171.google.com [209.85.223.171])
	by winooski.ccs.neu.edu (8.14.7/8.14.7) with ESMTP id t848VrCW018317
	for <bugs@bugs.plt-scheme.org>; Fri, 4 Sep 2015 04:31:53 -0400
Message-Id: <201509040831.t848Vo7f018302@winooski.ccs.neu.edu>
Date: Fri, 4 Sep 2015 04:31:50 -0400
From: antonio.menezes.leitao@gmail.com
To: bugs@racket-lang.org
Subject: Bug in typed racket

>Number:         15144
>Category:       typed-scheme
>Synopsis:       Bug in typed racket
>Class:          sw-bug
>Responsible:    samth
>Severity:       serious
>Priority:       medium
>State:          closed
>Confidential:   no
>Arrival-Date:   Fri Sep 04 04:32:02 -0400 2015
>Closed-Date:    Wed May 11 15:43:15 -0400 2016
>Last-Modified:  Wed May 11 15:43:15 -0400 2016
>Originator:     António Menezes Leitão
>Organization:
plt
>Submitter-Id:   unknown
>Release:        6.2.900.10--2015-08-15(faa1028/a)
>Environment:
windows "Windows NT 6.1 (Build 7601) Service Pack 1" (win32\x86_64\3m) (get-display-depth) = 32
Human Language: english
(current-memory-use) 2598285884
raco pkg (show):
Installation-wide:
 Package            Checksum     Source
 main-distribution  8c5ab8be...  catalog main-distribution
 racket-lib         854608c3...  catalog racket-lib
 [198 auto-installed packages not shown]
User-specific for installation "snapshot":
 Package    Checksum     Source
 c          68909b6a...  catalog c
 c-utils    64d32016...  catalog c-utils
 describe   e6d9f045...  catalog describe
 get-bonus  ea77c5b2...  catalog get-bonus
 p2r        238571a6...  url git://github.com/hfcorreia/p2r
 pict3d     56e3cb40...  catalog pict3d git://github.com/ntoronto/pict3d
 python     6ebc00e5...  url git://github.com/pedropramos/PyonR
 [5 auto-installed packages not shown]



Collections:
("C:\\Users\\aml\\AppData\\Roaming\\Racket\\snapshot\\collects"
 ("ANIMATIONlIX.rkt" "Students" "Tests" "acad.err" "allianz.bak" "allianz.rkt" "allianzLixo.bak" "allianzLixo.rkt" "attractor (ubuntu's conflicted copy 2014-12-22).rkt" "attractor.bak" "attractor.rkt" "bricks.1" "bricks.2" "bricks.bak" "bricks.rkt" "chust-protobuf" "com.bak" "com.rkt" "com.rkt~" "compiled" "cube-spheres.bak" "cube-spheres.py" "cube-spheres2.1" "cube-spheres2.bak" "cube-spheres2.py" "dubai-towers.1" "dubai-towers.2" "dubai-towers.4" "dubai-towers.bak" "dubai-towers.rkt" "dubaiTowers.dwt" "ecaade.1" "ecaade.bak" "ecaade.rkt" "ecaade.rkt~" "ecaade14.bak" "ecaade14.rkt" "exemplos.bak" "exemplos.rkt" "exemplos.rkt~" "holes.bak" "holes.rkt" "ines.bak" "ines.rkt" "ines2.rkt" "info-domain" "laser.bak" "laser.rkt" "laser.rkt~" "lisboa.bak" "lisboa.rkt" "livro (P170SM's conflicted copy 2014-05-10 (1)).rkt" "livro (P170SM's conflicted copy 2014-05-10).bak" "livro (P170SM's conflicted copy 2014-05-10).rkt" "livro.2" "livro.bak" "livro.rkt" "livro.rkt~" "livro5.2.bak" "l!
 ivro5.2.rkt" "livro5.2.rkt~" "log.txt" "ordem-superior.rkt" "ourico.bak" "ourico.rkt" "planet.bak" "planet.rkt" "print-screen" "protobuf" "protobuf-test.rkt" "protobuf~" "r6rs-protobuf-0.7" "racket-visualizer" "random-blocks.rkt" "render.bak" "render.rkt" "ricardo.rkt" "ricardo.rkt~" "rita.bak" "rita.rkt" "rita.rkt~" "rodrigo.bak" "rodrigo.rkt" "rodrigo.rkt~" "ros-base.bak" "ros-base.rkt" "ros-new.rkt" "ros-tests.bak" "ros-tests.rkt" "ros.bak" "ros.rkt" "rosetta" "rosetta.plt" "row-new.rkt" "saraGarcia.bak" "saraGarcia.rkt" "saraGarcia2.rkt" "sofia.bak" "sofia.rkt" "subdivide.rkt" "superellipsoid.rkt" "test-render.bak" "test-render.rkt" "test.bak" "test.png" "test.rkt" "test2.rkt" "testPython.bak" "testPython.py" "tests-sliders.bak" "tests-sliders.rkt" "tests-sliders.rkt~" "tests.bak" "tests.rkt" "tests.rkt~" "tiny-ros-base.rkt" "tiny-ros.bak" "tiny-ros.rkt" "tiny-ros2.rkt" "truss-radius.bak" "truss-radius.rkt" "truss-radius.rkt~" "truss.2" "truss.bak" "truss.rkt" "truss.rk!
 t~" "trussPython.1" "trussPython.bak" "trussPython.py" "trussP!
 ython.py.rkt" "trussPython.py~" "typed-rosetta" "typed-tiny-ros.bak" "typed-tiny-ros.rkt" "typed-truss.bak" "typed-truss.rkt" "visualizer" "vortices.rkt" "xyz.bak" "xyz.py"))
("C:\\Program Files\\Racket-6.2.900.10\\collects"
 (".gitignore" "acks" "compiler" "data" "db" "dynext" "ffi" "file" "info" "info-domain" "json" "launcher" "net" "openssl" "pkg" "planet" "racket" "rackunit" "raco" "reader" "realm" "s-exp" "scheme" "setup" "srfi" "syntax" "unstable" "version" "xml"))

Recent Internal Errors: 
Computer Language: (("Determine language from source") (#(#t print mixed-fraction-e #f #t debug) (default) #() "#lang racket\n" #t #t ((test) (main)) #t))
>Description:
Typed Racket triggers an error that prevents correct code from executing
..\..\..\..\..\..\..\..\Program Files\Racket-6.2.900.10\share\pkgs\typed-racket-lib\typed-racket\static-contracts\optimize.rkt:155:2: free-id-table-ref: no mapping for #<syntax n*11>
>How-To-Repeat:
Check Syntax or Run the following program

#lang typed/racket

(define-type (Base-Shape R)
  (U (foo-shape R)
     (bar-shape R)))

(define-syntax (def-base-shape stx)
  (syntax-case stx ()
    [(_ (R (func-name shape-name) [param-name : param-type] ...))
     (syntax/loc stx
       (begin
         (struct (R) shape-name ([param-name : param-type] ...))
         (define #:forall (R) (func-name [param-name : param-type] ...)
           (shape-name param-name ...))))]))

(def-base-shape (R (foo-func foo-shape) [s : (Base-Shape R)]))
(def-base-shape (R (bar-func bar-shape) [s : R]))

(provide foo)
(define (foo [shapes : (Base-Shape String)])
  (foo-func shapes))

(provide bar)
(define (bar [shapes : (Base-Shape String)])
  (bar-func shapes))

The bug goes away when we remove the final provide.
>Fix:
>Audit-Trail:
State changed from "open" to "closed" by asumu at Wed, 11 May 2016 15:43:15 -0400
Reason>>> Appears to have been fixed, not reproducible in Racket v6.5.0.4.

